<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Mask RCNN分割案例2 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-expandable-chapters/expandable-chapters.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-katex/katex.min.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    
    <link rel="prev" href="../imageSegmentation/section7.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="6.6"
        data-chapter-title="Mask RCNN分割案例2"
        data-filepath="imageSegmentation/section8.md"
        data-basepath=".."
        data-revision="Sun Oct 11 2020 09:58:20 GMT+0800 (中国标准时间)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        计算机视觉与深度学习课程
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="introduction/index.html">
            
                
                    <a href="../introduction/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        计算机视觉简介
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="introduction/section1.html">
            
                
                    <a href="../introduction/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        计算机视觉概念
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="introduction/section2.html">
            
                
                    <a href="../introduction/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        计算机视觉任务
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="tensorFlow/index.html">
            
                
                    <a href="../tensorFlow/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        tensorflow入门
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="tensorFlow/section1.html">
            
                
                    <a href="../tensorFlow/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        TensorFlow和Keras简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="tensorFlow/section2.html">
            
                
                    <a href="../tensorFlow/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        快速入门模型
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="deeplearning/index.html">
            
                
                    <a href="../deeplearning/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        深度神经网络
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="deeplearning/section1.html">
            
                
                    <a href="../deeplearning/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        神经网络简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="deeplearning/section2.html">
            
                
                    <a href="../deeplearning/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        常见的损失函数
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="deeplearning/section3.html">
            
                
                    <a href="../deeplearning/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        深度学习的优化方法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="deeplearning/section4.html">
            
                
                    <a href="../deeplearning/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        深度学习的正则化
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="deeplearning/section5.html">
            
                
                    <a href="../deeplearning/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        神经网络案例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="deeplearning/section6.html">
            
                
                    <a href="../deeplearning/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                        卷积神经网络CNN
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="imageClassification/index.html">
            
                
                    <a href="../imageClassification/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        图像分类
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="imageClassification/section1.html">
            
                
                    <a href="../imageClassification/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        图像分类简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="imageClassification/section2.html">
            
                
                    <a href="../imageClassification/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        AlexNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="imageClassification/section3.html">
            
                
                    <a href="../imageClassification/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                        VGG
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="imageClassification/section4.html">
            
                
                    <a href="../imageClassification/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                        GoogLeNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="imageClassification/section5.html">
            
                
                    <a href="../imageClassification/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                        ResNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="imageClassification/section6.html">
            
                
                    <a href="../imageClassification/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.6.</b>
                        
                        图像增强方法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="imageClassification/section7.html">
            
                
                    <a href="../imageClassification/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.7.</b>
                        
                        模型微调
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="objectdection/index.html">
            
                
                    <a href="../objectdection/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        目标检测(Object Detection)
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="objectdection/section1.html">
            
                
                    <a href="../objectdection/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        目标检测概述
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="objectdection/section2.html">
            
                
                    <a href="../objectdection/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="objectdection/section3.html">
            
                
                    <a href="../objectdection/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                        SPPNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="objectdection/section4.html">
            
                
                    <a href="../objectdection/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                        Fast R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="objectdection/section5.html">
            
                
                    <a href="../objectdection/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.5.</b>
                        
                        Faster R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="objectdection/section6.html">
            
                
                    <a href="../objectdection/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.6.</b>
                        
                        Faster RCNN接口分析
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="objectdection/section7.html">
            
                
                    <a href="../objectdection/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.7.</b>
                        
                        YOLO算法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="objectdection/section8.html">
            
                
                    <a href="../objectdection/section8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.8.</b>
                        
                        YOLOV2&amp;V3
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="objectdection/section9.html">
            
                
                    <a href="../objectdection/section9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.9.</b>
                        
                        SSD算法原理
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.10" data-path="objectdection/section10.html">
            
                
                    <a href="../objectdection/section10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.10.</b>
                        
                        案例：KITTI人、车检测案例-数据集处理
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.11" data-path="objectdection/section11.html">
            
                
                    <a href="../objectdection/section11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.11.</b>
                        
                        案例：KITTI人、车检测案例-训练、检测
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="imageSegmentation/index.html">
            
                
                    <a href="../imageSegmentation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        目标分割(Object Segmentation)
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="imageSegmentation/section1.html">
            
                
                    <a href="../imageSegmentation/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                        目标分割介绍
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="imageSegmentation/section2.html">
            
                
                    <a href="../imageSegmentation/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.2.</b>
                        
                        FCN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="imageSegmentation/section3.html">
            
                
                    <a href="../imageSegmentation/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.3.</b>
                        
                        SegNet与U-Net
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="imageSegmentation/section6.html">
            
                
                    <a href="../imageSegmentation/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.4.</b>
                        
                        Mask RCNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="imageSegmentation/section7.html">
            
                
                    <a href="../imageSegmentation/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.5.</b>
                        
                        Mask RCNN分割案例1
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="6.6" data-path="imageSegmentation/section8.html">
            
                
                    <a href="../imageSegmentation/section8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.6.</b>
                        
                        Mask RCNN分割案例2
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="69-mask-rcnn&#x5206;&#x5272;&#x6848;&#x4F8B;2">6.9 Mask RCNN&#x5206;&#x5272;&#x6848;&#x4F8B;2</h1>
<h3 id="&#x5B66;&#x4E60;&#x76EE;&#x6807;">&#x5B66;&#x4E60;&#x76EE;&#x6807;</h3>
<ul>
<li>&#x76EE;&#x6807;<ul>
<li>&#x77E5;&#x9053;maskrcnn&#x4E2D;&#x7684;&#x6E90;&#x7801;&#x7F16;&#x8BD1;&#x8BAD;&#x7EC3;&#x6D41;&#x7A0B;</li>
<li>&#x77E5;&#x9053;maskrcnn&#x4E2D;&#x7684;anchor&#x8BBE;&#x7F6E;&#x4EE5;&#x53CA;&#x8BA1;&#x7B97;</li>
<li>&#x638C;&#x63E1;&#x6A21;&#x578B;&#x7684;&#x8BAD;&#x7EC3;&#x9884;&#x6D4B;&#x6D41;&#x7A0B;</li>
</ul>
</li>
<li>&#x5E94;&#x7528;<ul>
<li>&#x5E94;&#x7528;&#x5B8C;&#x6210;maskrcnn&#x6307;&#x5B9A;&#x6C14;&#x7403;&#x5206;&#x5272;&#x6570;&#x636E;&#x96C6;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;</li>
<li>&#x5E94;&#x7528;&#x5B8C;&#x6210;maskrcnn&#x6307;&#x5B9A;&#x56FE;&#x7247;&#x6216;&#x89C6;&#x9891;&#x9884;&#x6D4B;&#x8F93;&#x51FA;</li>
</ul>
</li>
</ul>
<h3 id="691-&#x9879;&#x76EE;&#x6B65;&#x9AA4;">6.9.1 &#x9879;&#x76EE;&#x6B65;&#x9AA4;</h3>
<p>&#x6B65;&#x9AA4;</p>
<ul>
<li>1&#x3001;&#x6570;&#x636E;&#x96C6;&#x8BFB;&#x53D6;&#x5904;&#x7406;&#x548C;&#x51C6;&#x5907;<ul>
<li>&#x5B9E;&#x73B0;&#x6570;&#x636E;&#x6807;&#x7B7E;&#x6587;&#x4EF6;&#x7684;&#x8BFB;&#x53D6;</li>
</ul>
</li>
<li>2&#x3001;&#x6A21;&#x578B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x89E3;&#x6790;&#x4E0E;&#x4FEE;&#x6539;&#x3001;&#x6A21;&#x578B;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x3001;&#x6A21;&#x578B;&#x6784;&#x5EFA;<ul>
<li>maskrcnn&#x6A21;&#x578B;&#x6E90;&#x7801;&#x4E2D;Sequence&#x5C01;&#x88C5;&#x6570;&#x636E;&#x96C6;&#x7C7B;&#x4F7F;&#x7528;</li>
<li>maskrcnn&#x914D;&#x7F6E;&#x4ECB;&#x7ECD;</li>
<li>&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x8FC7;&#x7A0B;&#x4F7F;&#x7528;&#x6E90;&#x7801;&#x89E3;&#x6790;</li>
</ul>
</li>
<li>3&#x3001;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;<ul>
<li>&#x8BAD;&#x7EC3;&#x4EE3;&#x7801;&#x5C01;&#x88C5;&#x4ECB;&#x7ECD;</li>
</ul>
</li>
<li>4&#x3001;&#x6A21;&#x578B;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;<ul>
<li>&#x56FE;&#x7247;&#x9884;&#x6D4B;&#x7ED3;&#x679C;&#x5904;&#x7406;</li>
</ul>
</li>
</ul>
<h4 id="6911-&#x6A21;&#x578B;&#x5206;&#x6790;&#x4EE5;&#x53CA;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;&#x6D41;&#x7A0B;&#x5B9E;&#x73B0;">6.9.1.1 &#x6A21;&#x578B;&#x5206;&#x6790;&#x4EE5;&#x53CA;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;&#x6D41;&#x7A0B;&#x5B9E;&#x73B0;</h4>
<ul>
<li>&#x6B65;&#x9AA4;&#x5206;&#x6790;<ul>
<li>1&#x3001;&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x5224;&#x65AD;</li>
<li>2&#x3001;&#x914D;&#x7F6E;&#x6A21;&#x578B;&#x7684;&#x53C2;&#x6570;&#x3001;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8BAD;&#x7EC3;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;</li>
<li>3&#x3001;&#x521B;&#x5EFA;&#x6A21;&#x578B;</li>
<li>4&#x3001;&#x8BAD;&#x7EC3;&#x6D4B;&#x8BD5;&#x903B;&#x8F91;&#x5B9E;&#x73B0;</li>
</ul>
</li>
</ul>
<p>&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;</p>
<pre><code class="lang-python">args = parser.parse_args()

    <span class="hljs-comment"># 1&#x3001;&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x5224;&#x65AD;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        <span class="hljs-keyword">assert</span> args.dataset, <span class="hljs-string">&quot;&#x6307;&#x5B9A;&#x8BAD;&#x7EC3;&#x7684;&#x65F6;&#x5019;&#x5FC5;&#x987B;&#x4F20;&#x5165; --dataset&#x6570;&#x636E;&#x76EE;&#x5F55;&quot;</span>
    <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">&quot;test&quot;</span>:
        <span class="hljs-keyword">assert</span> args.image <span class="hljs-keyword">or</span> args.video,\
               <span class="hljs-string">&quot;&#x6307;&#x5B9A;&#x6D4B;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;&#x56FE;&#x7247;&#x6216;&#x8005;&#x89C6;&#x9891;&quot;</span>

    <span class="hljs-comment"># 2&#x3001;&#x914D;&#x7F6E;&#x6A21;&#x578B;&#x7684;&#x53C2;&#x6570;&#x3001;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8BAD;&#x7EC3;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        config = BalloonConfig()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># &#x6D4B;&#x8BD5;&#x7684;&#x914D;&#x7F6E;&#x4FEE;&#x6539;&#xFF1A;&#x8BBE;&#x7F6E;batch_size&#x4E3A;1&#xFF0C;Batch size = GPU_COUNT * IMAGES_PER_GPU</span>
        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InferenceConfig</span><span class="hljs-params">(BalloonConfig)</span>:</span>
            GPU_COUNT = <span class="hljs-number">1</span>
            IMAGES_PER_GPU = <span class="hljs-number">1</span>
        config = InferenceConfig()
    config.display()

    <span class="hljs-comment"># 3&#x3001;&#x521B;&#x5EFA;&#x6A21;&#x578B;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;training&quot;</span>, config=config,
                                  model_dir=args.logs)
    <span class="hljs-keyword">else</span>:
        model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;inference&quot;</span>, config=config,
                                  model_dir=args.logs)
    <span class="hljs-comment"># 4&#x3001;&#x8BAD;&#x7EC3;&#x6D4B;&#x8BD5;&#x903B;&#x8F91;&#x5B9E;&#x73B0;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        <span class="hljs-comment"># &#x9009;&#x62E9;&#x52A0;&#x8F7D;&#x7684;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x7C7B;&#x522B;&#x5E76;&#x4E0B;&#x8F7D;</span>
        <span class="hljs-keyword">if</span> args.weights.lower() == <span class="hljs-string">&quot;imagenet&quot;</span>:
            weights_path = model.get_imagenet_weights()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;&#x63D0;&#x4F9B;&#x4E00;&#x79CD;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x79CD;&#x7C7B;&quot;</span>)

        <span class="hljs-comment"># &#x52A0;&#x8F7D;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x6743;&#x91CD;</span>
        print(<span class="hljs-string">&quot;Loading weights &quot;</span>, weights_path)
        model.load_weights(weights_path, by_name=<span class="hljs-keyword">True</span>)

        <span class="hljs-comment"># &#x8FDB;&#x884C;&#x8BAD;&#x7EC3;</span>
        train(model)

    <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">&quot;test&quot;</span>:
        model.load_weights(args.model, by_name=<span class="hljs-keyword">True</span>)
        <span class="hljs-comment"># &#x8FDB;&#x884C;&#x68C0;&#x6D4B;</span>
        detect_and_draw_segmentation(args, model)
    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">&quot;&apos;{}&apos; &#x4F20;&#x5165;&#x53C2;&#x6570;&#x65E0;&#x6CD5;&#x8BC6;&#x522B;. &quot;</span>
              <span class="hljs-string">&quot;&#x8BF7;&#x4F7F;&#x7528; &apos;train&apos; or &apos;test&apos;&quot;</span>.format(args.command))
</code></pre>
<h4 id="6912-&#x6A21;&#x578B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;">6.9.1.2 &#x6A21;&#x578B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</h4>
<p><img src="../images/maskrcnn&#x6A21;&#x578B;&#x6587;&#x4EF6;.jpg" style="zoom:90%;"></p>
<ul>
<li>&#x5176;&#x4E2D;config.py&#x662F;&#x6A21;&#x578B;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x9700;&#x6C42;&#x8BAD;&#x7EC3;&#x7684;&#x9700;&#x6C42;&#x8FDB;&#x884C;&#x4FEE;&#x6539;<ul>
<li>maskrcnn&#x53C2;&#x6570;&#x7B49;&#x8BBE;&#x7F6E;&#x4F17;&#x591A;&#xFF0C;&#x901A;&#x5E38;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x914D;&#x7F6E;&#x66F4;&#x597D;</li>
<li>&#x5176;&#x4E2D;&#x67D0;&#x4E9B;&#x91CD;&#x8981;&#x7684;&#x914D;&#x7F6E;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x4ECB;&#x7ECD;<ul>
<li>1&#x3001;&#x8BAD;&#x7EC3;&#x53C2;&#x6570;&#x914D;&#x7F6E;</li>
<li>2&#x3001;&#x6D4B;&#x8BD5;&#x53C2;&#x6570;&#x914D;&#x7F6E;</li>
<li>3&#x3001;&#x5B66;&#x4E60;&#x7387;&#x76F8;&#x5173;&#x8BBE;&#x7F6E;</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;Base configuration class. For custom configurations, create a
    sub-class that inherits from this one and override properties
    that need to be changed.
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1&#x3001;&#x8BAD;&#x7EC3;&#x914D;&#x7F6E;</span>
    <span class="hljs-comment"># NUMBER OF GPUs to use. When using only a CPU, this needs to be set to 1.</span>
    <span class="hljs-comment"># &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x5927;&#x4E8E;1&#xFF0C;&#x591A;&#x4E2A;GPU&#x8FDB;&#x884C;&#x5E76;&#x884C;&#x8FD0;&#x7B97;&#xFF0C;&#x6E90;&#x7801;&#x4E2D;parallel_model.py&#x4F7F;&#x7528;1.xAPI&#x8FDB;&#x884C;&#x591A;GPU&#x8BA1;&#x7B97;</span>
    GPU_COUNT = <span class="hljs-number">1</span>
    <span class="hljs-comment"># &#x6BCF;&#x4E2A;GPU&#x8BAD;&#x7EC3;&#x7684;&#x56FE;&#x7247;&#x6570;&#x91CF; </span>
    <span class="hljs-comment"># A 12GB GPU can typically handle 2 images of 1024x1024px.</span>
    <span class="hljs-comment"># Adjust based on your GPU memory and image sizes. Use the highest</span>
    <span class="hljs-comment"># number that your GPU can handle for best performance.</span>
    IMAGES_PER_GPU = <span class="hljs-number">2</span>
    <span class="hljs-comment"># &#x4E00;&#x4E2A;epoch&#x7684;&#x8BAD;&#x7EC3;&#x6B65;&#x6570;</span>
    <span class="hljs-comment"># This doesn&apos;t need to match the size of the training set. Tensorboard</span>
    <span class="hljs-comment"># updates are saved at the end of each epoch, so setting this to a</span>
    <span class="hljs-comment"># smaller number means getting more frequent TensorBoard updates.</span>
    <span class="hljs-comment"># Validation stats are also calculated at each epoch end and they</span>
    <span class="hljs-comment"># might take a while, so don&apos;t set this too small to avoid spending</span>
    <span class="hljs-comment"># a lot of time on validation stats.</span>
    STEPS_PER_EPOCH = <span class="hljs-number">1000</span>
    <span class="hljs-comment"># Number of validation steps to run at the end of every training epoch.</span>
    <span class="hljs-comment"># A bigger number improves accuracy of validation stats, but slows</span>
    <span class="hljs-comment"># down the training.</span>
    VALIDATION_STEPS = <span class="hljs-number">50</span>
    <span class="hljs-comment"># &#x4E3B;&#x7F51;&#x7EDC;&#x67B6;&#x6784;</span>
    <span class="hljs-comment"># Supported values are: resnet50, resnet101.</span>
    <span class="hljs-comment"># You can also provide a callable that should have the signature</span>
    <span class="hljs-comment"># of model.resnet_graph. If you do so, you need to supply a callable</span>
    <span class="hljs-comment"># to COMPUTE_BACKBONE_SHAPE as well</span>
    BACKBONE = <span class="hljs-string">&quot;resnet101&quot;</span>
    <span class="hljs-comment"># &#x57FA;&#x4E8E;resnet101&#x67B6;&#x6784;&#x7684;&#x56FE;&#x50CF;&#x91D1;&#x5B57;&#x5854;FPN&#x5230;&#x8FBE;&#x7684;&#x6BCF;&#x5C42; &#x6B65;&#x957F;</span>
    BACKBONE_STRIDES = [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>]
    <span class="hljs-comment"># Size of the fully-connected layers in the classification graph</span>
    FPN_CLASSIF_FC_LAYERS_SIZE = <span class="hljs-number">1024</span>
    <span class="hljs-comment"># Size of the top-down layers used to build the feature pyramid</span>
    TOP_DOWN_PYRAMID_SIZE = <span class="hljs-number">256</span>
    <span class="hljs-comment"># &#x603B;&#x7C7B;&#x522B;&#x4E2A;&#x6570; (including background)</span>
    NUM_CLASSES = <span class="hljs-number">1</span>  <span class="hljs-comment"># Override in sub-classes</span>
    <span class="hljs-comment"># RPN anchor&#x7684;&#x9762;&#x79EF;&#x6839;&#x53F7;&#x8BBE;&#x7F6E;</span>
    RPN_ANCHOR_SCALES = (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">512</span>)
    <span class="hljs-comment"># anchor&#x7684;&#x6BD4;&#x7387;&#x7528;&#x4E8E;&#x8BBE;&#x7F6E;&#x957F;&#x5BBD; (width/height)</span>
    <span class="hljs-comment"># A value of 1 represents a square anchor, and 0.5 is a wide anchor</span>
    RPN_ANCHOR_RATIOS = [<span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
    <span class="hljs-comment"># Anchor &#x8BBE;&#x7F6E;&#x6B65;&#x957F;&#xFF0C;&#x5982;&#x679C;&#x4E3A;2&#x8DF3;&#x8FC7;&#x4E00;&#x4E9B;&#x7279;&#x5F81;&#x5C42;&#x8BBE;&#x7F6E;anchor</span>
    <span class="hljs-comment"># If 1 then anchors are created for each cell in the backbone feature map.</span>
    <span class="hljs-comment"># If 2, then anchors are created for every other cell, and so on.</span>
    RPN_ANCHOR_STRIDE = <span class="hljs-number">1</span>
    <span class="hljs-comment"># &#x8FC7;&#x6EE4;RPN proposals&#x7684;NMS&#x9608;&#x503C;&#xFF0C;&#x503C;&#x8D8A;&#x5927;&#x4EA7;&#x751F;&#x66F4;&#x591A;&#x7684;&#x5EFA;&#x8BAE;&#x6846;</span>
    <span class="hljs-comment"># You can increase this during training to generate more propsals.</span>
    RPN_NMS_THRESHOLD = <span class="hljs-number">0.7</span>
    <span class="hljs-comment"># &#x6BCF;&#x5F20;&#x56FE;&#x4EA7;&#x751F;&#x591A;&#x5C11;anchors&#x7528;&#x4E8E;RPN training</span>
    RPN_TRAIN_ANCHORS_PER_IMAGE = <span class="hljs-number">256</span>
    <span class="hljs-comment"># &#x7ECF;&#x8FC7;tf.nn.top_k&#x7B5B;&#x9009;&#x4E4B;&#x540E;&#x5E76;&#x4E14;&#x5728; non-maximum suppression&#x8FDB;&#x884C;&#x4E4B;&#x524D;&#x7684;ROIs &#x6570;&#x91CF;</span>
    PRE_NMS_LIMIT = <span class="hljs-number">6000</span>
    <span class="hljs-comment"># &#x5728;non-maximum suppression ROIs &#x7684;&#x6570;&#x91CF;(training and inference)</span>
    POST_NMS_ROIS_TRAINING = <span class="hljs-number">2000</span>
    POST_NMS_ROIS_INFERENCE = <span class="hljs-number">1000</span>
    <span class="hljs-comment"># Input image resizing&#xFF0C;&#x9ED8;&#x8BA4;square&#x6A21;&#x5F0F;&#xFF0C;&#x8BBE;&#x7F6E;&#x6210;[max_dim, max_dim]</span>
    <span class="hljs-comment"># square: Resize and pad with zeros to get a square image</span>
    <span class="hljs-comment">#         of size [max_dim, max_dim].</span>
    IMAGE_RESIZE_MODE = <span class="hljs-string">&quot;square&quot;</span>
    IMAGE_MIN_DIM = <span class="hljs-number">800</span>
    IMAGE_MAX_DIM = <span class="hljs-number">1024</span>
    <span class="hljs-comment"># &#x6BCF;&#x4E2A;image&#x63D0;&#x4F9B;&#x7ED9;classifier/mask heads&#x4E2D;&#x7684;rois&#x6570;&#x91CF;</span>
    <span class="hljs-comment"># The Mask RCNN paper uses 512 but often the RPN doesn&apos;t generate</span>
    <span class="hljs-comment"># enough positive proposals to fill this and keep a positive:negative</span>
    <span class="hljs-comment"># ratio of 1:3. You can increase the number of proposals by adjusting</span>
    <span class="hljs-comment"># the RPN NMS threshold.</span>
    TRAIN_ROIS_PER_IMAGE = <span class="hljs-number">200</span>
    <span class="hljs-comment"># ROIs &#x7528;&#x4E8E;&#x8BAD;&#x7EC3; classifier/mask heads&#x7684;&#x6B63;&#x6837;&#x672C;&#x6BD4;&#x7387;</span>
    ROI_POSITIVE_RATIO = <span class="hljs-number">0.33</span>
    <span class="hljs-comment"># ROIs&#x6C60;&#x5316;&#x5C42;&#x5927;&#x5C0F;</span>
    POOL_SIZE = <span class="hljs-number">7</span>
    MASK_POOL_SIZE = <span class="hljs-number">14</span>
    <span class="hljs-comment"># &#x8F93;&#x51FA;mask&#x7684;&#x5927;&#x5C0F;</span>
    <span class="hljs-comment"># To change this you also need to change the neural network mask branch</span>
    MASK_SHAPE = [<span class="hljs-number">28</span>, <span class="hljs-number">28</span>]
    <span class="hljs-comment"># &#x6BCF;&#x5F20;&#x56FE;&#x7684;GT&#x5B9E;&#x4F8B;&#x6570;&#x91CF;&#x7684;&#x6700;&#x5927;&#x503C;</span>
    MAX_GT_INSTANCES = <span class="hljs-number">100</span>

    <span class="hljs-comment"># 2&#x3001;&#x68C0;&#x6D4B;&#x7684;&#x914D;&#x7F6E;</span>
    <span class="hljs-comment"># &#x6700;&#x540E;&#x6D4B;&#x8BD5;&#x68C0;&#x6D4B;&#x7684;&#x65F6;&#x5019;&#x5B9E;&#x4F8B;&#x6570;&#x91CF;100</span>
    DETECTION_MAX_INSTANCES = <span class="hljs-number">100</span>
    <span class="hljs-comment"># Minimum probability value to accept a detected instance</span>
    <span class="hljs-comment"># ROIs below this threshold are skipped</span>
    DETECTION_MIN_CONFIDENCE = <span class="hljs-number">0.7</span>
    <span class="hljs-comment"># &#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x7684;Non-maximum suppression&#x9608;&#x503C;</span>
    DETECTION_NMS_THRESHOLD = <span class="hljs-number">0.3</span>

    <span class="hljs-comment"># 3&#x3001;&#x5B66;&#x4E60;&#x7387;&#x8BBE;&#x7F6E;&#x76F8;&#x5173;&#x8BBE;&#x7F6E;</span>
    <span class="hljs-comment"># The Mask RCNN paper uses lr=0.02, but on TensorFlow it causes</span>
    <span class="hljs-comment"># weights to explode. Likely due to differences in optimizer</span>
    <span class="hljs-comment"># implementation.</span>
    LEARNING_RATE = <span class="hljs-number">0.001</span>
    LEARNING_MOMENTUM = <span class="hljs-number">0.9</span>
    <span class="hljs-comment"># Weight decay regularization</span>
    WEIGHT_DECAY = <span class="hljs-number">0.0001</span>
    <span class="hljs-comment"># &#x635F;&#x5931;&#x8BA1;&#x7B97;&#x516C;&#x5F0F;&#x5206;&#x914D;&#x6743;&#x91CD;</span>
    <span class="hljs-comment"># Loss weights for more precise optimization.</span>
    <span class="hljs-comment"># Can be used for R-CNN training setup.</span>
    LOSS_WEIGHTS = {
        <span class="hljs-string">&quot;rpn_class_loss&quot;</span>: <span class="hljs-number">1.</span>,
        <span class="hljs-string">&quot;rpn_bbox_loss&quot;</span>: <span class="hljs-number">1.</span>,
        <span class="hljs-string">&quot;mrcnn_class_loss&quot;</span>: <span class="hljs-number">1.</span>,
        <span class="hljs-string">&quot;mrcnn_bbox_loss&quot;</span>: <span class="hljs-number">1.</span>,
        <span class="hljs-string">&quot;mrcnn_mask_loss&quot;</span>: <span class="hljs-number">1.</span>
    }
    <span class="hljs-comment"># &#x68AF;&#x5EA6;&#x622A;&#x65AD;&#x503C;</span>
    GRADIENT_CLIP_NORM = <span class="hljs-number">5.0</span>
</code></pre>
<p>&#x5176;&#x4E2D;&#x6709;&#x914D;&#x7F6E;&#x7684;&#x51E0;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;display&#x663E;&#x793A;&#x6A21;&#x578B;&#x7684;&#x5F53;&#x524D;&#x914D;&#x7F6E;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_dict</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-keyword">return</span> {a: getattr(self, a)
            <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> sorted(dir(self))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> a.startswith(<span class="hljs-string">&quot;__&quot;</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> callable(getattr(self, a))}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">display</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;Display Configuration values.&quot;&quot;&quot;</span>
    print(<span class="hljs-string">&quot;\nConfigurations:&quot;</span>)
    <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> self.to_dict().items():
        print(f<span class="hljs-string">&quot;{key:30} {val}&quot;</span>)
    print(<span class="hljs-string">&quot;\n&quot;</span>)
</code></pre>
<h4 id="6913-&#x6848;&#x4F8B;&#xFF1A;&#x6C14;&#x7403;&#x6570;&#x636E;&#x96C6;&#x914D;&#x7F6E;&#x4EE3;&#x7801;&#x7F16;&#x5199;">6.9.1.3 &#x6848;&#x4F8B;&#xFF1A;&#x6C14;&#x7403;&#x6570;&#x636E;&#x96C6;&#x914D;&#x7F6E;&#x4EE3;&#x7801;&#x7F16;&#x5199;</h4>
<p>&#x5728;balloon_dataset&#x4E2D;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x81EA;&#x5DF1;&#x6570;&#x636E;&#x96C6;&#x9700;&#x8981;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x4E0B;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> mrcnn.config <span class="hljs-keyword">import</span> Config
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BalloonConfig</span><span class="hljs-params">(Config)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;&#x7EE7;&#x627F;MaskRCNN&#x7684;&#x6A21;&#x578B;&#x914D;&#x7F6E;&#x4FE1;&#x606F;
    &#x4FEE;&#x6539;&#x5176;&#x4E2D;&#x9700;&#x8981;&#x7684;&#x8BAD;&#x7EC3;&#x96C6;&#x6570;&#x636E;&#x4FE1;&#x606F;
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># &#x7ED9;&#x914D;&#x7F6E;&#x4E00;&#x4E2A;&#x540D;&#x79F0;</span>
    NAME = <span class="hljs-string">&quot;balloon&quot;</span>

    IMAGES_PER_GPU = <span class="hljs-number">2</span>

    <span class="hljs-comment"># &#x7C7B;&#x522B;&#x6570;&#x91CF;&#xFF08;&#x5305;&#x62EC;&#x80CC;&#x666F;&#xFF09;&#xFF0C;&#x6C14;&#x7403;&#x7C7B;&#x522B;+1</span>
    NUM_CLASSES = <span class="hljs-number">1</span> + <span class="hljs-number">1</span>

    <span class="hljs-comment"># &#x4E00;&#x4E2A;epoch&#x7684;&#x6B65;&#x6570;</span>
    STEPS_PER_EPOCH = <span class="hljs-number">100</span>

    <span class="hljs-comment"># &#x68C0;&#x6D4B;&#x7684;&#x65F6;&#x5019;&#x8FC7;&#x6EE4;&#x7F6E;&#x4FE1;&#x5EA6;&#x7684;&#x9608;&#x503C;</span>
    DETECTION_MIN_CONFIDENCE = <span class="hljs-number">0.9</span>
</code></pre>
<p>&#x7136;&#x540E;&#x5728;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;balloon_main.py&#x4E2D;&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x83B7;&#x53D6;&#x914D;&#x7F6E;&#x7B49;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> utils.balloon_dataset <span class="hljs-keyword">import</span> BalloonDataset, BalloonConfig

  args = parser.parse_args()
<span class="hljs-comment"># 1&#x3001;&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x5224;&#x65AD;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        <span class="hljs-keyword">assert</span> args.dataset, <span class="hljs-string">&quot;&#x6307;&#x5B9A;&#x8BAD;&#x7EC3;&#x7684;&#x65F6;&#x5019;&#x5FC5;&#x987B;&#x4F20;&#x5165; --dataset&#x6570;&#x636E;&#x76EE;&#x5F55;&quot;</span>
    <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">&quot;test&quot;</span>:
        <span class="hljs-keyword">assert</span> args.image <span class="hljs-keyword">or</span> args.video,\
               <span class="hljs-string">&quot;&#x6307;&#x5B9A;&#x6D4B;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;&#x56FE;&#x7247;&#x6216;&#x8005;&#x89C6;&#x9891;&quot;</span>

    <span class="hljs-comment"># 2&#x3001;&#x914D;&#x7F6E;&#x6A21;&#x578B;&#x7684;&#x53C2;&#x6570;&#x3001;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8BAD;&#x7EC3;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;</span>
    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
        config = BalloonConfig()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># &#x6D4B;&#x8BD5;&#x7684;&#x914D;&#x7F6E;&#x4FEE;&#x6539;&#xFF1A;&#x8BBE;&#x7F6E;batch_size&#x4E3A;1&#xFF0C;Batch size = GPU_COUNT * IMAGES_PER_GPU</span>
        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InferenceConfig</span><span class="hljs-params">(BalloonConfig)</span>:</span>
            GPU_COUNT = <span class="hljs-number">1</span>
            IMAGES_PER_GPU = <span class="hljs-number">1</span>
        config = InferenceConfig()
    <span class="hljs-comment"># &#x663E;&#x793A;&#x914D;&#x7F6E;</span>
    config.display()
</code></pre>
<p>&#x5176;&#x4E2D;&#x521D;&#x59CB;&#x5BFC;&#x5165;&#x5305;&#x4EE5;&#x53CA;&#x8FD0;&#x884C;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> skimage.draw
<span class="hljs-keyword">import</span> argparse

<span class="hljs-keyword">from</span> mrcnn <span class="hljs-keyword">import</span> model <span class="hljs-keyword">as</span> maskrcnn
<span class="hljs-keyword">from</span> utils.balloon_dataset <span class="hljs-keyword">import</span> BalloonDataset, BalloonConfig
<span class="hljs-keyword">import</span> os
os.environ[<span class="hljs-string">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span>] = <span class="hljs-string">&quot;2&quot;</span>
<span class="hljs-comment"># &#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;</span>
parser = argparse.ArgumentParser(
    description=<span class="hljs-string">&apos;&#x6C14;&#x7403;&#x5206;&#x5272;&#x6A21;&#x578B;maskrcnn&#x8BAD;&#x7EC3;&apos;</span>)
parser.add_argument(<span class="hljs-string">&quot;--command&quot;</span>, type=str, default=<span class="hljs-string">&apos;test&apos;</span>,
                    help=<span class="hljs-string">&quot;&apos;train&apos; or &apos;test&apos; &#x8BAD;&#x7EC3;&#x8FD8;&#x662F;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&quot;</span>)
parser.add_argument(<span class="hljs-string">&apos;--dataset&apos;</span>, type=str, default=<span class="hljs-string">&apos;./balloon_data&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x6C14;&#x7403;&#x5206;&#x5272;&#x6570;&#x636E;&#x96C6;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--weights&apos;</span>, type=str, default=<span class="hljs-string">&apos;imagenet&apos;</span>,
                    help=<span class="hljs-string">&quot;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x6743;&#x91CD;&quot;</span>
                         <span class="hljs-string">&quot;imagenet:https://github.com/fchollet/&quot;</span>
                         <span class="hljs-string">&quot;deep-learning-models/releases/&quot;</span>
                         <span class="hljs-string">&quot;download/v0.2/resnet50_weights&quot;</span>
                         <span class="hljs-string">&quot;_tf_dim_ordering_tf_kernels_notop.h5&quot;</span>)
parser.add_argument(<span class="hljs-string">&apos;--logs&apos;</span>, type=str, default=<span class="hljs-string">&apos;./logs/&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--image&apos;</span>, type=str, default=<span class="hljs-string">&apos;./images/2917282960_06beee649a_b.jpg&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x5206;&#x5272;&#x7684;&#x56FE;&#x7247;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--video&apos;</span>, type=str, default=<span class="hljs-string">&apos;./images/v0200fd10000bq043q9pskdh7ri20vm0.MP4&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x5206;&#x5272;&#x7684;&#x89C6;&#x9891;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--model&apos;</span>, type=str, default=<span class="hljs-string">&apos;./logs/mask_rcnn_balloon.h5&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x6307;&#x5B9A;&#x6D4B;&#x8BD5;&#x4F7F;&#x7528;&#x7684;&#x8BAD;&#x7EC3;&#x597D;&#x7684;&#x6A21;&#x578B;&#x6587;&#x4EF6;&apos;</span>)
</code></pre>
<h4 id="6914-&#x6A21;&#x578B;&#x4F7F;&#x7528;&#x4ECB;&#x7ECD;">6.9.1.4 &#x6A21;&#x578B;&#x4F7F;&#x7528;&#x4ECB;&#x7ECD;</h4>
<p>&#x6A21;&#x578B;&#x4F7F;&#x7528;&#x6BD4;&#x8F83;&#x7B80;&#x7B54;&#xFF0C;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x5BFC;&#x5165;model&#x5373;&#x53EF;&#xFF0C;&#x4F7F;&#x7528;&#x7EC6;&#x8282;&#x5982;&#x4E0B;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> mrcnn <span class="hljs-keyword">import</span> model <span class="hljs-keyword">as</span> maskrcnn
<span class="hljs-comment"># 1&#x3001;&#x9009;&#x7528;&#x8BAD;&#x7EC3;&#x6A21;&#x5F0F;&#xFF0C;&#x52A0;&#x5165;&#x914D;&#x7F6E;&#x4EE5;&#x53CA;&#x6A21;&#x578B;&#x4FDD;&#x5B58;&#x76EE;&#x5F55;</span>
model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;training&quot;</span>, config=config,
                              model_dir=args.logs)
<span class="hljs-comment"># 2&#x3001;&#x9009;&#x7528;&#x6D4B;&#x8BD5;&#x63A8;&#x7406;&#x6A21;&#x5F0F;&#xFF0C;&#x52A0;&#x5165;&#x914D;&#x7F6E;&#x4EE5;&#x53CA;&#x6A21;&#x578B;&#x4FDD;&#x5B58;&#x76EE;&#x5F55;</span>
model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;inference&quot;</span>, config=config,
                              model_dir=args.logs)
</code></pre>
<p>&#x90A3;&#x4E48;&#x5176;&#x4E2D;MaskRCNN&#x7C7B;&#x63D0;&#x4F9B;&#x4E86;&#x5EFA;&#x7ACB;&#x6A21;&#x578B;&#x7684;&#x4E00;&#x5957;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E3B;&#x8981;&#x6E90;&#x4EE3;&#x7801;&#x8FC7;&#x7A0B;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ul>
<li>&#x6A21;&#x578B;&#x8FC7;&#x7A0B;&#xFF1A;<ul>
<li>&#x8F93;&#x5165;&#x6784;&#x5EFA;&#x3001;&#x6784;&#x5EFA;GT&#x3001;RPN&#x6A21;&#x578B;&#x642D;&#x5EFA;&#x8F93;&#x51FA;&#x3001;&#x901A;&#x8FC7;ProposalLayer&#xFF08;&#x6E90;&#x7801;&#x7C7B;&#xFF09;&#x4EA7;&#x751F;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;</li>
<li>&#x8BA1;&#x7B97;5&#x79CD;&#x635F;&#x5931;&#x3001;&#x6784;&#x5EFA;&#x6A21;&#x578B;&#x8F93;&#x5165;&#x8F93;&#x51FA;</li>
</ul>
</li>
</ul>
<h4 id="1&#x3001;&#x6A21;&#x578B;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x4E0E;&#x8BAD;&#x7EC3;&#x6E90;&#x7801;&#x987A;&#x5E8F;&#x5206;&#x6790;">1&#x3001;&#x6A21;&#x578B;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x4E0E;&#x8BAD;&#x7EC3;&#x6E90;&#x7801;&#x987A;&#x5E8F;&#x5206;&#x6790;</h4>
<p>&#x6A21;&#x578B;&#x5BF9;&#x4E8E;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x5C01;&#x88C5;&#x8F83;&#x6DF1;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x5BF9;&#x6E90;&#x7801;&#x505A;&#x51FA;&#x76F8;&#x5E94;&#x89E3;&#x91CA;&#xFF0C;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;&#x6709;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x51FD;&#x6570;</p>
<ul>
<li>self.train():&#x6A21;&#x578B;&#x7684;&#x8BAD;&#x7EC3;&#x903B;&#x8F91;<ul>
<li>1&#x3001;class DataGenerator(KU.Sequence):&#x6570;&#x636E;&#x51C6;&#x5907;&#x9636;&#x6BB5;&#x6784;&#x5EFA;generator<ul>
<li>&#x8BBE;&#x7F6E;RPN&#x8BAD;&#x7EC3;&#x76EE;&#x6807;&#x6846;</li>
</ul>
</li>
<li>2&#x3001;self.compile&#xFF1A;&#x6A21;&#x578B;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;<ul>
<li>&#x8BBE;&#x7F6E;&#x635F;&#x5931;&#x8BA1;&#x7B97;&#x3001;&#x6B63;&#x5219;&#x5316;&#x5316;</li>
</ul>
</li>
<li>3&#x3001;self.fit&#x8BAD;&#x7EC3;</li>
</ul>
</li>
</ul>
<p>&#x5728;&#x8BAD;&#x7EC3;&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8C03;&#x7528;maskcnn&#x4E2D;&#x7684;train&#x51FD;&#x6570;&#x5373;&#x53EF;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5BF9;<strong>&#x6E90;&#x4EE3;&#x7801;&#x4E2D;&#x7684;train&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5206;&#x6790;</strong>&#xFF1A;</p>
<ul>
<li>1&#x3001;def train(self, train_dataset, val_dataset, learning_rate, epochs, layers,<pre><code>          augmentation=None, custom_callbacks=None, no_augmentation_sources=None):
</code></pre><ul>
<li>train_dataset, val_dataset:&#x8BAD;&#x7EC3;&#x3001;&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;dataset&#x5BF9;&#x8C61;</li>
<li>learning_rate&#xFF1A;&#x5B66;&#x4E60;&#x7387;</li>
<li>epochs&#xFF1A;&#x8FED;&#x4EE3;&#x6B21;&#x6570;</li>
<li>layers:&#x9009;&#x62E9;&#x90A3;&#x4E9B;&#x5C42;&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;<ul>
<li>heads:RPN&#x3001;classifier&#x4EE5;&#x53CA;mask &#x7F51;&#x7EDC;&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;</li>
</ul>
</li>
<li>custom_callbacks=None&#xFF1A;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x8BAD;&#x7EC3;&#x56DE;&#x8C03;&#x51FD;&#x6570;</li>
</ul>
</li>
</ul>
<p>&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-comment"># 1&#x3001;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x5C42;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x6839;&#x636E;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;</span>
layer_regex = {
    <span class="hljs-comment"># all layers but the backbone</span>
    <span class="hljs-string">&quot;heads&quot;</span>: <span class="hljs-string">r&quot;(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)&quot;</span>,
    <span class="hljs-comment"># From a specific Resnet stage and up</span>
    <span class="hljs-string">&quot;3+&quot;</span>: <span class="hljs-string">r&quot;(res3.*)|(bn3.*)|(res4.*)|(bn4.*)|(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)&quot;</span>,
    <span class="hljs-string">&quot;4+&quot;</span>: <span class="hljs-string">r&quot;(res4.*)|(bn4.*)|(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)&quot;</span>,
    <span class="hljs-string">&quot;5+&quot;</span>: <span class="hljs-string">r&quot;(res5.*)|(bn5.*)|(mrcnn\_.*)|(rpn\_.*)|(fpn\_.*)&quot;</span>,
    <span class="hljs-comment"># All layers</span>
    <span class="hljs-string">&quot;all&quot;</span>: <span class="hljs-string">&quot;.*&quot;</span>,
}
<span class="hljs-keyword">if</span> layers <span class="hljs-keyword">in</span> layer_regex.keys():
    layers = layer_regex[layers]

<span class="hljs-comment"># 2&#x3001;Data&#x83B7;&#x53D6;&#xFF0C;model&#x4E2D;&#x5B9E;&#x73B0;&#x7684; DataGenerator &#x7C7B;&#x7EE7;&#x627F;keras.utils.Sequence</span>
train_generator = DataGenerator(train_dataset, self.config, shuffle=<span class="hljs-keyword">True</span>,
                                 augmentation=augmentation)
val_generator = DataGenerator(val_dataset, self.config, shuffle=<span class="hljs-keyword">True</span>)

<span class="hljs-comment"># Create log_dir if it does not exist</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.log_dir):
    os.makedirs(self.log_dir)

<span class="hljs-comment"># Callbacks</span>
callbacks = [
    keras.callbacks.TensorBoard(log_dir=self.log_dir,
                                histogram_freq=<span class="hljs-number">0</span>, write_graph=<span class="hljs-keyword">True</span>, write_images=<span class="hljs-keyword">False</span>),
    keras.callbacks.ModelCheckpoint(self.checkpoint_path,
                                    verbose=<span class="hljs-number">0</span>, save_weights_only=<span class="hljs-keyword">True</span>),
]

<span class="hljs-comment"># Add custom callbacks to the list</span>
<span class="hljs-keyword">if</span> custom_callbacks:
    callbacks += custom_callbacks

<span class="hljs-comment"># 4&#x3001;&#x8BAD;&#x7EC3;&#xFF0C;&#x6307;&#x5B9A;&#x8BAD;&#x7EC3;&#x7684;&#x5C42;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x7B49;</span>
log(<span class="hljs-string">&quot;\nStarting at epoch {}. LR={}\n&quot;</span>.format(self.epoch, learning_rate))
log(<span class="hljs-string">&quot;Checkpoint Path: {}&quot;</span>.format(self.checkpoint_path))
self.set_trainable(layers)
self.compile(learning_rate, self.config.LEARNING_MOMENTUM)

<span class="hljs-comment"># Work-around for Windows: Keras fails on Windows when using</span>
<span class="hljs-comment"># multiprocessing workers. See discussion here:</span>
<span class="hljs-comment"># https://github.com/matterport/Mask_RCNN/issues/13#issuecomment-353124009</span>
<span class="hljs-keyword">if</span> os.name == <span class="hljs-string">&apos;nt&apos;</span>:
    workers = <span class="hljs-number">0</span>
<span class="hljs-keyword">else</span>:
    workers = multiprocessing.cpu_count()

self.keras_model.fit(
    train_generator,
    initial_epoch=self.epoch,
    epochs=epochs,
    steps_per_epoch=self.config.STEPS_PER_EPOCH,
    callbacks=callbacks,
    validation_data=val_generator,
    validation_steps=self.config.VALIDATION_STEPS,
    max_queue_size=<span class="hljs-number">100</span>,
    workers=workers,
    use_multiprocessing=workers &gt; <span class="hljs-number">1</span>,
)
self.epoch = max(self.epoch, epochs)
</code></pre>
<ul>
<li><p>2&#x3001;class DataGenerator(KU.Sequence):</p>
<ul>
<li><p>&#x521D;&#x59CB;&#x5316;&#xFF1A;def <strong>init</strong>(self, dataset, config, shuffle=True, augmentation=None,random_rois=0, detection_targets=False):</p>
</li>
<li><p>&#x5BF9;&#x4E8E;&#x4F20;&#x5165;&#x7684;Dataset&#x5BF9;&#x8C61;&#x5EFA;&#x7ACB;&#x5E8F;&#x5217;&#x6570;&#x636E;&#xFF0C;&#x63D0;&#x4F9B;&#x6BCF;&#x6279;&#x6B21;&#x6570;&#x636E;&#x7ED9;&#x8BAD;&#x7EC3;&#x5668;</p>
</li>
<li><p>&#xFF08;1&#xFF09;&#x4E3B;&#x8981;&#x6839;&#x636E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4EA7;&#x751F;RPN&#x7F51;&#x7EDC;&#x76F8;&#x5E94;&#x7684;anchor&#x5148;&#x9A8C;&#x6846;&#x7684;&#x5750;&#x6807;&#xFF08;&#x540E;&#x9762;&#x4F1A;&#x8C03;&#x7528;&#x663E;&#x793A;&#xFF09;</p>
</li>
<li><pre><code class="lang-python">self.backbone_shapes = compute_backbone_shapes(config, config.IMAGE_SHAPE)
self.anchors = utils.generate_pyramid_anchors(config.RPN_ANCHOR_SCALES,
                                              config.RPN_ANCHOR_RATIOS,
                                              self.backbone_shapes,
                                              config.BACKBONE_STRIDES,
                                              config.RPN_ANCHOR_STRIDE)
</code></pre>
</li>
<li><p>&#xFF08;2&#xFF09;def <strong>getitem</strong>(self, idx):</p>
<ul>
<li>&#x4EA7;&#x751F;&#x7B2C;idx&#x6279;&#x6B21;&#x7684;&#x6570;&#x636E;&#x3002;</li>
</ul>
</li>
<li><p>return inputs, outputs&#x3002;&#x4E0B;&#x9762;&#x4E3A;&#x8FD4;&#x56DE;&#x7684;&#x4E24;&#x4E2A;&#x7ED3;&#x679C;&#x7684;&#x89E3;&#x6790;</p>
</li>
<li><p><strong>&#x6CE8;&#xFF1A;&#x7F51;&#x7EDC;&#x8BAD;&#x7EC3;&#x7684;&#x65F6;&#x5019;&#x53EA;&#x9700;&#x8981;inputs&#x5373;&#x53EF;&#x3002;outputs&#x8F93;&#x51FA;&#x9ED8;&#x8BA4;&#x4E3A;&#x7A7A;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C;&#x63D0;&#x4F9B;random_rois&#x7684;&#x503C;&#x5927;&#x4E8E;0&#x7684;&#x53C2;&#x6570;&#x3002;&#x90A3;&#x4E48;DataGenerator&#x5C06;&#x4F1A;&#x8FC7;&#x6EE4;&#x4E4B;&#x540E;&#x8FD4;&#x56DE;&#x6574;&#x4E2A;&#x7F51;&#x7EDC;&#x4E2D;&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;maskrcnn&#x7684;&#x9700;&#x8981;&#x7684;RoIs&#x611F;&#x5174;&#x8DA3;&#x6846;&#x76F8;&#x5173;&#x4FE1;&#x606F;</strong></p>
<ul>
<li>&#x56E0;&#x4E3A;&#x8BAD;&#x7EC3;&#x671F;&#x95F4;&#x7F51;&#x7EDC;&#x5728;&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#x4EA7;&#x751F;bbox&#x8BAD;&#x7EC3;&#x4E4B;&#x540E;</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># inputs&#x8FD4;&#x56DE;&#x503C;&#x5305;&#x542B;</span>
- images: [batch, H, W, C]
- image_meta: [batch, (meta data)] Image details. 
meta = np.array(
        [image_id] +                  <span class="hljs-comment"># size=1</span>
        list(original_image_shape) +  <span class="hljs-comment"># size=3</span>
        list(image_shape) +           <span class="hljs-comment"># size=3</span>
        list(window) +                <span class="hljs-comment"># size=4 (y1, x1, y2, x2) in image cooredinates</span>
        [scale] +                     <span class="hljs-comment"># size=1</span>
        list(active_class_ids)        <span class="hljs-comment"># size=num_classes</span>
    )
- rpn_match: [batch, N] Integer (<span class="hljs-number">1</span>=positive anchor, -<span class="hljs-number">1</span>=negative, <span class="hljs-number">0</span>=neutral) <span class="hljs-comment"># &#x653F;&#x5E9C;&#x4E25;&#x683C;&#x4E0D;&#x80FD;</span>
- rpn_bbox: [batch, N, (dy, dx, log(dh), log(dw))] Anchor bbox deltas.<span class="hljs-comment"># anchor&#x4E0E;GT&#x8FDB;&#x884C;&#x504F;&#x79FB;&#x7684;&#x503C;</span>
- gt_class_ids: [batch, MAX_GT_INSTANCES] <span class="hljs-comment"># GTclass IDs</span>
- gt_boxes: [batch, MAX_GT_INSTANCES, (y1, x1, y2, x2)]<span class="hljs-comment"># GT&#x7269;&#x4F53;&#x6846;&#x4F4D;&#x7F6E;</span>
- gt_masks: [batch, height, width, MAX_GT_INSTANCES]. The height <span class="hljs-keyword">and</span> width <span class="hljs-comment"># GT mask&#x76EE;&#x6807;&#x503C;</span>
                    are those of the image unless use_mini_mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">True</span>, <span class="hljs-keyword">in</span> which
                    case they are defined <span class="hljs-keyword">in</span> MINI_MASK_SHAPE.


<span class="hljs-comment"># outputs &#x9ED8;&#x8BA4;&#x4E3A;&#x7A7A;&#xFF0C;&#x5982;&#x679C;&#x63D0;&#x4F9B;random_rois &#x5927;&#x4E8E;0&#x7684;&#x53C2;&#x6570;</span>
ouptuts=[batch_mrcnn_class_ids, batch_mrcnn_bbox, batch_mrcnn_mask]
</code></pre>
<p>&#x5176;&#x4E2D;&#x5728;DataGenerator&#x7684;&#x8FD4;&#x56DE;&#x6279;&#x6B21;&#x6570;&#x636E;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;&#x4E0B;&#x9762;&#x51FD;&#x6570;&#x3002;</p>
<p>&#xFF08;3&#xFF09;build_rpn_targets(image_shape, anchors, gt_class_ids, gt_boxes, config): anchor-&gt;bbox</p>
<ul>
<li><strong>&#x5BF9;&#x4E8E;&#x76EE;&#x6807;GT&#x4EE5;&#x53CA;RPN&#x7684;&#x4F17;&#x591A;acnhor&#xFF0C;&#x8FDB;&#x884C;&#x6B63;&#x8D1F;&#x6837;&#x672C;&#x5339;&#x914D;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x8F6C;&#x6362;&#x6781;&#x5750;&#x6807;&#x5230;&#x4E2D;&#x5FC3;&#x5750;&#x6807;</strong><ul>
<li>&#x5E76;&#x4E14;&#x6839;&#x636E;&#x53D8;&#x6362;&#x516C;&#x5F0F;&#x6539;&#x53D8;anchor&#xFF0C;</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"># &#x8FD4;&#x56DE;&#x7ED3;&#x679C;
    anchors: [num_anchors, (y1, x1, y2, x2)]
    gt_class_ids: [num_gt_boxes] Integer class IDs.
    gt_boxes: [num_gt_boxes, (y1, x1, y2, x2)]

    Returns:
    rpn_match: [N] (int32) matches between anchors and GT boxes.
               1 = positive anchor, -1 = negative anchor, 0 = neutral
    rpn_bbox: [N, (dy, dx, log(dh), log(dw))] Anchor bbox deltas.
# GT&#x5750;&#x6807;&#x53D8;&#x5316;&#x516C;&#x5F0F;
gt_h = gt[2] - gt[0]
gt_w = gt[3] - gt[1]
gt_center_y = gt[0] + 0.5 * gt_h
gt_center_x = gt[1] + 0.5 * gt_w
# Anchor&#x7684;&#x5750;&#x6807;&#x53D8;&#x6362;
a_h = a[2] - a[0]
a_w = a[3] - a[1]
a_center_y = a[0] + 0.5 * a_h
a_center_x = a[1] + 0.5 * a_w  
# &#x4FDD;&#x5B58;&#x504F;&#x79FB;&#x7ED3;&#x679C;
rpn_bbox[ix] = [
(gt_center_y - a_center_y) / a_h,
(gt_center_x - a_center_x) / a_w,
np.log(gt_h / a_h),
np.log(gt_w / a_w),
]
</code></pre>
<p>&#xFF08;4&#xFF09;build_detection_targets(rpn_rois, gt_class_ids, gt_boxes, gt_masks, config):&#xFF08;&#x5982;&#x679C;&#x9700;&#x8981;&#x8FD4;&#x56DE;outputs&#x5C31;&#x4F1A;&#x8C03;&#x7528;&#x8BE5;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#xFF09;</p>
<ul>
<li><p>Generate targets for training Stage 2 classifier and mask heads.</p>
</li>
<li><pre><code># &#x8BAD;&#x7EC3;&#x671F;&#x95F4;&#x4E0D;&#x4F7F;&#x7528;&#xFF0C;&#x662F;&#x7528;&#x4F5C;&#x8C03;&#x8BD5;debug&#x4F7F;&#x7528;&#x6216;&#x8005;&#x5355;&#x72EC;&#x8BAD;&#x7EC3;&#x4E0D;&#x5E26;&#x6709;RPN&#x7F51;&#x7EDC;&#x7684;maskrcnn&#x7ED3;&#x6784;&#x65F6;&#x65F6;&#x4F7F;&#x7528;
This is not used in normal training. It&apos;s useful for debugging or to train
the Mask RCNN heads without using the RPN head.
</code></pre></li>
</ul>
<pre><code class="lang-python"># &#x8F93;&#x5165;Inputs:
rpn_rois: [N, (y1, x1, y2, x2)] proposal boxes.
gt_class_ids: [instance count] Integer class IDs
gt_boxes: [instance count, (y1, x1, y2, x2)]
gt_masks: [height, width, instance count] Ground truth masks. Can be full
          size or mini-masks.

# &#x8F93;&#x51FA;Returns:&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x4EE5;&#x53CA;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x7684;&#x6846;&#x4F4D;&#x7F6E;&#x548C;mask
# &#x4E00;&#x5F20;&#x56FE;&#x7247;&#x53EA;&#x4EA7;&#x751F;200&#x533A;&#x57DF;&#x7ED9;maskrcnn&#x8BAD;&#x7EC3;
# Number of ROIs per image to feed to classifier/mask heads
# The Mask RCNN paper uses 512 but often the RPN doesn&apos;t generate
# enough positive proposals to fill this and keep a positive:negative
# ratio of 1:3. You can increase the number of proposals by adjusting
# the RPN NMS threshold.
#TRAIN_ROIS_PER_IMAGE = 200
rois: [TRAIN_ROIS_PER_IMAGE, (y1, x1, y2, x2)]
class_ids: [TRAIN_ROIS_PER_IMAGE]. Integer class IDs.
bboxes: [TRAIN_ROIS_PER_IMAGE, NUM_CLASSES, (y, x, log(h), log(w))]. Class-specific
        bbox refinements.
masks: [TRAIN_ROIS_PER_IMAGE, height, width, NUM_CLASSES). Class specific masks cropped
       to bbox boundaries and resized to neural network output size.
</code></pre>
<ul>
<li><p>3&#x3001;compile(self, learning_rate, momentum):</p>
<ul>
<li>Gets the model ready for training. Adds losses, regularization, and metrics. Then calls the Keras compile() function.</li>
<li>&#x6307;&#x5B9A;&#x8BAD;&#x7EC3;&#x7684;&#x5B66;&#x4E60;&#x7387;&#x635F;&#x5931;&#x3001;&#x6DFB;&#x52A0;&#x4E94;&#x79CD;&#x635F;&#x5931;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x8BA1;&#x7B97;&#x3001;L2 Regularization&#x6B63;&#x5219;&#x5316;&#xFF0C;&#x5E76;&#x4E14;&#x4F1A;&#x5728;&#x51FD;&#x6570;&#x4E2D;&#x8C03;&#x7528;keras.compile()&#x51FD;&#x6570;</li>
<li>loss_names = [&quot;rpn_class_loss&quot;,  &quot;rpn_bbox_loss&quot;,&quot;mrcnn_class_loss&quot;, &quot;mrcnn_bbox_loss&quot;, &quot;mrcnn_mask_loss&quot;]</li>
</ul>
</li>
<li>4&#x3001;model.fit&#x5C31;&#x662F;&#x6B63;&#x5E38;&#x7684;&#x8BAD;&#x7EC3;&#x51FD;&#x6570;</li>
</ul>
<h4 id="6917-&#x6848;&#x4F8B;&#xFF1A;&#x7F51;&#x7EDC;&#x6570;&#x636E;anchor&#x4EE5;&#x53CA;&#x76EE;&#x6807;&#x503C;&#x8BBE;&#x7F6E;&#x5206;&#x6790;">6.9.1.7 &#x6848;&#x4F8B;&#xFF1A;&#x7F51;&#x7EDC;&#x6570;&#x636E;Anchor&#x4EE5;&#x53CA;&#x76EE;&#x6807;&#x503C;&#x8BBE;&#x7F6E;&#x5206;&#x6790;</h4>
<p>&#x4E3A;&#x4E86;&#x66F4;&#x597D;&#x7406;&#x89E3;maskrcnn&#x4E2D;&#x7684;RPN&#x7ED3;&#x6784;&#x8BBE;&#x7F6E;&#x7684;acnhor&#x3002;&#x8FD9;&#x91CC;&#x5BF9;&#x4E8E;anchor&#x505A;&#x8F93;&#x51FA;&#x5206;&#x6790;,&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E0A;&#x9762;dataset&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x5728;ballon_dataset.py&#x6587;&#x4EF6;&#x4E2D;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x3002;</p>
<ul>
<li>1&#x3001;utils.generate_pyramid_anchors<ul>
<li>&#x9700;&#x8981;rpn anchor&#x7684;&#x5927;&#x5C0F;&#xFF0C;rpnanchor&#x7684;&#x957F;&#x5BBD;&#x6BD4;&#x7387;&#x7B49;&#x53C2;&#x6570;</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># &#x9700;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x6765;&#x8FDB;&#x884C;&#x6253;&#x5370;</span>
  <span class="hljs-comment"># 3&#x3001;&#x8BA1;&#x7B97;anchor&#x7ED3;&#x679C;</span>
    config = BalloonConfig()
    <span class="hljs-comment"># &#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7279;&#x5F81;&#x56FE;&#x5927;&#x5C0F;&#x5C5E;&#x6027;&#xFF08;&#x8FD9;&#x91CC;&#x505A;&#x6D4B;&#x8BD5;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x4E00;&#x4E0B;&#x624D;&#x80FD;&#x7528;generate_pyramid_anchors&#xFF09;&#xFF0C;dataset&#x4E2D;&#x76F4;&#x63A5;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7279;&#x5F81;&#x56FE;&#x5927;&#x5C0F;</span>
    config.BACKBONE_SHAPES = [[<span class="hljs-number">256</span>, <span class="hljs-number">256</span>], [<span class="hljs-number">128</span>, <span class="hljs-number">128</span>], [<span class="hljs-number">64</span>, <span class="hljs-number">64</span>], [<span class="hljs-number">32</span>, <span class="hljs-number">32</span>], [<span class="hljs-number">16</span>, <span class="hljs-number">16</span>]]
    anchors = utils.generate_pyramid_anchors(config.RPN_ANCHOR_SCALES,
                                             config.RPN_ANCHOR_RATIOS,
                                             config.BACKBONE_SHAPES,
                                             config.BACKBONE_STRIDES,
                                             config.RPN_ANCHOR_STRIDE)

    <span class="hljs-comment"># &#x6253;&#x5370;anchor&#x76F8;&#x5173;&#x4FE1;&#x606F;</span>
    num_levels = len(config.BACKBONE_SHAPES)
    anchors_per_cell = len(config.RPN_ANCHOR_RATIOS)
    print(<span class="hljs-string">&quot;Count: &quot;</span>, anchors.shape[<span class="hljs-number">0</span>])
    print(<span class="hljs-string">&quot;Scales: &quot;</span>, config.RPN_ANCHOR_SCALES)
    print(<span class="hljs-string">&quot;ratios: &quot;</span>, config.RPN_ANCHOR_RATIOS)
    print(<span class="hljs-string">&quot;Anchors per Cell: &quot;</span>, anchors_per_cell)
    print(<span class="hljs-string">&quot;Levels: &quot;</span>, num_levels)
    anchors_per_level = []
    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> range(num_levels):
        num_cells = config.BACKBONE_SHAPES[l][<span class="hljs-number">0</span>] * config.BACKBONE_SHAPES[l][<span class="hljs-number">1</span>]
        anchors_per_level.append(anchors_per_cell * num_cells // config.RPN_ANCHOR_STRIDE ** <span class="hljs-number">2</span>)
        print(<span class="hljs-string">&quot;Anchors in Level {}: {}&quot;</span>.format(l, anchors_per_level[l]))
</code></pre>
<p>&#x603B;&#x5171;&#x7ED9;&#x7ED3;&#x679C;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-comment"># &#x603B;&#x5171;anchor&#x6570;&#x91CF;</span>
Count:  <span class="hljs-number">261888</span>
Scales:  (<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">512</span>)
ratios:  [<span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
Anchors per Cell:  <span class="hljs-number">3</span>
Levels:  <span class="hljs-number">5</span>
<span class="hljs-comment"># &#x7B2C;&#x4E00;&#x5C42;&#x7279;&#x5F81;&#x56FE;&#x7684;anchor&#x6570;&#x91CF;</span>
Anchors <span class="hljs-keyword">in</span> Level <span class="hljs-number">0</span>: <span class="hljs-number">196608</span>
Anchors <span class="hljs-keyword">in</span> Level <span class="hljs-number">1</span>: <span class="hljs-number">49152</span>
Anchors <span class="hljs-keyword">in</span> Level <span class="hljs-number">2</span>: <span class="hljs-number">12288</span>
Anchors <span class="hljs-keyword">in</span> Level <span class="hljs-number">3</span>: <span class="hljs-number">3072</span>
Anchors <span class="hljs-keyword">in</span> Level <span class="hljs-number">4</span>: <span class="hljs-number">768</span>
</code></pre>
<h5 id="2&#x3001;&#x6570;&#x636E;&#x96C6;&#x7684;&#x51C6;&#x5907;&#x9636;&#x6BB5;&#x7ED3;&#x679C;&#x5206;&#x6790;">2&#x3001;&#x6570;&#x636E;&#x96C6;&#x7684;&#x51C6;&#x5907;&#x9636;&#x6BB5;&#x7ED3;&#x679C;&#x5206;&#x6790;</h5>
<ul>
<li>&#xFF08;1&#xFF09;&#x5BF9;&#x4E8E;RPN&#x4EA7;&#x751F;&#x7684;261888&#x53BB;&#x505A;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x9ED8;&#x8BA4;200&#x4E2A;&#x8F93;&#x5165;&#x5230;msrcnn&#x4E2D;&#x3002;</li>
<li>&#xFF08;2&#xFF09;&#x5BF9;&#x9ED8;&#x8BA4;&#x6807;&#x8BB0;&#x7684;RPN&#x6837;&#x672C;&#x7EDF;&#x8BA1;&#x6B63;&#x8D1F;&#x6837;&#x672C;&#xFF0C;&#x6B63;&#x6837;&#x672C;&#x4F4D;&#x7F6E;&#x8FDB;&#x884C;refine&#x663E;&#x793A;&#x3002;&#x603B;&#x5171;256&#x4E2A;</li>
<li>&#xFF08;3&#xFF09;ROIs&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x4F1A;&#x8FDB;&#x884C;&#x6B63;&#x8D1F;&#x6837;&#x672C;&#x6807;&#x8BB0;&#x3002;&#x603B;&#x5171;200&#x4E2A;</li>
</ul>
<p>&#xFF08;1&#xFF09;&#x83B7;&#x53D6;anchor&#x7684;&#x4EE3;&#x7801;&#x4EE5;&#x53CA;&#x8FDB;&#x884C;&#x83B7;&#x53D6;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x7ED3;&#x679C;</p>
<ul>
<li>model.DataGenerator&#x4F1A;&#x5728;&#x5185;&#x90E8;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># 4&#x3001;anchor&#x5230;rois&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;</span>
    <span class="hljs-keyword">from</span> mrcnn <span class="hljs-keyword">import</span> model
    random_rois = <span class="hljs-number">2000</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;4&#x4E2A;&#x6570;&#x636E;&#x6D4B;&#x8BD5;&#x770B;&#x7ED3;&#x679C;</span>
    g = model.DataGenerator(dataset_train, config,
                            shuffle=<span class="hljs-keyword">True</span>,
                            random_rois=random_rois,
                            detection_targets=<span class="hljs-keyword">True</span>)
    <span class="hljs-comment"># &#x9488;&#x5BF9;&#x6570;&#x636E;&#x96C6;&#x7684;GT&#x8BA1;&#x7B97;&#x5F97;&#x5230;rpn&#x7684;&#x9884;&#x6D4B;&#x6846;&#x4EE5;&#x53CA;mrcnn&#x7684;&#x8F93;&#x51FA;&#x9884;&#x6D4B;&#x6846;</span>
    <span class="hljs-keyword">if</span> random_rois:
        [normalized_images, image_meta, rpn_match, rpn_bbox, gt_class_ids, gt_boxes, gt_masks, rpn_rois, rois], \
        [mrcnn_class_ids, mrcnn_bbox, mrcnn_mask] = g.__getitem__(<span class="hljs-number">0</span>)

        <span class="hljs-comment"># &#x6253;&#x5370;rois&#x4EE5;&#x53CA;mrcnn</span>
        log(<span class="hljs-string">&quot;rois&quot;</span>, rois)
        log(<span class="hljs-string">&quot;mrcnn_class_ids&quot;</span>, mrcnn_class_ids)
        log(<span class="hljs-string">&quot;mrcnn_bbox&quot;</span>, mrcnn_bbox)
        log(<span class="hljs-string">&quot;mrcnn_mask&quot;</span>, mrcnn_mask)

    <span class="hljs-comment"># &#x6253;&#x5370;GT&#x7ED3;&#x679C;</span>
    log(<span class="hljs-string">&quot;gt_class_ids&quot;</span>, gt_class_ids)
    log(<span class="hljs-string">&quot;gt_boxes&quot;</span>, gt_boxes)
    log(<span class="hljs-string">&quot;gt_masks&quot;</span>, gt_masks)
    log(<span class="hljs-string">&quot;rpn_match&quot;</span>, rpn_match, )
    log(<span class="hljs-string">&quot;rpn_bbox&quot;</span>, rpn_bbox)
    image_id = image_meta[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
    print(<span class="hljs-string">&quot;image_id: &quot;</span>, image_id)
</code></pre>
<p>&#x6253;&#x5370;&#x8F93;&#x51FA;&#x7ED3;&#x679C;</p>
<pre><code class="lang-python"><span class="hljs-comment"># 1&#x3001;RPN&#x7684;anchor&#x8FC7;&#x6EE4;&#x4E4B;&#x540E;&#x4F20;&#x5165;maskrcnn&#x9636;&#x6BB5;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#xFF0C;&#x8FD9;&#x91CC;2&#x6307;&#x7684;&#x6837;&#x672C;&#x6570;&#x9ED8;&#x8BA4;&#x6700;&#x5C0F;&#x8FD4;&#x56DE;&#x6570;&#x91CF;</span>
rois                     shape: (<span class="hljs-number">2</span>, <span class="hljs-number">200</span>, <span class="hljs-number">4</span>)           min:    <span class="hljs-number">0.00000</span>  max: <span class="hljs-number">1021.00000</span>  int32
mrcnn_class_ids          shape: (<span class="hljs-number">2</span>, <span class="hljs-number">200</span>, <span class="hljs-number">1</span>)           min:    <span class="hljs-number">0.00000</span>  max:    <span class="hljs-number">1.00000</span>  int32
mrcnn_bbox               shape: (<span class="hljs-number">2</span>, <span class="hljs-number">200</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>)        min:   -<span class="hljs-number">3.46591</span>  max:    <span class="hljs-number">2.96960</span>  float32
mrcnn_mask               shape: (<span class="hljs-number">2</span>, <span class="hljs-number">200</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">2</span>)   min:    <span class="hljs-number">0.00000</span>  max:    <span class="hljs-number">1.00000</span>  float32
<span class="hljs-comment"># 2&#x3001;msrcnn&#x6700;&#x7EC8;&#x4F1A;100&#x4E2A;&#x6846;</span>
gt_class_ids             shape: (<span class="hljs-number">2</span>, <span class="hljs-number">100</span>)              min:    <span class="hljs-number">0.00000</span>  max:    <span class="hljs-number">1.00000</span>  int32
gt_boxes                 shape: (<span class="hljs-number">2</span>, <span class="hljs-number">100</span>, <span class="hljs-number">4</span>)           min:    <span class="hljs-number">0.00000</span>  max:  <span class="hljs-number">985.00000</span>  int32
gt_masks                 shape: (<span class="hljs-number">2</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">100</span>)      min:    <span class="hljs-number">0.00000</span>  max:    <span class="hljs-number">1.00000</span>  bool
<span class="hljs-comment"># 4&#x3001;rpn&#x7684;anchor&#x6807;&#x8BB0;&#x7ED3;&#x679C;  </span>
rpn_match                shape: (<span class="hljs-number">2</span>, <span class="hljs-number">261888</span>, <span class="hljs-number">1</span>)        min:   -<span class="hljs-number">1.00000</span>  max:    <span class="hljs-number">1.00000</span>  int32
<span class="hljs-comment"># &#x6BCF;&#x5F20;&#x56FE;RPN &#x4F7F;&#x7528;256&#x4E2A;&#x6837;&#x672C;&#xFF0C;</span>
rpn_bbox                 shape: (<span class="hljs-number">2</span>, <span class="hljs-number">256</span>, <span class="hljs-number">4</span>)           min:   -<span class="hljs-number">1.95943</span>  max:    <span class="hljs-number">1.38107</span>  float64
<span class="hljs-comment"># &#x6B64;&#x56FE;&#x7247;ID</span>
image_id:  <span class="hljs-number">17.0</span>
</code></pre>
<p>&#xFF08;2&#xFF09;&#x7136;&#x540E;&#x5BF9;&#x4E8E;&#x6807;&#x8BB0;&#x4E4B;&#x540E;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x505A;&#x6B63;&#x8D1F;&#x6837;&#x672C;&#x6570;&#x91CF;&#x7EDF;&#x8BA1;&#xFF0C;&#x5E76;&#x4E14;&#x5BF9;&#x4E8E;&#x6B63;&#x6837;&#x672C;&#x7684;&#x6570;&#x636E;&#x505A;&#x5FAE;&#x8C03;&#x4E4B;&#x540E;&#x7ED3;&#x679C;&#x6253;&#x5370;&#x5728;&#x56FE;&#x7247;&#x4E2D;&#x3002;&#x8D1F;&#x6837;&#x672C;&#x540C;&#x65F6;&#x4E5F;&#x6253;&#x5370;&#x5728;&#x56FE;&#x7247;&#x4E2D;&#x663E;&#x793A;&#x51FA;&#x6765;&#x3002;</p>
<pre><code class="lang-python"><span class="hljs-comment"># 5&#x3001;&#x5BF9;&#x4E8E;&#x5176;&#x4E2D;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x8FDB;&#x884C;anchor&#x7684;&#x5750;&#x6807;&#x8F6C;&#x6362;&#x663E;&#x793A;</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6B63;&#x8D1F;&#x6837;&#x672C;&#x5339;&#x914D;&#x7ED3;&#x679C;</span>
    b = <span class="hljs-number">0</span>
    positive_anchor_ids = np.where(rpn_match[b] == <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
    print(<span class="hljs-string">&quot;Positive anchors: {}&quot;</span>.format(len(positive_anchor_ids)))
    negative_anchor_ids = np.where(rpn_match[b] == -<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
    print(<span class="hljs-string">&quot;Negative anchors: {}&quot;</span>.format(len(negative_anchor_ids)))
    neutral_anchor_ids = np.where(rpn_match[b] == <span class="hljs-number">0</span>)[<span class="hljs-number">0</span>]
    print(<span class="hljs-string">&quot;Neutral anchors: {}&quot;</span>.format(len(neutral_anchor_ids)))

    <span class="hljs-comment"># &#x5BF9;&#x4E8E;&#x6807;&#x8BB0;&#x4E3A;&#x6B63;&#x6837;&#x672C;anchor&#x8FDB;&#x884C;&#x4F4D;&#x7F6E;refine&#x8BA1;&#x7B97;</span>
    indices = np.where(rpn_match[b] == <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
    refined_anchors = utils.apply_box_deltas(anchors[indices], rpn_bbox[b, :len(indices)] * config.RPN_BBOX_STD_DEV)
    log(<span class="hljs-string">&quot;anchors&quot;</span>, anchors)
    log(<span class="hljs-string">&quot;refined_anchors&quot;</span>, refined_anchors)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5176;&#x4E2D;&#x9ED8;&#x8BA4;&#x7B2C;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x6253;&#x5370;&#x6B63;&#x6837;&#x672C;&#x6807;&#x8BB0;&#x7ED3;&#x679C;&#x548C;&#x8D1F;&#x6837;&#x672C;&#x6807;&#x8BB0;&#x7ED3;&#x679C;</span>
    sample_image = model.unmold_image(normalized_images[b], config)
    <span class="hljs-comment"># ROI&#x7684;&#x7C7B;&#x522B;&#x6570;&#x91CF;</span>
    <span class="hljs-keyword">for</span> c, n <span class="hljs-keyword">in</span> zip(dataset_train.class_names, np.bincount(mrcnn_class_ids[b].flatten())):
        <span class="hljs-keyword">if</span> n:
            print(<span class="hljs-string">&quot;{:23}: {}&quot;</span>.format(c[:<span class="hljs-number">20</span>], n))

    <span class="hljs-comment"># &#x5C55;&#x793A;&#x6B63;&#x6837;&#x672C;&#x8F93;&#x51FA;&#x7ED3;&#x679C;</span>
    <span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
    fig, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>))
    visualize.draw_boxes(sample_image, boxes=anchors[positive_anchor_ids],
                         refined_boxes=refined_anchors, ax=ax)
</code></pre>
<p>&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-comment"># RPN&#x6807;&#x8BB0;&#x6B63;&#x6837;&#x672C;&#x6570;&#x91CF; 10+246=256</span>
Positive anchors: <span class="hljs-number">10</span>
<span class="hljs-comment"># RPN&#x6807;&#x8BB0;&#x8D1F;&#x6837;&#x672C;&#x6570;&#x91CF;</span>
Negative anchors: <span class="hljs-number">246</span>
<span class="hljs-comment"># RPN&#x6807;&#x8BB0;&#x65E0;&#x6548;&#x6846;&#x6570;&#x91CF;</span>
Neutral anchors: <span class="hljs-number">261632</span>
<span class="hljs-comment"># anchors&#x603B;&#x6570;&#x91CF;</span>
anchors                  shape: (<span class="hljs-number">261888</span>, <span class="hljs-number">4</span>)           min: -<span class="hljs-number">362.03867</span>  max: <span class="hljs-number">1322.03867</span>  float64
<span class="hljs-comment"># &#x6B63;&#x6837;&#x672C;&#x8FDB;&#x884C;refined&#x4E4B;&#x540E;&#x7684;anchor&#x6570;&#x91CF;</span>
refined_anchors          shape: (<span class="hljs-number">10</span>, <span class="hljs-number">4</span>)               min:    <span class="hljs-number">1.00000</span>  max:  <span class="hljs-number">826.00000</span>  float32  
<span class="hljs-comment"># &#x5176;&#x4E2D;&#x8FD9;200&#x4E2A;bbox&#x6846;&#x7684;&#x7C7B;&#x522B;&#x7ED3;&#x679C;</span>
<span class="hljs-comment"># &#x80CC;&#x666F;&#x6570;&#x91CF;</span>
BG                     : <span class="hljs-number">176</span>
<span class="hljs-comment"># &#x6C14;&#x7403;&#x6570;&#x91CF;</span>
balloon                : <span class="hljs-number">24</span>
</code></pre>
<p>&#x6548;&#x679C;&#xFF0C;&#x8FD9;&#x662F;&#x6211;&#x4EEC;&#x5BF9;&#x4E8E;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x4E2D;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x4E4B;&#x540E;&#x7684;&#x7B5B;&#x9009;&#x7684;&#x7ED3;&#x679C;</p>
<p><img src="../images/tois&#x533A;&#x57DF;&#x7B5B;&#x9009;&#x5FAE;&#x8C03;.jpg" alt=""></p>
<ul>
<li>&#x663E;&#x793A;&#x8D1F;&#x6837;&#x672C;&#x6807;&#x8BB0;&#x7684;246&#x4E2A;&#x7ED3;&#x679C;</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># &#x5C55;&#x793A;&#x8D1F;&#x6837;&#x672C;&#x8F93;&#x51FA;</span>
visualize.draw_boxes(sample_image, boxes=anchors[negative_anchor_ids])
</code></pre>
<p>&#x8FD9;&#x91CC;&#x6362;&#x4E86;&#x4E00;&#x5F20;&#x56FE;&#xFF08;&#x6240;&#x4EE5;&#x8D1F;&#x6837;&#x672C;&#x6570;&#x91CF;&#x4E0D;&#x4E00;&#x5B9A;&#x662F;&#x4E0A;&#x9762;&#x7684;246&#xFF09;</p>
<p><img src="../images/&#x8D1F;&#x6837;&#x672C;&#x663E;&#x793A;&#x7ED3;&#x679C;.jpg" alt=""></p>
<p>&#x5176;&#x4E2D;&#x6CA1;&#x6709;&#x6807;&#x8BB0;&#x7684;anchor&#x662F;&#x4E0D;&#x4F1A;&#x53C2;&#x4E0E;&#x7F51;&#x7EDC;&#x8BAD;&#x7EC3;&#x7684;</p>
<p>&#xFF08;3&#xFF09;Rois&#xFF1A;msrcnn&#x7684;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x6807;&#x8BB0;&#x663E;&#x793A;</p>
<pre><code class="lang-python">print(<span class="hljs-string">&quot;Positive ROIs: &quot;</span>, mrcnn_class_ids[b][mrcnn_class_ids[b] &gt; <span class="hljs-number">0</span>].shape[<span class="hljs-number">0</span>])
print(<span class="hljs-string">&quot;Negative ROIs: &quot;</span>, mrcnn_class_ids[b][mrcnn_class_ids[b] == <span class="hljs-number">0</span>].shape[<span class="hljs-number">0</span>])
print(<span class="hljs-string">&quot;Positive Ratio: {:.2f}&quot;</span>.format(
    mrcnn_class_ids[b][mrcnn_class_ids[b] &gt; <span class="hljs-number">0</span>].shape[<span class="hljs-number">0</span>] / mrcnn_class_ids[b].shape[<span class="hljs-number">0</span>]))
</code></pre>
<p>&#x7ED3;&#x679C;&#x4E3A;</p>
<pre><code class="lang-python">Positive ROIs:  <span class="hljs-number">27</span>
Negative ROIs:  <span class="hljs-number">173</span>
Positive Ratio: <span class="hljs-number">0.14</span>
</code></pre>
<h4 id="6916-&#x6848;&#x4F8B;&#xFF1A;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x4EE3;&#x7801;&#x7F16;&#x5199;">6.9.1.6 &#x6848;&#x4F8B;&#xFF1A;&#x6A21;&#x578B;&#x52A0;&#x8F7D;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x4EE3;&#x7801;&#x7F16;&#x5199;</h4>
<p>&#x521B;&#x5EFA;&#x6A21;&#x578B;&#x5224;&#x65AD;&#x53C2;&#x6570;&#x5982;&#x679C;&#x662F;&#x8BAD;&#x7EC3;&#xFF0C;&#x8C03;&#x7528;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;</p>
<pre><code class="lang-python"><span class="hljs-comment"># 3&#x3001;&#x521B;&#x5EFA;&#x6A21;&#x578B;</span>
<span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
    model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;training&quot;</span>, config=config,
                              model_dir=args.logs)
<span class="hljs-keyword">else</span>:
    model = maskrcnn.MaskRCNN(mode=<span class="hljs-string">&quot;inference&quot;</span>, config=config,
                              model_dir=args.logs)
<span class="hljs-comment"># 4&#x3001;&#x8BAD;&#x7EC3;&#x6D4B;&#x8BD5;&#x903B;&#x8F91;&#x5B9E;&#x73B0;</span>
<span class="hljs-keyword">if</span> args.command == <span class="hljs-string">&quot;train&quot;</span>:
    <span class="hljs-comment"># &#x9009;&#x62E9;&#x52A0;&#x8F7D;&#x7684;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x7C7B;&#x522B;&#x5E76;&#x4E0B;&#x8F7D;</span>
    <span class="hljs-keyword">if</span> args.weights.lower() == <span class="hljs-string">&quot;imagenet&quot;</span>:
        weights_path = model.get_imagenet_weights()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;&#x63D0;&#x4F9B;&#x4E00;&#x79CD;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x79CD;&#x7C7B;&quot;</span>)

    <span class="hljs-comment"># &#x52A0;&#x8F7D;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x6743;&#x91CD;</span>
    print(<span class="hljs-string">&quot;Loading weights &quot;</span>, weights_path)
    model.load_weights(weights_path, by_name=<span class="hljs-keyword">True</span>)

    <span class="hljs-comment"># &#x8FDB;&#x884C;&#x8BAD;&#x7EC3;</span>
    train(model)
</code></pre>
<p>&#xFF08;1&#xFF09;&#x52A0;&#x8F7D;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#xFF0C;&#x6A21;&#x578B;&#x4E2D;&#x63D0;&#x4F9B;&#x4E86;&#x591A;&#x79CD;&#x9884;&#x8BAD;&#x7EC3;&#x8BFB;&#x53D6;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;imagenet&#x7684;&#x6A21;&#x578B;&#x8BFB;&#x53D6;</p>
<ul>
<li><strong>model.get_imagenet_weights()&#xFF1A;msrcnn&#x6A21;&#x578B;&#x4E2D;&#x5C01;&#x88C5;&#x7684;&#x6B64;&#x65B9;&#x6CD5;&#x4F1A;&#x6307;&#x5B9A;&#x6A21;&#x578B;&#x4E0B;&#x8F7D;</strong><ul>
<li>&#x7136;&#x540E;&#x901A;&#x8FC7;model.load_weights&#x52A0;&#x8F7D;&#x6A21;&#x578B;&#x6743;&#x91CD;&#xFF08;&#x6B64;&#x65B9;&#x6CD5;&#x4E5F;&#x662F;msrcnn&#x6A21;&#x578B;&#x672C;&#x8EAB;&#x5C01;&#x88C5;&#x7684;&#x51FD;&#x6570;&#xFF09;</li>
</ul>
</li>
</ul>
<p>&#x5F53;&#x6307;&#x5B9A;&#x597D;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x4ECE;&#x4E00;&#x4E9B;&#x5B98;&#x65B9;&#x91CA;&#x653E;&#x7684;&#x9884;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x8DEF;&#x5F84;&#x4E2D;&#x4E0B;&#x8F7D;&#xFF0C;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;&#xFF1A;/root/.keras/models/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5&#x8DEF;&#x5F84;&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x786E;&#x4FDD;&#x5BB6;&#x76EE;&#x5F55;&#x4E0B;&#x7684;.keras&#x6709;&#x8DB3;&#x591F;&#x7684;&#x7A7A;&#x95F4;&#x5B58;&#x50A8;&#x6A21;&#x578B;&#x3002;</p>
<pre><code class="lang-python">Downloading data <span class="hljs-keyword">from</span> https://github.com/fchollet/deep-learning-models/releases/download/v0<span class="hljs-number">.2</span>/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5
<span class="hljs-number">94658560</span>/<span class="hljs-number">94653016</span> [==============================] - <span class="hljs-number">472</span>s <span class="hljs-number">5</span>us/step
Loading weights  /root/.keras/models/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5
</code></pre>
<blockquote>
<p>&#x6CE8;&#xFF1A;&#x6216;&#x8005;&#x6307;&#x5B9A;COCO&#x9884;&#x8BAD;&#x7EC3;&#x8DEF;&#x5F84;</p>
<p>weights_path = COCO_WEIGHTS_PATH</p>
<p>&#x901A;&#x8FC7;msrcnn&#x4E2D;&#x7684;utils&#x4E2D;&#x4E0B;&#x9762;&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6743;&#x91CD;&#x52A0;&#x8F7D;&#x5230;&#x6A21;&#x578B;&#x4E2D;</p>
<p> utils.download_trained_weights(weights_path)</p>
</blockquote>
<p>&#xFF08;2&#xFF09;&#x5176;&#x4E2D;train&#x51FD;&#x6570;&#x4E2D;&#x662F;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x548C;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;&#x4EE3;&#x7801;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span><span class="hljs-params">(model)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&#x903B;&#x8F91;
    :param model: maskrcnn&#x6A21;&#x578B;
    :return:
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1&#x3001;&#x83B7;&#x53D6;&#x5206;&#x5272;&#x6570;&#x636E;&#x96C6;</span>
    dataset_train = BalloonDataset()
    dataset_train.load_balloon(args.dataset, <span class="hljs-string">&quot;train&quot;</span>)
    dataset_train.prepare()

    <span class="hljs-comment"># 2&#x3001;&#x83B7;&#x53D6;&#x5206;&#x5272;&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;</span>
    dataset_val = BalloonDataset()
    dataset_val.load_balloon(args.dataset, <span class="hljs-string">&quot;val&quot;</span>)
    dataset_val.prepare()

    <span class="hljs-comment"># 3&#x3001;&#x5F00;&#x59CB;&#x8BAD;&#x7EC3;</span>
    print(<span class="hljs-string">&quot;&#x5F00;&#x59CB;&#x8BAD;&#x7EC3;&#x7F51;&#x7EDC;:&quot;</span>)
    model.train(dataset_train, dataset_val,
                learning_rate=config.LEARNING_RATE,
                epochs=<span class="hljs-number">20</span>,
                layers=<span class="hljs-string">&apos;heads&apos;</span>)
</code></pre>
<p>&#x6A21;&#x578B;&#x8BAD;&#x7EC3;&#x4FDD;&#x5B58;&#x5230;./logs/&#x4E2D;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#xFF0C;&#x8FD9;&#x91CC;&#x63D0;&#x4F9B;&#x4E86;&#x8BAD;&#x7EC3;&#x597D;&#x7684;&#x7248;&#x672C;mask_rcnn_balloon.h5&#x3002;&#x65B9;&#x4FBF;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x4F7F;&#x7528;&#x3002;</p>
<h4 id="6917-&#x6848;&#x4F8B;&#xFF1A;maskrcnn&#x7F51;&#x7EDC;&#x7ED3;&#x6784;&#x6D41;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;">6.9.1.7 &#x6848;&#x4F8B;&#xFF1A;maskrcnn&#x7F51;&#x7EDC;&#x7ED3;&#x6784;&#x6D41;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;</h4>
<p>&#x5176;&#x4E2D;&#x6E90;&#x7801;&#x4E2D;&#x5BFC;&#x5165;&#x4F1A;&#x6709;&#x4E9B;&#x5E93;&#x8FDB;&#x884C;&#x7B80;&#x5199;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> tensorflow.keras <span class="hljs-keyword">as</span> keras
<span class="hljs-keyword">import</span> tensorflow.keras.backend <span class="hljs-keyword">as</span> K
<span class="hljs-keyword">import</span> tensorflow.keras.layers <span class="hljs-keyword">as</span> KL
<span class="hljs-keyword">import</span> tensorflow.keras.layers <span class="hljs-keyword">as</span> KE
<span class="hljs-keyword">import</span> tensorflow.keras.utils <span class="hljs-keyword">as</span> KU
<span class="hljs-keyword">import</span> tensorflow.keras.models <span class="hljs-keyword">as</span> KM
</code></pre>
<p>1&#x3001;&#x6784;&#x9020;&#x8F93;&#x51FA;</p>
<pre><code class="lang-python">input_image = KL.Input(
    shape=[<span class="hljs-keyword">None</span>, <span class="hljs-keyword">None</span>, config.IMAGE_SHAPE[<span class="hljs-number">2</span>]], name=<span class="hljs-string">&quot;input_image&quot;</span>)
input_image_meta = KL.Input(shape=[config.IMAGE_META_SIZE],
                            name=<span class="hljs-string">&quot;input_image_meta&quot;</span>)
</code></pre>
<p>2&#x3001;&#x5982;&#x679C;&#x8BAD;&#x7EC3;&#x7684;&#x8BDD;&#xFF0C;&#x6784;&#x9020;RPN&#x5C42;&#x7684;anchor&#x8F93;&#x5165;&#x6837;&#x672C;&#x53CA;&#x5176;&#x4F4D;&#x7F6E;&#x3001;&#x6784;&#x9020;masrcnn&#x7684;GT&#x8F93;&#x5165;&#xFF0C;&#x5E76;&#x5BF9;&#x5750;&#x6807;&#x8FDB;&#x884C;normalize&#xFF0C;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x4E86;USE_MINI_MASK=True&#xFF0C;&#x90A3;&#x4E48;input_gt_masks&#x5C31;&#x5FC5;&#x987B;&#x662F;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;[56, 56]&#x5927;&#x5C0F;</p>
<pre><code class="lang-python"><span class="hljs-comment"># RPN GT</span>
            input_rpn_match = KL.Input(
                shape=[<span class="hljs-keyword">None</span>, <span class="hljs-number">1</span>], name=<span class="hljs-string">&quot;input_rpn_match&quot;</span>, dtype=tf.int32)
            input_rpn_bbox = KL.Input(
                shape=[<span class="hljs-keyword">None</span>, <span class="hljs-number">4</span>], name=<span class="hljs-string">&quot;input_rpn_bbox&quot;</span>, dtype=tf.float32)

            <span class="hljs-comment"># Detection GT (class IDs, bounding boxes, and masks)</span>
            <span class="hljs-comment"># 1. GT Class IDs (zero padded)</span>
            input_gt_class_ids = KL.Input(
                shape=[<span class="hljs-keyword">None</span>], name=<span class="hljs-string">&quot;input_gt_class_ids&quot;</span>, dtype=tf.int32)
            <span class="hljs-comment"># 2. GT Boxes in pixels (zero padded)</span>
            <span class="hljs-comment"># [batch, MAX_GT_INSTANCES, (y1, x1, y2, x2)] in image coordinates</span>
            input_gt_boxes = KL.Input(
                shape=[<span class="hljs-keyword">None</span>, <span class="hljs-number">4</span>], name=<span class="hljs-string">&quot;input_gt_boxes&quot;</span>, dtype=tf.float32)
            <span class="hljs-comment"># Normalize coordinates</span>
            gt_boxes = KL.Lambda(<span class="hljs-keyword">lambda</span> x: norm_boxes_graph(
                x, K.shape(input_image)[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]))(input_gt_boxes)
            <span class="hljs-comment"># 3. GT Masks (zero padded)</span>
            <span class="hljs-comment"># [batch, height, width, MAX_GT_INSTANCES]</span>
            <span class="hljs-keyword">if</span> config.USE_MINI_MASK:
                input_gt_masks = KL.Input(
                    shape=[config.MINI_MASK_SHAPE[<span class="hljs-number">0</span>],
                           config.MINI_MASK_SHAPE[<span class="hljs-number">1</span>], <span class="hljs-keyword">None</span>],
                    name=<span class="hljs-string">&quot;input_gt_masks&quot;</span>, dtype=bool)
            <span class="hljs-keyword">else</span>:
                input_gt_masks = KL.Input(
                    shape=[config.IMAGE_SHAPE[<span class="hljs-number">0</span>], config.IMAGE_SHAPE[<span class="hljs-number">1</span>], <span class="hljs-keyword">None</span>],
                    name=<span class="hljs-string">&quot;input_gt_masks&quot;</span>, dtype=bool)
</code></pre>
<p>3&#x3001;&#x5982;&#x679C;&#x6D4B;&#x8BD5;&#xFF0C;&#x76F4;&#x63A5;&#x6784;&#x9020;anchors&#x7684;&#x8F93;&#x5165;</p>
<pre><code class="lang-python"><span class="hljs-comment"># Anchors in normalized coordinates</span>
input_anchors = KL.Input(shape=[<span class="hljs-keyword">None</span>, <span class="hljs-number">4</span>], name=<span class="hljs-string">&quot;input_anchors&quot;</span>)
</code></pre>
<p>4&#x3001;&#x6784;&#x9020;&#x524D;&#x9762;Resnet&#x7F51;&#x7EDC;&#x8F93;&#x5165;&#xFF0C;&#x8F93;&#x51FA;</p>
<pre><code class="lang-python">_, C2, C3, C4, C5 = resnet_graph(input_image, config.BACKBONE,
                                 stage5=<span class="hljs-keyword">True</span>, train_bn=config.TRAIN_BN)
</code></pre>
<p>5&#x3001;Reset&#x591A;&#x7EA7;&#x7279;&#x5F81;&#x8F93;&#x51FA;&#xFF0C;&#x7ECF;&#x8FC7;FPN&#x5F97;&#x5230;5&#x5C42;&#x7279;&#x5F81;&#x8F93;&#x51FA;P2&#x3001;P3&#x3001;P4&#x3001;P5&#x3001;P6</p>
<pre><code class="lang-python"><span class="hljs-comment"># Top-down Layers</span>
        <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> add assert to varify feature map sizes match what&apos;s in config</span>
        P5 = KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), name=<span class="hljs-string">&apos;fpn_c5p5&apos;</span>)(C5)
        P4 = KL.Add(name=<span class="hljs-string">&quot;fpn_p4add&quot;</span>)([
            KL.UpSampling2D(size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), name=<span class="hljs-string">&quot;fpn_p5upsampled&quot;</span>)(P5),
            KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), name=<span class="hljs-string">&apos;fpn_c4p4&apos;</span>)(C4)])
        P3 = KL.Add(name=<span class="hljs-string">&quot;fpn_p3add&quot;</span>)([
            KL.UpSampling2D(size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), name=<span class="hljs-string">&quot;fpn_p4upsampled&quot;</span>)(P4),
            KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), name=<span class="hljs-string">&apos;fpn_c3p3&apos;</span>)(C3)])
        P2 = KL.Add(name=<span class="hljs-string">&quot;fpn_p2add&quot;</span>)([
            KL.UpSampling2D(size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), name=<span class="hljs-string">&quot;fpn_p3upsampled&quot;</span>)(P3),
            KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), name=<span class="hljs-string">&apos;fpn_c2p2&apos;</span>)(C2)])
        <span class="hljs-comment"># Attach 3x3 conv to all P layers to get the final feature maps.</span>
        P2 = KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">&quot;SAME&quot;</span>, name=<span class="hljs-string">&quot;fpn_p2&quot;</span>)(P2)
        P3 = KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">&quot;SAME&quot;</span>, name=<span class="hljs-string">&quot;fpn_p3&quot;</span>)(P3)
        P4 = KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">&quot;SAME&quot;</span>, name=<span class="hljs-string">&quot;fpn_p4&quot;</span>)(P4)
        P5 = KL.Conv2D(config.TOP_DOWN_PYRAMID_SIZE, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">&quot;SAME&quot;</span>, name=<span class="hljs-string">&quot;fpn_p5&quot;</span>)(P5)
        <span class="hljs-comment"># P6 is used for the 5th anchor scale in RPN. Generated by</span>
        <span class="hljs-comment"># subsampling from P5 with stride of 2.</span>
        P6 = KL.MaxPooling2D(pool_size=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), strides=<span class="hljs-number">2</span>, name=<span class="hljs-string">&quot;fpn_p6&quot;</span>)(P5)
</code></pre>
<p>6&#x3001;&#x6784;&#x9020;RPN&#x7684;&#x8F93;&#x5165;&#x4EE5;&#x53CA;maskrcnn&#x7684;&#x8F93;&#x5165;</p>
<pre><code class="lang-python"> <span class="hljs-comment"># Note that P6 is used in RPN, but not in the classifier heads.</span>
        rpn_feature_maps = [P2, P3, P4, P5, P6]
        mrcnn_feature_maps = [P2, P3, P4, P5]
</code></pre>
<p>7&#x3001;&#x5982;&#x679C;&#x662F;&#x8BAD;&#x7EC3;&#xFF0C;&#x5C31;&#x83B7;&#x53D6;&#x6BCF;&#x4E00;&#x5C42;&#x82E5;&#x5E72;anchors&#x5408;&#x5E76;&#xFF08;&#x5C31;&#x662F;&#x524D;&#x9762;&#x6F14;&#x793A;&#x7684;&#x7ED3;&#x679C;&#xFF09;&#xFF0C;&#x505A;&#x5F62;&#x72B6;&#x6539;&#x53D8;&#x3002;&#x6D4B;&#x8BD5;&#x76F4;&#x63A5;&#x83B7;&#x53D6;input_anchors</p>
<pre><code class="lang-python"><span class="hljs-comment"># Anchors</span>
<span class="hljs-keyword">if</span> mode == <span class="hljs-string">&quot;training&quot;</span>:
    anchors = self.get_anchors(config.IMAGE_SHAPE)
    <span class="hljs-comment"># Duplicate across the batch dimension because Keras requires it</span>
    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> can this be optimized to avoid duplicating the anchors?</span>
    anchors = np.broadcast_to(anchors, (config.BATCH_SIZE,) + anchors.shape)
    <span class="hljs-comment"># A hack to get around Keras&apos;s bad support for constants</span>
    anchors = KL.Lambda(<span class="hljs-keyword">lambda</span> x: tf.Variable(anchors), name=<span class="hljs-string">&quot;anchors&quot;</span>)(input_image)
<span class="hljs-keyword">else</span>:
    anchors = input_anchors
</code></pre>
<p>8&#x3001;&#x6784;&#x9020;RPN&#x7F51;&#x7EDC;&#xFF0C;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;&#x7279;&#x5F81;&#x56FE;&#xFF0C;&#x90FD;&#x505A;&#x8F93;&#x5165;&#x5F97;&#x5230;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#xFF0C;&#x6700;&#x7EC8;&#x5F97;&#x5230;RPN&#x7F51;&#x7EDC;&#x7684;&#x8F93;&#x51FA;&#x6982;&#x7387;&#x3001;&#x7C7B;&#x522B;&#x4EE5;&#x53CA;&#x7F51;&#x7EDC;&#x9884;&#x6D4B;bbox&#x6846;</p>
<pre><code class="lang-python"><span class="hljs-comment"># RPN Model</span>
rpn = build_rpn_model(config.RPN_ANCHOR_STRIDE,
                      len(config.RPN_ANCHOR_RATIOS), config.TOP_DOWN_PYRAMID_SIZE)
config.TOP_DOWN_PYRAMID_SIZE)
        <span class="hljs-comment"># Loop through pyramid layers</span>
        layer_outputs = []  <span class="hljs-comment"># list of lists</span>
        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> rpn_feature_maps:
            layer_outputs.append(rpn([p]))
output_names = [<span class="hljs-string">&quot;rpn_class_logits&quot;</span>, <span class="hljs-string">&quot;rpn_class&quot;</span>, <span class="hljs-string">&quot;rpn_bbox&quot;</span>]
        outputs = list(zip(*layer_outputs))
        outputs = [KL.Concatenate(axis=<span class="hljs-number">1</span>, name=n)(list(o))
                   <span class="hljs-keyword">for</span> o, n <span class="hljs-keyword">in</span> zip(outputs, output_names)]

        rpn_class_logits, rpn_class, rpn_bbox = outputs
</code></pre>
<p>9&#x3001;&#x4EA7;&#x751F;proposals&#x5EFA;&#x8BAE;&#x6846;&#xFF0C;&#x6839;&#x636E;anchors&#x548C;&#x7F51;&#x7EDC;&#x9884;&#x6D4B;&#x8F93;&#x51FA;&#xFF0C;&#x4EA7;&#x751F;&#x914D;&#x7F6E;&#x6307;&#x5B9A;&#x8FC7;&#x6EE4;&#x5230;2000&#x4E2A;</p>
<ul>
<li>ROIs kept after non-maximum suppression (training and inference)<ul>
<li>POST_NMS_ROIS_TRAINING = 2000</li>
<li>POST_NMS_ROIS_INFERENCE = 1000</li>
</ul>
</li>
</ul>
<pre><code class="lang-python">proposal_count = config.POST_NMS_ROIS_TRAINING <span class="hljs-keyword">if</span> mode == <span class="hljs-string">&quot;training&quot;</span>\
    <span class="hljs-keyword">else</span> config.POST_NMS_ROIS_INFERENCE
rpn_rois = ProposalLayer(
    proposal_count=proposal_count,
    nms_threshold=config.RPN_NMS_THRESHOLD,
    name=<span class="hljs-string">&quot;ROI&quot;</span>,
    config=config)([rpn_class, rpn_bbox, anchors])
</code></pre>
<p>10&#x3001;&#x5982;&#x679C;&#x662F;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;</p>
<ul>
<li>DetectionTargetLayer(config, name=&quot;proposal_targets&quot;)<ul>
<li>&#x5BF9;&#x4E8E;&#x5EFA;&#x8BAE;&#x6846;&#xFF0C;&#x4EE5;&#x53CA;&#x8F93;&#x5165;&#x7684;GT&#x7ED3;&#x679C;&#xFF0C;&#x4EA7;&#x751F;&#x7528;&#x4E8E;&#x76EE;&#x6807;&#x533A;&#x57DF;&#x6846;&#x3001;&#x7C7B;&#x522B;&#x3001;&#x4F4D;&#x7F6E;&#x3001;mask</li>
<li>&#x8BBE;&#x7F6E;&#x6210;config.MASK_SHAPE=[28, 28]</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-keyword">if</span> mode == <span class="hljs-string">&quot;training&quot;</span>:
    ....
    <span class="hljs-comment"># Generate detection targets</span>
    <span class="hljs-comment"># Subsamples proposals and generates target outputs for training</span>
    <span class="hljs-comment"># Note that proposal class IDs, gt_boxes, and gt_masks are zero</span>
    <span class="hljs-comment"># padded. Equally, returned rois and targets are zero padded.</span>
    rois, target_class_ids, target_bbox, target_mask =\
        DetectionTargetLayer(config, name=<span class="hljs-string">&quot;proposal_targets&quot;</span>)([
            target_rois, input_gt_class_ids, gt_boxes, input_gt_masks])
</code></pre>
<p>11&#x3001;Network Heads&#xFF08;&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#x7684;&#x5206;&#x7C7B;&#x3001;&#x56DE;&#x5F52;&#x3001;mask&#xFF09;</p>
<ul>
<li>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;maskrcnn&#x7684;fpn_classifier_graph&#x51FD;&#x6570;&#x8F93;&#x5165;&#x611F;&#x5174;&#x8DA3;&#x533A;&#x57DF;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#x5206;&#x7C7B;&#x56DE;&#x5F52;&#x8F93;&#x51FA;<ul>
<li>Builds the computation graph of the feature pyramid network classifier and regressor heads.</li>
</ul>
</li>
<li>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;maskrcnn&#x7684;mask&#x5206;&#x652F;&#xFF0C;&#x5F97;&#x5230;mrcnn_mask&#x8F93;&#x51FA;&#x7ED3;&#x679C;<ul>
<li>MASK_POOL_SIZE=[14, 14]</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> verify that this handles zero padded ROIs</span>
<span class="hljs-comment">#Returns:</span>
<span class="hljs-comment">#        logits: [batch, num_rois, NUM_CLASSES] classifier logits (before softmax)</span>
<span class="hljs-comment">#        probs: [batch, num_rois, NUM_CLASSES] classifier probabilities</span>
<span class="hljs-comment">#        bbox_deltas: [batch, num_rois, NUM_CLASSES, (dy, dx, log(dh), log(dw))] Deltas to apply to</span>
<span class="hljs-comment">#                     proposal boxes</span>
mrcnn_class_logits, mrcnn_class, mrcnn_bbox =\
    fpn_classifier_graph(rois, mrcnn_feature_maps, input_image_meta,
                         config.POOL_SIZE, config.NUM_CLASSES,
                         train_bn=config.TRAIN_BN,
                         fc_layers_size=config.FPN_CLASSIF_FC_LAYERS_SIZE)

<span class="hljs-comment"># Builds the computation graph of the mask head of Feature Pyramid Network.</span>
<span class="hljs-comment"># Returns: Masks [batch, num_rois, MASK_POOL_SIZE, MASK_POOL_SIZE, NUM_CLASSES]</span>
mrcnn_mask = build_fpn_mask_graph(rois, mrcnn_feature_maps,
                                  input_image_meta,
                                  config.MASK_POOL_SIZE,
                                  config.NUM_CLASSES,
                                  train_bn=config.TRAIN_BN)
</code></pre>
<p>12&#x3001;&#x635F;&#x5931;&#x8BA1;&#x7B97;&#x4EE5;&#x53CA;&#x6A21;&#x578B;&#x6700;&#x7EC8;&#x6784;&#x5EFA;</p>
<pre><code class="lang-python"><span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> clean up (use tf.identify if necessary)</span>
output_rois = KL.Lambda(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">1</span>, name=<span class="hljs-string">&quot;output_rois&quot;</span>)(rois)

<span class="hljs-comment"># Losses</span>
rpn_class_loss = KL.Lambda(<span class="hljs-keyword">lambda</span> x: rpn_class_loss_graph(*x), name=<span class="hljs-string">&quot;rpn_class_loss&quot;</span>)(
    [input_rpn_match, rpn_class_logits])
rpn_bbox_loss = KL.Lambda(<span class="hljs-keyword">lambda</span> x: rpn_bbox_loss_graph(config, *x), name=<span class="hljs-string">&quot;rpn_bbox_loss&quot;</span>)(
    [input_rpn_bbox, input_rpn_match, rpn_bbox])
class_loss = KL.Lambda(<span class="hljs-keyword">lambda</span> x: mrcnn_class_loss_graph(*x), name=<span class="hljs-string">&quot;mrcnn_class_loss&quot;</span>)(
    [target_class_ids, mrcnn_class_logits, active_class_ids])
bbox_loss = KL.Lambda(<span class="hljs-keyword">lambda</span> x: mrcnn_bbox_loss_graph(*x), name=<span class="hljs-string">&quot;mrcnn_bbox_loss&quot;</span>)(
    [target_bbox, target_class_ids, mrcnn_bbox])
mask_loss = KL.Lambda(<span class="hljs-keyword">lambda</span> x: mrcnn_mask_loss_graph(*x), name=<span class="hljs-string">&quot;mrcnn_mask_loss&quot;</span>)(
    [target_mask, target_class_ids, mrcnn_mask])

<span class="hljs-comment"># Model</span>
inputs = [input_image, input_image_meta,
          input_rpn_match, input_rpn_bbox, input_gt_class_ids, input_gt_boxes, input_gt_masks]
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> config.USE_RPN_ROIS:
    inputs.append(input_rois)
outputs = [rpn_class_logits, rpn_class, rpn_bbox,
           mrcnn_class_logits, mrcnn_class, mrcnn_bbox, mrcnn_mask,
           rpn_rois, output_rois,
           rpn_class_loss, rpn_bbox_loss, class_loss, bbox_loss, mask_loss]
model = KM.Model(inputs, outputs, name=<span class="hljs-string">&apos;mask_rcnn&apos;</span>)
</code></pre>
<h3 id="692-&#x6A21;&#x578B;&#x9884;&#x6D4B;&#x6D41;&#x7A0B;">6.9.2 &#x6A21;&#x578B;&#x9884;&#x6D4B;&#x6D41;&#x7A0B;</h3>
<p>&#x8FD9;&#x91CC;&#x91CD;&#x70B9;&#x5728;&#x4E8E;&#x5BF9;&#x56FE;&#x7247;&#x7684;&#x8BFB;&#x53D6;&#x9884;&#x6D4B;&#x548C;&#x663E;&#x793A;&#x3002;&#x53E6;&#x5916;&#x4E5F;&#x63D0;&#x4F9B;&#x4E86;opencv&#x8BFB;&#x53D6;&#x89C6;&#x9891;&#x5206;&#x5272;&#x7684;&#x7ED3;&#x679C;&#xFF08;&#x4E86;&#x89E3;&#x6D41;&#x7A0B;&#x5373;&#x53EF;&#xFF09;</p>
<p>&#x5B8C;&#x6210;&#x8FC7;&#x7A0B;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> utils.draw_segmention_utils <span class="hljs-keyword">import</span> detect_and_draw_segmentation

  <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">&quot;test&quot;</span>:
        model.load_weights(args.model, by_name=<span class="hljs-keyword">True</span>)
        <span class="hljs-comment"># &#x8FDB;&#x884C;&#x68C0;&#x6D4B;</span>
        detect_and_draw_segmentation(model,
                                     image_path=args.image,
                                     video_path=args.video)
    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">&quot;&apos;{}&apos; &#x4F20;&#x5165;&#x53C2;&#x6570;&#x65E0;&#x6CD5;&#x8BC6;&#x522B;. &quot;</span>
              <span class="hljs-string">&quot;&#x8BF7;&#x4F7F;&#x7528; &apos;train&apos; or &apos;test&apos;&quot;</span>.format(args.command))
</code></pre>
<p>&#x5176;&#x4E2D;detect_and_draw_segmentation()&#x65B9;&#x6CD5;&#x4E2D;&#x63D0;&#x4F9B;&#x4E86;&#x5BF9;&#x56FE;&#x7247;&#x6216;&#x8005;&#x89C6;&#x9891;&#x7684;&#x9884;&#x6D4B;&#x6807;&#x8BB0;&#x663E;&#x793A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5728;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x7684;utils&#x76EE;&#x5F55;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;draw_segmention_utils.py&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x7528;&#x4E8E;&#x9884;&#x6D4B;&#x6D41;&#x7A0B;&#x4E2D;&#x7684;&#x7ED8;&#x5236;&#x56FE;&#x7247;&#x4E0E;&#x89C6;&#x9891;&#x7684;&#x5DE5;&#x5177;&#x51FD;&#x6570;</p>
<ul>
<li>&#x4E3B;&#x51FD;&#x6570;&#x903B;&#x8F91;:<ul>
<li>&#x5224;&#x65AD;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x662F;&#x5426;&#x662F;&#x56FE;&#x7247;&#x8FD8;&#x662F;&#x89C6;&#x9891;&#xFF0C;&#x5206;&#x522B;&#x5904;&#x7406;&#xFF08;&#x4F7F;&#x7528;skimage&#x6A21;&#x5757;&#x8BFB;&#x53D6;&#x5904;&#x7406;&#xFF09;</li>
<li>1&#x3001;&#x56FE;&#x7247;&#x8BFB;&#x53D6;&#x3001;&#x68C0;&#x6D4B;&#x7ED3;&#x679C;&#x3001;&#x5206;&#x5272;&#x533A;&#x57DF;&#x7ED8;&#x5236;&#x3001;&#x4FDD;&#x5B58;&#x8F93;&#x51FA;</li>
<li>2&#x3001;&#x89C6;&#x9891;&#x7684;&#x8BFB;&#x53D6;&#x3001;&#x8BFB;&#x53D6;&#x6BCF;&#x4E00;&#x5E27;&#x7ED8;&#x5236;&#x6BCF;&#x4E00;&#x5E27;&#x7ED3;&#x679C;&#x3001;&#x8FD4;&#x56DE;&#x6570;&#x636E;&#x5230;&#x6307;&#x5B9A;&#x89C6;&#x9891;&#x76EE;&#x5F55;&#xFF08;&#x4E86;&#x89E3;&#x8FC7;&#x7A0B;&#xFF09;</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> skimage

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">detect_and_draw_segmentation</span><span class="hljs-params">(args, model)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x68C0;&#x6D4B;&#x7ED3;&#x679C;&#x5E76;&#x753B;&#x51FA;&#x5206;&#x5272;&#x533A;&#x57DF;
    :param args: &#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;
    :param model: &#x6A21;&#x578B;
    :return:
    &quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.image <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> args.video:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;&#x8BF7;&#x63D0;&#x4F9B;&#x8981;&#x68C0;&#x6D4B;&#x7684;&#x56FE;&#x7247;&#x6216;&#x8005;&#x89C6;&#x9891;&#x8DEF;&#x5F84;&#x4E4B;&#x4E00;&quot;</span>)

    <span class="hljs-comment"># &#x4F20;&#x5165;&#x7684;&#x56FE;&#x7247;</span>
    <span class="hljs-keyword">if</span> args.image:
        print(<span class="hljs-string">&quot;&#x6B63;&#x5728;&#x5206;&#x5272;&#x56FE;&#x7247;&#xFF1A;{}&quot;</span>.format(args.image))
        <span class="hljs-comment"># 1&#x3001;&#x8BFB;&#x53D6;&#x56FE;&#x7247;</span>
        image = skimage.io.imread(args.image)
        <span class="hljs-comment"># 2&#x3001;&#x6A21;&#x578B;&#x68C0;&#x6D4B;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</span>
        r = model.detect([image], verbose=<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
        <span class="hljs-comment"># 3&#x3001;&#x753B;&#x51FA;&#x5206;&#x5272;&#x533A;&#x57DF;</span>
        segmentation = draw_segmentation(image, r[<span class="hljs-string">&apos;masks&apos;</span>])
        <span class="hljs-comment"># 4&#x3001;&#x4FDD;&#x5B58;&#x8F93;&#x51FA;</span>
        file_name = <span class="hljs-string">&quot;./images/segment_{}&quot;</span>.format(args.image.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">1</span>])
        skimage.io.imsave(file_name, segmentation)

    <span class="hljs-keyword">if</span> args.video:
        <span class="hljs-keyword">import</span> cv2
        <span class="hljs-comment"># 1&#x3001;&#x83B7;&#x53D6;&#x89C6;&#x9891;&#x7684;&#x8BFB;&#x53D6;</span>
        vcapture = cv2.VideoCapture(args.video)
        width = int(vcapture.get(cv2.CAP_PROP_FRAME_WIDTH))
        height = int(vcapture.get(cv2.CAP_PROP_FRAME_HEIGHT))
        fps = vcapture.get(cv2.CAP_PROP_FPS)

        <span class="hljs-comment"># 2&#x3001;&#x5B9A;&#x4E49;video writer&#x540E;&#x7EED;&#x5199;&#x5165;</span>
        file_name = <span class="hljs-string">&quot;./images/segmentation_{}&quot;</span>.format(args.video.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">1</span>])
        vwriter = cv2.VideoWriter(file_name,
                                  cv2.VideoWriter_fourcc(*<span class="hljs-string">&apos;mp4v&apos;</span>),
                                  fps, (width, height))

        <span class="hljs-comment"># 3&#x3001;&#x5FAA;&#x73AF;&#x83B7;&#x53D6;&#x6BCF;&#x5E27;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x5199;&#x5165;&#x672C;&#x5730;&#x6587;&#x4EF6;</span>
        count = <span class="hljs-number">0</span>
        success = <span class="hljs-keyword">True</span>
        <span class="hljs-keyword">while</span> success:
            print(<span class="hljs-string">&quot;&#x5E27;&#x6570;: &quot;</span>, count)
            <span class="hljs-comment"># &#x8BFB;&#x53D6;&#x56FE;&#x7247;</span>
            success, image = vcapture.read()
            <span class="hljs-keyword">if</span> success:
                <span class="hljs-comment"># OpenCV &#x8FD4;&#x56DE;&#x7684;BGR&#x683C;&#x5F0F;&#x8F6C;&#x6362;&#x6210;RGB</span>
                image = image[..., ::-<span class="hljs-number">1</span>]
                <span class="hljs-comment"># &#x6A21;&#x578B;&#x68C0;&#x6D4B;mask</span>
                r = model.detect([image], verbose=<span class="hljs-number">0</span>)[<span class="hljs-number">0</span>]
                <span class="hljs-comment"># &#x753B;&#x51FA;&#x533A;&#x57DF;</span>
                segmentation = draw_segmentation(image, r[<span class="hljs-string">&apos;masks&apos;</span>])
                <span class="hljs-comment"># RGB -&gt; BGR</span>
                segmentation = segmentation[..., ::-<span class="hljs-number">1</span>]
                <span class="hljs-comment"># &#x6DFB;&#x52A0;&#x8FD9;&#x5F20;&#x56FE;&#x5230;video writer</span>
                vwriter.write(segmentation)
                count += <span class="hljs-number">1</span>
        vwriter.release()

    print(<span class="hljs-string">&quot;&#x4FDD;&#x5B58;&#x5230;&#x68C0;&#x6D4B;&#x7ED3;&#x679C;&#x5230;&#x8DEF;&#x5F84;&#x6587;&#x4EF6;&#xFF1A;&quot;</span>, file_name)
</code></pre>
<p>&#x5176;&#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x5BF9;&#x6BCF;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x7684;&#x5206;&#x5272;&#x533A;&#x57DF;&#x4EE5;&#x53CA;&#x56FE;&#x7247;&#x7ED8;&#x5236;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draw_segmentation</span><span class="hljs-params">(image, mask)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x5BF9;&#x56FE;&#x7247;&#x8FDB;&#x884C;&#x5206;&#x5272;&#x533A;&#x57DF;&#x7684;&#x6807;&#x8BB0;
    :param image: &#x8F93;&#x51FA;&#x56FE;&#x7247; RGB image [height, width, 3]
    :param mask: &#x5206;&#x5272;&#x533A;&#x57DF;[height, width, instance count]
    :return: &#x8FD4;&#x56DE;&#x9ED1;&#x767D;&#x56FE;&#x7247;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x5206;&#x5272;&#x533A;&#x57DF;&#x4FDD;&#x7559;&#x539F;&#x6765;&#x7684;&#x989C;&#x8272;
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1&#x3001;&#x5C06;&#x5F69;&#x8272;&#x56FE;&#x7247;&#x53D8;&#x6210;&#x7070;&#x5EA6;&#x56FE;&#xFF0C;&#x5E76;&#x4FDD;&#x7559;image&#x4EE5;&#x53CA;&#x540C;&#x4EFD;&#x7070;&#x8272;&#x7684;&#x56FE;&#x7247;</span>
    <span class="hljs-comment"># &#x8FD9;&#x91CC;&#x7ECF;&#x8FC7;&#x4E24;&#x6B21;&#x8F6C;&#x53D8;&#x76EE;&#x7684;&#xFF0C;gray&#x5FC5;&#x987B;&#x6709;&#x4E09;&#x4E2A;&#x901A;&#x9053;&#x624D;&#x80FD;&#x4E0E;&#x540E;&#x9762;np.where(mask, image, gray)&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#x5F97;&#x5230;segmentation</span>
    gray = skimage.color.gray2rgb(skimage.color.rgb2gray(image)) * <span class="hljs-number">255</span>

    <span class="hljs-comment"># 2&#x3001;&#x5C06;&#x5F69;&#x8272;&#x683C;&#x5F0F;&#x4E2D;mask&#x90E8;&#x5206;&#x4FDD;&#x7559;&#x5176;&#x4F59;&#x90E8;&#x5206;&#x90FD;&#x8BBE;&#x7F6E;&#x6210;gray</span>
    <span class="hljs-keyword">if</span> mask.shape[-<span class="hljs-number">1</span>] &gt; <span class="hljs-number">0</span>:
        <span class="hljs-comment"># &#x5982;&#x679C;&#x591A;&#x4E2A;&#x7269;&#x4F53;&#xFF0C;&#x8981;&#x5C06;&#x9884;&#x6D4B;&#x7ED3;&#x679C;&#x7684;&#x591A;&#x4E2A;&#x7269;&#x4F53;&#x7684;mask&#x76F8;&#x52A0;&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x5F20;mask</span>
        mask = (np.sum(mask, -<span class="hljs-number">1</span>, keepdims=<span class="hljs-keyword">True</span>) &gt;= <span class="hljs-number">1</span>)
        <span class="hljs-comment"># &#x8BB2;Mask&#x4E2D;&#x4E3A;1&#x7684;&#x8BBE;&#x7F6E;&#x6210;&#x56FE;&#x7247;&#x539F;&#x8272;&#xFF0C;0&#x7684;&#x8BBE;&#x7F6E;&#x6210;gray&#x5BF9;&#x5E94;&#x7684;</span>
        segmentation = np.where(mask, image, gray).astype(np.uint8)
    <span class="hljs-keyword">else</span>:
        segmentation = gray.astype(np.uint8)
    <span class="hljs-keyword">return</span> segmentation
</code></pre>
<p>&#x4F7F;&#x7528;&#x51FD;&#x6570;&#x89E3;&#x91CA;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> skimage <span class="hljs-keyword">import</span> io, data, color
<span class="hljs-comment"># &#x4E00;&#x5F20;&#x5F69;&#x8272;&#x56FE;&#x7247;&#x8F6C;&#x6362;&#x4E3A;&#x7070;&#x5EA6;&#x56FE;&#x540E;&#xFF0C;&#x5B83;&#x7684;&#x7C7B;&#x578B;&#x5C31;&#x7531;unit8&#x53D8;&#x6210;&#x4E86;float</span>
img_gray = color.rgb2gray(img)
<span class="hljs-comment"># &#x518D;&#x6B21;&#x8F6C;&#x6362;&#x4F1A;&#x6709;&#x635F;&#x5931;&#x7684;</span>
image2 = color.gray2rgb(img_gray)
<span class="hljs-comment"># API</span>
skimage.color.gray2rgb(image, alpha=<span class="hljs-keyword">None</span>)[source]
Create an RGB representation of a gray-level image.
Parameters
Input 
image of shape (M[, N][, P]).
Returns
rgbndarray
RGB image of shape (M[, N][, P], <span class="hljs-number">3</span>).
</code></pre>
<ul>
<li>&#x56FE;&#x50CF;&#x6570;&#x636E;&#x7C7B;&#x578B;</li>
</ul>
<p>&#x5728;skimage&#x4E2D;&#xFF0C;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x4EE5;numpy&#x6570;&#x7EC4;&#x5F62;&#x5F0F;&#x5B58;&#x50A8;&#xFF0C;&#x6570;&#x7EC4;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x6709;&#x5F88;&#x591A;&#x4E2D;&#xFF0C;&#x76F8;&#x4E92;&#x4E4B;&#x95F4;&#x53EF;&#x4EE5;&#x8F6C;&#x6362;&#xFF0C;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x4EE5;&#x53CA;&#x53D6;&#x503C;&#x8303;&#x56F4;&#x5982;&#x4E0B;&#x8868;&#x6240;&#x793A;</p>
<pre><code>&#x6570;&#x636E;&#x7C7B;&#x578B;    &#x6570;&#x503C;&#x8303;&#x56F4;
uint8    0 to 255
uint16    0 to 65535
float16    &#x534A;&#x7CBE;&#x5EA6;&#x6D6E;&#x70B9;&#x6570;&#xFF1A;16&#x4F4D;&#xFF0C;&#x6B63;&#x8D1F;&#x53F7;1&#x4F4D;&#xFF0C;&#x6307;&#x6570;5&#x4F4D;&#xFF0C;&#x7CBE;&#x5EA6;10&#x4F4D;
float32    &#x5355;&#x7CBE;&#x5EA6;&#x6D6E;&#x70B9;&#x6570;&#xFF1A;32&#x4F4D;&#xFF0C;&#x6B63;&#x8D1F;&#x53F7;1&#x4F4D;&#xFF0C;&#x6307;&#x6570;8&#x4F4D;&#xFF0C;&#x7CBE;&#x5EA6;23&#x4F4D;
float64    &#x53CC;&#x7CBE;&#x5EA6;&#x6D6E;&#x70B9;&#x6570;&#xFF1A;64&#x4F4D;&#xFF0C;&#x6B63;&#x8D1F;&#x53F7;1&#x4F4D;&#xFF0C;&#x6307;&#x6570;11&#x4F4D;&#xFF0C;&#x7CBE;&#x5EA6;52&#x4F4D;
</code></pre><p>&#x6211;&#x4EEC;&#x8BFB;&#x53D6;&#x63D0;&#x4F9B;&#x7684;&#x6D4B;&#x8BD5;&#x6587;&#x4EF6;&#x5982;&#x9879;&#x76EE;image&#x76EE;&#x5F55;&#x4E0B;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;</p>
<pre><code class="lang-python">parser.add_argument(<span class="hljs-string">&apos;--image&apos;</span>, type=str, default=<span class="hljs-string">&apos;./images/2917282960_06beee649a_b.jpg&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x5206;&#x5272;&#x7684;&#x56FE;&#x7247;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--video&apos;</span>, type=str, default=<span class="hljs-string">&apos;./images/v0200fd10000bq043q9pskdh7ri20vm0.MP4&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x5206;&#x5272;&#x7684;&#x89C6;&#x9891;&#x76EE;&#x5F55;&apos;</span>)
</code></pre>
<p>&#x6700;&#x7EC8;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x5982;&#x9879;&#x76EE;&#x4E4B;&#x524D;&#x6240;&#x793A;&#xFF08;&#x5F53;&#x7136;&#x5982;&#x679C;&#x6709;&#x9700;&#x8981;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x524D;&#x9762;&#x4ECB;&#x7ECD;&#x7684;&#x7ED8;&#x5236;bbox&#x5DE5;&#x5177;&#xFF0C;&#x5C06;&#x9884;&#x6D4B;&#x6846;&#x4E5F;&#x7ED8;&#x5236;&#x51FA;&#x6765;&#xFF09;&#xFF1A;</p>
<p><img src="../images/segment_2917282960_06beee649a_b.jpg" style="zoom:33%;"></p>
<h3 id="693-&#x5C0F;&#x7ED3;">6.9.3 &#x5C0F;&#x7ED3;</h3>
<ul>
<li>maskrcnn&#x4E2D;&#x7684;&#x6E90;&#x7801;&#x7F16;&#x8BD1;&#x8BAD;&#x7EC3;&#x6D41;&#x7A0B;</li>
<li>maskrcnn&#x4E2D;&#x7684;anchor&#x8BBE;&#x7F6E;&#x4EE5;&#x53CA;&#x8BA1;&#x7B97;</li>
<li>&#x6A21;&#x578B;&#x7684;&#x8BAD;&#x7EC3;&#x9884;&#x6D4B;&#x6D41;&#x7A0B;</li>
<li>&#x5B8C;&#x6210;maskrcnn&#x6307;&#x5B9A;&#x6C14;&#x7403;&#x5206;&#x5272;&#x6570;&#x636E;&#x96C6;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;</li>
<li>&#x5B8C;&#x6210;maskrcnn&#x6307;&#x5B9A;&#x56FE;&#x7247;&#x6216;&#x89C6;&#x9891;&#x9884;&#x6D4B;&#x8F93;&#x51FA;</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../imageSegmentation/section7.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Mask RCNN分割案例1"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"expandable-chapters":{},"katex":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
