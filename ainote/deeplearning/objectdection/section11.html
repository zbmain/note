<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>案例：KITTI人、车检测案例-训练、检测 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-expandable-chapters/expandable-chapters.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-katex/katex.min.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-splitter/splitter.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../imageSegmentation/index.html" />
    
    
    <link rel="prev" href="../objectdection/section10.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="5.11"
        data-chapter-title="案例：KITTI人、车检测案例-训练、检测"
        data-filepath="objectdection/section11.md"
        data-basepath=".."
        data-revision="Sun Oct 11 2020 09:58:20 GMT+0800 (中国标准时间)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        计算机视觉与深度学习课程
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="introduction/index.html">
            
                
                    <a href="../introduction/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        计算机视觉简介
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="introduction/section1.html">
            
                
                    <a href="../introduction/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        计算机视觉概念
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="introduction/section2.html">
            
                
                    <a href="../introduction/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        计算机视觉任务
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="tensorFlow/index.html">
            
                
                    <a href="../tensorFlow/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        tensorflow入门
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="tensorFlow/section1.html">
            
                
                    <a href="../tensorFlow/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        TensorFlow和Keras简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="tensorFlow/section2.html">
            
                
                    <a href="../tensorFlow/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        快速入门模型
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="deeplearning/index.html">
            
                
                    <a href="../deeplearning/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        深度神经网络
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="deeplearning/section1.html">
            
                
                    <a href="../deeplearning/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        神经网络简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="deeplearning/section2.html">
            
                
                    <a href="../deeplearning/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        常见的损失函数
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="deeplearning/section3.html">
            
                
                    <a href="../deeplearning/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        深度学习的优化方法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="deeplearning/section4.html">
            
                
                    <a href="../deeplearning/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        深度学习的正则化
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="deeplearning/section5.html">
            
                
                    <a href="../deeplearning/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        神经网络案例
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="deeplearning/section6.html">
            
                
                    <a href="../deeplearning/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                        卷积神经网络CNN
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="imageClassification/index.html">
            
                
                    <a href="../imageClassification/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        图像分类
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="imageClassification/section1.html">
            
                
                    <a href="../imageClassification/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        图像分类简介
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="imageClassification/section2.html">
            
                
                    <a href="../imageClassification/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        AlexNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="imageClassification/section3.html">
            
                
                    <a href="../imageClassification/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                        VGG
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="imageClassification/section4.html">
            
                
                    <a href="../imageClassification/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                        GoogLeNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="imageClassification/section5.html">
            
                
                    <a href="../imageClassification/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                        ResNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="imageClassification/section6.html">
            
                
                    <a href="../imageClassification/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.6.</b>
                        
                        图像增强方法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="imageClassification/section7.html">
            
                
                    <a href="../imageClassification/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.7.</b>
                        
                        模型微调
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="objectdection/index.html">
            
                
                    <a href="../objectdection/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        目标检测(Object Detection)
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="objectdection/section1.html">
            
                
                    <a href="../objectdection/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        目标检测概述
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="objectdection/section2.html">
            
                
                    <a href="../objectdection/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="objectdection/section3.html">
            
                
                    <a href="../objectdection/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                        SPPNet
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="objectdection/section4.html">
            
                
                    <a href="../objectdection/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                        Fast R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="objectdection/section5.html">
            
                
                    <a href="../objectdection/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.5.</b>
                        
                        Faster R-CNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="objectdection/section6.html">
            
                
                    <a href="../objectdection/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.6.</b>
                        
                        Faster RCNN接口分析
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="objectdection/section7.html">
            
                
                    <a href="../objectdection/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.7.</b>
                        
                        YOLO算法
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="objectdection/section8.html">
            
                
                    <a href="../objectdection/section8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.8.</b>
                        
                        YOLOV2&amp;V3
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="objectdection/section9.html">
            
                
                    <a href="../objectdection/section9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.9.</b>
                        
                        SSD算法原理
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.10" data-path="objectdection/section10.html">
            
                
                    <a href="../objectdection/section10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.10.</b>
                        
                        案例：KITTI人、车检测案例-数据集处理
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="5.11" data-path="objectdection/section11.html">
            
                
                    <a href="../objectdection/section11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.11.</b>
                        
                        案例：KITTI人、车检测案例-训练、检测
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="imageSegmentation/index.html">
            
                
                    <a href="../imageSegmentation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        目标分割(Object Segmentation)
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="imageSegmentation/section1.html">
            
                
                    <a href="../imageSegmentation/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                        目标分割介绍
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="imageSegmentation/section2.html">
            
                
                    <a href="../imageSegmentation/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.2.</b>
                        
                        FCN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="imageSegmentation/section3.html">
            
                
                    <a href="../imageSegmentation/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.3.</b>
                        
                        SegNet与U-Net
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="imageSegmentation/section6.html">
            
                
                    <a href="../imageSegmentation/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.4.</b>
                        
                        Mask RCNN
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="imageSegmentation/section7.html">
            
                
                    <a href="../imageSegmentation/section7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.5.</b>
                        
                        Mask RCNN分割案例1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="imageSegmentation/section8.html">
            
                
                    <a href="../imageSegmentation/section8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.6.</b>
                        
                        Mask RCNN分割案例2
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="511-&#x6848;&#x4F8B;&#xFF1A;kitti&#x4EBA;&#x3001;&#x8F66;&#x68C0;&#x6D4B;&#x6848;&#x4F8B;&#x8BAD;&#x7EC3;&#x3001;&#x68C0;&#x6D4B;">5.11 &#x6848;&#x4F8B;&#xFF1A;KITTI&#x4EBA;&#x3001;&#x8F66;&#x68C0;&#x6D4B;&#x6848;&#x4F8B;-&#x8BAD;&#x7EC3;&#x3001;&#x68C0;&#x6D4B;</h1>
<h3 id="&#x5B66;&#x4E60;&#x76EE;&#x6807;">&#x5B66;&#x4E60;&#x76EE;&#x6807;</h3>
<ul>
<li>&#x76EE;&#x6807;<ul>
<li>&#x65E0;</li>
</ul>
</li>
<li>&#x5E94;&#x7528;<ul>
<li>&#x5E94;&#x7528;&#x5B8C;&#x6210;KITTI&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8BAD;&#x7EC3;&#x548C;&#x68C0;&#x6D4B;&#x8FC7;&#x7A0B;</li>
</ul>
</li>
</ul>
<h3 id="5111-&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;">5.11.1 &#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;</h3>
<ul>
<li>&#x6B65;&#x9AA4;<ul>
<li>&#x8BAD;&#x7EC3;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;</li>
<li>1&#x3001;&#x5224;&#x65AD;&#x4F20;&#x5165;&#x7684;&#x662F;&#x9700;&#x8981;&#x8BAD;&#x7EC3;YoloV3Tiny&#x8FD8;&#x662F;YOLOV3&#x6B63;&#x5E38;&#x7248;&#x672C;<ul>
<li>&#x7531;&#x4E8E;&#x6709;&#x5B9E;&#x73B0;&#x591A;&#x4E2A;&#x7248;&#x672C;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x7528;&#x6237;&#x9009;&#x62E9;&#x5177;&#x4F53;&#x7248;&#x672C;&#x6765;&#x8FDB;&#x884C;&#x6307;&#x5B9A;&#x6A21;&#x578B;&#x8BAD;&#x7EC3;</li>
</ul>
</li>
<li>2&#x3001;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x4EE5;&#x53CA;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x9A8C;&#x8BC1;&#x96C6;&#x6570;&#x636E;<ul>
<li>&#x901A;&#x8FC7;dataset.load_tfrecord_dataset&#x8FDB;&#x884C;&#x8BFB;&#x53D6;</li>
</ul>
</li>
<li>4&#x3001;&#x5224;&#x65AD;&#x662F;&#x5426;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;&#x5B66;&#x4E60;<ul>
<li>&#x5728;&#x8BAD;&#x7EC3;&#x671F;&#x95F4;&#x53EF;&#x4EE5;&#x5C01;&#x88C5;&#x8BA9;&#x8BAD;&#x7EC3;&#x81EA;&#x5B9A;&#x4E49;&#x8BAD;&#x7EC3;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x4ECE;&#x800C;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x6570;&#x636E;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;</li>
</ul>
</li>
<li>5&#x3001;&#x5B9A;&#x4E49;&#x4F18;&#x5316;&#x5668;&#x4EE5;&#x53CA;&#x635F;&#x5931;&#x8BA1;&#x7B97;&#x65B9;&#x5F0F;</li>
<li>6&#x3001;&#x4F18;&#x5316;&#x8BAD;&#x7EC3;</li>
</ul>
</li>
</ul>
<p>&#x901A;&#x8FC7;argparse&#x8BBE;&#x7F6E;&#x8BAD;&#x7EC3;&#x53C2;&#x6570;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> os
os.environ[<span class="hljs-string">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span>] = <span class="hljs-string">&quot;2&quot;</span>

<span class="hljs-keyword">from</span> tensorflow.keras.callbacks <span class="hljs-keyword">import</span> (
    ReduceLROnPlateau,
    EarlyStopping,
    ModelCheckpoint,
    TensorBoard
)
<span class="hljs-keyword">from</span> yolov3_tf2.models <span class="hljs-keyword">import</span> (
    YoloV3, YoloV3Tiny, YoloLoss,
    yolo_anchors, yolo_anchor_masks,
    yolo_tiny_anchors, yolo_tiny_anchor_masks
)
<span class="hljs-keyword">from</span> yolov3_tf2.utils <span class="hljs-keyword">import</span> freeze_all
<span class="hljs-keyword">import</span> yolov3_tf2.dataset <span class="hljs-keyword">as</span> dataset

parser = argparse.ArgumentParser()
parser.add_argument(<span class="hljs-string">&apos;--dataset&apos;</span>, type=str, default=<span class="hljs-string">&apos;./data/kitti_tfrecords/train.tfrecord&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x96C6;&#x8DEF;&#x5F84;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--val_dataset&apos;</span>, type=str, default=<span class="hljs-string">&apos;./data/kitti_tfrecords/val.tfrecord&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x9A8C;&#x8BC1;&#x96C6;&#x76EE;&#x5F55;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--tiny&apos;</span>, type=bool, default=<span class="hljs-keyword">False</span>, help=<span class="hljs-string">&apos;&#x52A0;&#x8F7D;&#x7684;&#x6A21;&#x578B;&#x7C7B;&#x578B;yolov3 or yolov3-tiny&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--weights&apos;</span>, type=str, default=<span class="hljs-string">&apos;./checkpoints/yolov3_train_1.tf&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x6A21;&#x578B;&#x9884;&#x8BAD;&#x7EC3;&#x6743;&#x91CD;&#x8DEF;&#x5F84;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--classes&apos;</span>, type=str, default=<span class="hljs-string">&apos;./data/kitti.names&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x7C7B;&#x522B;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--mode&apos;</span>, type=str, default=<span class="hljs-string">&apos;fit&apos;</span>, choices=[<span class="hljs-string">&apos;fit&apos;</span>, <span class="hljs-string">&apos;eager_tf&apos;</span>],
                    help=<span class="hljs-string">&apos;fit: model.fit&#x6A21;&#x5F0F;, eager_tf: &#x81EA;&#x5B9A;&#x4E49;GradientTape&#x6A21;&#x5F0F;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--transfer&apos;</span>, type=str, default=<span class="hljs-string">&apos;none&apos;</span>, choices=[<span class="hljs-string">&apos;none&apos;</span>, <span class="hljs-string">&apos;darknet&apos;</span>,
                                                                     <span class="hljs-string">&apos;no_output&apos;</span>, <span class="hljs-string">&apos;frozen&apos;</span>,
                                                                     <span class="hljs-string">&apos;fine_tune&apos;</span>],
                    help=<span class="hljs-string">&apos;none: &#x5168;&#x90E8;&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;&apos;</span>
                         <span class="hljs-string">&apos;&#x8FC1;&#x79FB;&#x5B66;&#x4E60;&#x5E76;&#x51BB;&#x7ED3;&#x6240;&#x6709;, fine_tune: &#x8FC1;&#x79FB;&#x5E76;&#x53EA;&#x51BB;&#x7ED3;darknet&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--size&apos;</span>, type=int, default=<span class="hljs-number">416</span>,
                    help=<span class="hljs-string">&apos;&#x56FE;&#x7247;&#x5927;&#x5C0F;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--epochs&apos;</span>, type=int, default=<span class="hljs-number">2</span>,
                    help=<span class="hljs-string">&apos;&#x8FED;&#x4EE3;&#x6B21;&#x6570;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--batch_size&apos;</span>, type=int, default=<span class="hljs-number">8</span>,
                    help=<span class="hljs-string">&apos;&#x6BCF;&#x6279;&#x6B21;&#x5927;&#x5C0F;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--learning_rate&apos;</span>, type=float, default=<span class="hljs-number">1e-3</span>,
                    help=<span class="hljs-string">&apos;&#x5B66;&#x4E60;&#x7387;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--num_classes&apos;</span>, type=int, default=<span class="hljs-number">6</span>,
                    help=<span class="hljs-string">&apos;&#x7C7B;&#x522B;&#x6570;&#x91CF;&apos;</span>)
</code></pre>
<p>1&#x3001;&#x5224;&#x65AD;&#x4F20;&#x5165;&#x7684;&#x662F;&#x9700;&#x8981;&#x8BAD;&#x7EC3;YoloV3Tiny&#x8FD8;&#x662F;YOLOV3&#x6B63;&#x5E38;&#x7248;&#x672C;</p>
<ul>
<li><p>&#x5E76;&#x4E14;&#x521D;&#x59CB;&#x5316;YOLO&#x5404;&#x4E2A;&#x6A21;&#x578B;&#x7684;anchor&#x5927;&#x5C0F;&#xFF0C;&#xFF08;&#x5728;&#x6E90;&#x7801;&#x4E2D;&#x6709;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BA1;&#x7B97;&#x635F;&#x5931;&#x65F6;&#x5019;&#x9700;&#x8981;&#x7528;&#xFF09;</p>
<ul>
<li>anchors: &#x4F7F;&#x7528;&#x5230;&#x7684;anchor&#x7684;&#x5C3A;&#x5BF8;&#xFF0C;&#x5982;[10, 13, 16, 30, 33, 23, 30, 61, 62, 45, 59, 119, 116, 90, 156, 198, 373, 326]</li>
<li>anchor_mask: &#x6BCF;&#x4E2A;&#x5C42;&#x7EA7;&#x4E0A;&#x4F7F;&#x7528;&#x7684;anchor&#x7684;&#x63A9;&#x7801;&#xFF0C;[[6, 7, 8], [3, 4, 5], [0, 1, 2]]<ul>
<li>anchor box&#x7684;&#x7D22;&#x5F15;&#x6570;&#x7EC4;&#xFF0C;3&#x4E2A;1&#x7EC4;&#x5012;&#x5E8F;&#x6392;&#x5E8F;:<ul>
<li>&#x5982;6,7,8&#x5BF9;&#x5E94;13x13&#x7279;&#x5F81;&#x56FE;&#x53D6;(116, 90), (156, 198), (373, 326)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><pre><code class="lang-python">yolo_anchors = np.array([(<span class="hljs-number">10</span>, <span class="hljs-number">13</span>), (<span class="hljs-number">16</span>, <span class="hljs-number">30</span>), (<span class="hljs-number">33</span>, <span class="hljs-number">23</span>), (<span class="hljs-number">30</span>, <span class="hljs-number">61</span>), (<span class="hljs-number">62</span>, <span class="hljs-number">45</span>),
                         (<span class="hljs-number">59</span>, <span class="hljs-number">119</span>), (<span class="hljs-number">116</span>, <span class="hljs-number">90</span>), (<span class="hljs-number">156</span>, <span class="hljs-number">198</span>), (<span class="hljs-number">373</span>, <span class="hljs-number">326</span>)],
                        np.float32) / <span class="hljs-number">416</span>
yolo_anchor_masks = np.array([[<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]])

yolo_tiny_anchors = np.array([(<span class="hljs-number">10</span>, <span class="hljs-number">14</span>), (<span class="hljs-number">23</span>, <span class="hljs-number">27</span>), (<span class="hljs-number">37</span>, <span class="hljs-number">58</span>),
                              (<span class="hljs-number">81</span>, <span class="hljs-number">82</span>), (<span class="hljs-number">135</span>, <span class="hljs-number">169</span>),  (<span class="hljs-number">344</span>, <span class="hljs-number">319</span>)],
                             np.float32) / <span class="hljs-number">416</span>
yolo_tiny_anchor_masks = np.array([[<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]])
</code></pre>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># 1&#x3001;&#x5224;&#x65AD;&#x4F20;&#x5165;&#x7684;&#x662F;&#x9700;&#x8981;&#x8BAD;&#x7EC3;YoloV3Tiny&#x8FD8;&#x662F;YOLOV3&#x6B63;&#x5E38;&#x7248;&#x672C;</span>
    <span class="hljs-keyword">if</span> args.tiny:
        model = YoloV3Tiny(args.size, training=<span class="hljs-keyword">True</span>,
                           classes=args.num_classes)
        anchors = yolo_tiny_anchors
        anchor_masks = yolo_tiny_anchor_masks
    <span class="hljs-keyword">else</span>:
        model = YoloV3(args.size, training=<span class="hljs-keyword">True</span>, classes=args.num_classes)
        anchors = yolo_anchors
        anchor_masks = yolo_anchor_masks
</code></pre>
<p>2&#x3001;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x4EE5;&#x53CA;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x9A8C;&#x8BC1;&#x96C6;&#x6570;&#x636E;</p>
<ul>
<li>&#x901A;&#x8FC7;dataset.load_tfrecord_dataset&#x8FDB;&#x884C;&#x8BFB;&#x53D6;</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># 2&#x3001;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x8BAD;&#x7EC3;&#x6570;&#x636E;</span>
<span class="hljs-keyword">if</span> args.dataset:
    train_dataset = dataset.load_tfrecord_dataset(
        args.dataset, args.classes)
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>)
train_dataset = train_dataset.batch(args.batch_size)
train_dataset = train_dataset.map(<span class="hljs-keyword">lambda</span> x, y: (
    dataset.transform_images(x, args.size),
    dataset.transform_targets(y, anchors, anchor_masks, <span class="hljs-number">6</span>)))
train_dataset = train_dataset.prefetch(
    buffer_size=tf.data.experimental.AUTOTUNE)

<span class="hljs-comment"># 3&#x3001;&#x83B7;&#x53D6;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x9A8C;&#x8BC1;&#x96C6;&#x6570;&#x636E;</span>
<span class="hljs-keyword">if</span> args.val_dataset:
    val_dataset = dataset.load_tfrecord_dataset(
        args.val_dataset, args.classes)
val_dataset = val_dataset.batch(args.batch_size)
val_dataset = val_dataset.map(<span class="hljs-keyword">lambda</span> x, y: (
    dataset.transform_images(x, args.size),
    dataset.transform_targets(y, anchors, anchor_masks, <span class="hljs-number">6</span>)))
</code></pre>
<p>3&#x3001;&#x5224;&#x65AD;&#x8BAD;&#x7EC3;&#x662F;&#x5426;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;&#x5B66;&#x4E60;&#xFF0C;&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#x51BB;&#x7ED3;</p>
<ul>
<li>1&#x3001;&#x5982;&#x679C;&#x8FC1;&#x79FB;&#x5B66;&#x4E60;&#xFF1A;<ul>
<li>&#x52A0;&#x8F7D;&#x4E0E;&#x8BAD;&#x7EC3;&#x6743;&#x91CD;&#xFF0C;&#x53EF;&#x4ECE;&#x5B98;&#x7F51;&#x4E0B;&#x8F7D;<ul>
<li>&#x5982;&#x679C;&#x5224;&#x65AD;&#x5FAE;&#x8C03;&#x7684;&#x8BDD;&#xFF1A;&#x52A0;&#x8F7D;yolo_darknet&#xFF1A;x_36, x_61, x = Darknet(name=&apos;yolo_darknet&apos;)(x)&#xFF0C;&#x51BB;&#x7ED3;&#x8FD9;&#x4E9B;&#x5C42;</li>
<li>&#x5982;&#x679C;&#x7528;&#x6237;&#x4F20;&#x5165;frozen&#xFF1A;&#x51BB;&#x7ED3;&#x6240;&#x6709;&#x5C42;</li>
<li>&#x5982;&#x679C;&#x662F;&#x5176;&#x4ED6;&#xFF1A;&#x6839;&#x636E;YOLO&#x7C7B;&#x578B;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x6A21;&#x578B;<ul>
<li>&#x82E5;&#x53EA;&#x5BF9;darknet&#x8FC1;&#x79FB;&#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x5269;&#x4F59;&#x5176;&#x4ED6;&#x5C42;&#x8FDB;&#x884C;&#x51BB;&#x7ED3;</li>
<li>&#x5982;&#x679C;&#x662F;no_output&#xFF0C;&#x5427;out_put&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x968F;&#x673A;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x7136;&#x540E;&#x51BB;&#x7ED3;&#x5176;&#x4ED6;&#x52A0;&#x8F7D;&#x8FC7;&#x7684;&#x6A21;&#x578B;&#x6743;&#x91CD;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="lang-python"><span class="hljs-comment"># 4&#x3001;&#x5224;&#x65AD;&#x662F;&#x5426;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;&#x5B66;&#x4E60;</span>
<span class="hljs-keyword">if</span> args.transfer != <span class="hljs-string">&apos;none&apos;</span>:
    <span class="hljs-comment"># &#x52A0;&#x8F7D;&#x4E0E;&#x8BAD;&#x7EC3;&#x6A21;&#x578B;&apos;./data/yolov3.weights&apos;</span>
    model.load_weights(args.weights)
    <span class="hljs-keyword">if</span> args.transfer == <span class="hljs-string">&apos;fine_tune&apos;</span>:
        <span class="hljs-comment"># &#x51BB;&#x7ED3;darknet</span>
        darknet = model.get_layer(<span class="hljs-string">&apos;yolo_darknet&apos;</span>)
        freeze_all(darknet)
    <span class="hljs-keyword">elif</span> args.transfer == <span class="hljs-string">&apos;frozen&apos;</span>:
        <span class="hljs-comment"># &#x51BB;&#x7ED3;&#x6240;&#x6709;&#x5C42;</span>
        freeze_all(model)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># &#x91CD;&#x7F6E;&#x7F51;&#x7EDC;&#x540E;&#x7AEF;&#x7ED3;&#x6784;</span>
        <span class="hljs-keyword">if</span> args.tiny:
            init_model = YoloV3Tiny(
                args.size, training=<span class="hljs-keyword">True</span>, classes=args.num_classes)
        <span class="hljs-keyword">else</span>:
            init_model = YoloV3(
                args.size, training=<span class="hljs-keyword">True</span>, classes=args.num_classes)

        <span class="hljs-comment"># &#x5982;&#x679C;&#x8FC1;&#x79FB;&#x6307;&#x7684;&#x662F;darknet</span>
        <span class="hljs-keyword">if</span> args.transfer == <span class="hljs-string">&apos;darknet&apos;</span>:
            <span class="hljs-comment"># &#x83B7;&#x53D6;&#x7F51;&#x7EDC;&#x7684;&#x6743;&#x91CD;</span>
            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> model.layers:
                <span class="hljs-keyword">if</span> l.name != <span class="hljs-string">&apos;yolo_darknet&apos;</span> <span class="hljs-keyword">and</span> l.name.startswith(<span class="hljs-string">&apos;yolo_&apos;</span>):
                    l.set_weights(init_model.get_layer(
                        l.name).get_weights())
                <span class="hljs-keyword">else</span>:
                    freeze_all(l)
        <span class="hljs-keyword">elif</span> args.transfer == <span class="hljs-string">&apos;no_output&apos;</span>:
            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> model.layers:
                <span class="hljs-keyword">if</span> l.name.startswith(<span class="hljs-string">&apos;yolo_output&apos;</span>):
                    l.set_weights(init_model.get_layer(
                        l.name).get_weights())
                <span class="hljs-keyword">else</span>:
                    freeze_all(l)

<span class="hljs-comment"># &#x9700;&#x8981;&#x4ECE;&#x6A21;&#x578B;&#x6587;&#x4EF6;&#x4E2D;&#x5BFC;&#x5165;utils&#x4E2D;&#x7684;freeze_all&#x51FD;&#x6570;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_all</span><span class="hljs-params">(model, frozen=True)</span>:</span>
    model.trainable = <span class="hljs-keyword">not</span> frozen
    <span class="hljs-keyword">if</span> isinstance(model, tf.keras.Model):
        <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> model.layers:
            freeze_all(l, frozen)
</code></pre>
<p>5&#x3001;&#x5B9A;&#x4E49;&#x4F18;&#x5316;&#x5668;&#x4EE5;&#x53CA;&#x635F;&#x5931;&#x8BA1;&#x7B97;&#x65B9;&#x5F0F;</p>
<pre><code class="lang-python">optimizer = tf.keras.optimizers.Adam(lr=args.learning_rate)
<span class="hljs-comment"># &#x8FD4;&#x56DE;yolo_loss(y_true, y_pred)&#x7684;&#x51FD;&#x6570;</span>
loss = [YoloLoss(anchors[mask], classes=args.num_classes)
        <span class="hljs-keyword">for</span> mask <span class="hljs-keyword">in</span> anchor_masks]
</code></pre>
<p>&#x6CE8;&#xFF1A;&#x5176;&#x4E2D;YOLOLoss&#x7684;&#x8BA1;&#x7B97;&#x8FC7;&#x7A0B;&#x6E90;&#x7801;&#x5F53;&#x4E2D;</p>
<p>6&#x3001;&#x8BAD;&#x7EC3;&#x4F18;&#x5316;&#x8FC7;&#x7A0B;&#xFF0C;&#x8BAD;&#x7EC3;&#x6307;&#x5B9A;&#x6A21;&#x5F0F;</p>
<ul>
<li>&#x7528;eager&#x7684;&#x68AF;&#x5EA6;&#x8C03;&#x8BD5;&#x6A21;&#x5F0F;&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;&#x6613;&#x4E8E;&#x8C03;&#x8BD5;</li>
<li>keras model&#x7684;fit&#x6A21;&#x5F0F;&#x7B80;&#x5355;&#x6613;&#x7528;</li>
</ul>
<pre><code class="lang-python"><span class="hljs-keyword">if</span> args.mode == <span class="hljs-string">&apos;eager_tf&apos;</span>:
    <span class="hljs-comment"># 1&#x3001;&#x5B9A;&#x4E49;&#x8BC4;&#x4F30;&#x65B9;&#x5F0F;</span>
    avg_loss = tf.keras.metrics.Mean(<span class="hljs-string">&apos;loss&apos;</span>, dtype=tf.float32)
    avg_val_loss = tf.keras.metrics.Mean(<span class="hljs-string">&apos;val_loss&apos;</span>, dtype=tf.float32)

    <span class="hljs-comment"># 2&#x3001;&#x8FED;&#x4EE3;&#x4F18;&#x5316;</span>
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, args.epochs + <span class="hljs-number">1</span>):
        <span class="hljs-keyword">for</span> batch, (images, labels) <span class="hljs-keyword">in</span> enumerate(train_dataset):
            <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:
                <span class="hljs-comment"># 1&#x3001;&#x8BA1;&#x7B97;&#x6A21;&#x578B;&#x8F93;&#x51FA;&#x548C;&#x635F;&#x5931;</span>
                outputs = model(images, training=<span class="hljs-keyword">True</span>)
                regularization_loss = tf.reduce_sum(model.losses)
                pred_loss = []
                <span class="hljs-keyword">for</span> output, label, loss_fn <span class="hljs-keyword">in</span> zip(outputs, labels, loss):
                    <span class="hljs-comment"># &#x6839;&#x636E;&#x8F93;&#x51FA;&#x548C;&#x6807;&#x7B7E;&#x8BA1;&#x7B97;&#x51FA;&#x635F;&#x5931;</span>
                    pred_loss.append(loss_fn(label, output))

                <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x603B;&#x635F;&#x5931; = &#x5E73;&#x5747;&#x635F;&#x5931; + regularization_loss</span>
                total_loss = tf.reduce_sum(pred_loss) + regularization_loss

            <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x68AF;&#x5EA6;&#x4EE5;&#x53CA;&#x66F4;&#x65B0;&#x68AF;&#x5EA6;</span>
            grads = tape.gradient(total_loss, model.trainable_variables)
            optimizer.apply_gradients(
                zip(grads, model.trainable_variables))

            <span class="hljs-comment"># &#x6253;&#x5370;&#x65E5;&#x5FD7;</span>
            logging.info(<span class="hljs-string">&quot;{}_train_{}, {}, {}&quot;</span>.format(
                epoch, batch, total_loss.numpy(),
                list(map(<span class="hljs-keyword">lambda</span> x: np.sum(x.numpy()), pred_loss))))
            avg_loss.update_state(total_loss)

        <span class="hljs-comment"># &#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;&#x9A8C;&#x8BC1;&#x8F93;&#x51FA;&#x8BA1;&#x7B97;</span>
        <span class="hljs-keyword">for</span> batch, (images, labels) <span class="hljs-keyword">in</span> enumerate(val_dataset):
            outputs = model(images)
            <span class="hljs-comment"># &#x6C42;&#x635F;&#x5931;</span>
            regularization_loss = tf.reduce_sum(model.losses)
            pred_loss = []
            <span class="hljs-comment"># &#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x548C;&#x6807;&#x7B7E;&#x8BA1;&#x7B97;&#x635F;&#x5931;</span>
            <span class="hljs-keyword">for</span> output, label, loss_fn <span class="hljs-keyword">in</span> zip(outputs, labels, loss):
                pred_loss.append(loss_fn(label, output))
            total_loss = tf.reduce_sum(pred_loss) + regularization_loss

            <span class="hljs-comment"># &#x6253;&#x5370;&#x603B;&#x635F;&#x5931;</span>
            logging.info(<span class="hljs-string">&quot;{}_val_{}, {}, {}&quot;</span>.format(
                epoch, batch, total_loss.numpy(),
                list(map(<span class="hljs-keyword">lambda</span> x: np.sum(x.numpy()), pred_loss))))
            avg_val_loss.update_state(total_loss)

        logging.info(<span class="hljs-string">&quot;{}, train: {}, val: {}&quot;</span>.format(
            epoch,
            avg_loss.result().numpy(),
            avg_val_loss.result().numpy()))
        <span class="hljs-comment"># &#x4FDD;&#x5B58;&#x6A21;&#x578B;&#x4F4D;&#x7F6E;</span>
        avg_loss.reset_states()
        avg_val_loss.reset_states()
        model.save_weights(
            <span class="hljs-string">&apos;checkpoints/yolov3_train_{}.tf&apos;</span>.format(epoch))
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># &#x6307;&#x5B9A;&#x76F8;&#x5173;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;&#x9700;&#x6C42;&#xFF0C;&#x5BF9;&#x4E8E;&#x68C0;&#x6D4B;&#x6765;&#x8BB2;&#x4E0D;&#x9700;&#x8981;&#x592A;&#x591A;&#x7684;&#x4F18;&#x5316;&#x7B97;&#x6CD5;&#x65B9;&#x5F0F;</span>
    model.compile(optimizer=optimizer, loss=loss)

    callbacks = [
      EarlyStopping(patience=<span class="hljs-number">3</span>, verbose=<span class="hljs-number">1</span>),
      ModelCheckpoint(<span class="hljs-string">&apos;checkpoints/yolov3_train_{epoch}.tf&apos;</span>,
                      verbose=<span class="hljs-number">1</span>, save_weights_only=<span class="hljs-keyword">True</span>),
      TensorBoard(log_dir=<span class="hljs-string">&apos;logs&apos;</span>)
    ]

      history = model.fit(train_dataset,
                          epochs=args.epochs,
                          callbacks=callbacks,
                          validation_data=val_dataset)
</code></pre>
<h4 id="1&#x3001;earlystopping">1&#x3001;EarlyStopping</h4>
<ul>
<li>keras.callbacks.EarlyStopping(monitor=&apos;val_loss&apos;, patience=0, verbose=0, mode=&apos;auto&apos;)</li>
</ul>
<p>&#x5F53;&#x76D1;&#x6D4B;&#x503C;&#x4E0D;&#x518D;&#x6539;&#x5584;&#x65F6;&#xFF0C;&#x8BE5;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5C06;&#x4E2D;&#x6B62;&#x8BAD;&#x7EC3;</p>
<ul>
<li>&#x53C2;&#x6570;<ul>
<li>monitor&#xFF1A;&#x9700;&#x8981;&#x76D1;&#x89C6;&#x7684;&#x91CF;</li>
<li>patience&#xFF1A;&#x5F53;early stop&#x88AB;&#x6FC0;&#x6D3B;&#xFF08;&#x5982;&#x53D1;&#x73B0;loss&#x76F8;&#x6BD4;&#x4E0A;&#x4E00;&#x4E2A;epoch&#x8BAD;&#x7EC3;&#x6CA1;&#x6709;&#x4E0B;&#x964D;&#xFF09;&#xFF0C;&#x5219;&#x7ECF;&#x8FC7;<code>patience</code>&#x4E2A;epoch&#x540E;&#x505C;&#x6B62;&#x8BAD;&#x7EC3;&#x3002;</li>
<li>verbose&#xFF1A;&#x4FE1;&#x606F;&#x5C55;&#x793A;&#x6A21;&#x5F0F;</li>
<li>mode&#xFF1A;&#x2018;auto&#x2019;&#xFF0C;&#x2018;min&#x2019;&#xFF0C;&#x2018;max&#x2019;&#x4E4B;&#x4E00;&#xFF0C;&#x5728;<code>min</code>&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x68C0;&#x6D4B;&#x503C;&#x505C;&#x6B62;&#x4E0B;&#x964D;&#x5219;&#x4E2D;&#x6B62;&#x8BAD;&#x7EC3;&#x3002;&#x5728;<code>max</code>&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x5F53;&#x68C0;&#x6D4B;&#x503C;&#x4E0D;&#x518D;&#x4E0A;&#x5347;&#x5219;&#x505C;&#x6B62;&#x8BAD;&#x7EC3;&#x3002;</li>
</ul>
</li>
</ul>
<h3 id="5112-&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;">5.11.2 &#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;</h3>
<ul>
<li>&#x6B65;&#x9AA4;<ul>
<li>1&#x3001;&#x521D;&#x59CB;&#x5316;&#x6A21;&#x578B;&#x5E76;&#x52A0;&#x8F7D;&#x6743;&#x91CD;</li>
<li>2&#x3001;&#x52A0;&#x8F7D;&#x56FE;&#x7247;&#x5904;&#x7406;&#x56FE;&#x7247;&#x5E76;&#x4F7F;&#x7528;&#x6A21;&#x578B;&#x8FDB;&#x884C;&#x9884;&#x6D4B;</li>
<li>3&#x3001;&#x5C06;&#x56FE;&#x7247;&#x6846;&#x753B;&#x5728;&#x56FE;&#x7247;&#x4E2D;&#x5E76;&#x8FDB;&#x884C;&#x4FDD;&#x5B58;</li>
</ul>
</li>
</ul>
<p>&#x5BFC;&#x5165;&#x5305;&#x5E76;&#x5236;&#x5B9A;&#x76F8;&#x5173;&#x53C2;&#x6570;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">import</span> os
os.environ[<span class="hljs-string">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span>] = <span class="hljs-string">&quot;2&quot;</span>

<span class="hljs-keyword">from</span> yolov3_tf2.models <span class="hljs-keyword">import</span> (
    YoloV3, YoloV3Tiny
)
<span class="hljs-keyword">from</span> yolov3_tf2.dataset <span class="hljs-keyword">import</span> transform_images
<span class="hljs-keyword">from</span> yolov3_tf2.utils <span class="hljs-keyword">import</span> draw_outputs
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> sys

parser = argparse.ArgumentParser()
parser.add_argument(<span class="hljs-string">&apos;--classes&apos;</span>, type=str, default=<span class="hljs-string">&apos;./data/kitti.names&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x7C7B;&#x522B;&#x914D;&#x7F6E;&#x8DEF;&#x5F84;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--weights&apos;</span>, type=str, default=<span class="hljs-string">&apos;./checkpoints/yolov3_train_1.tf&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x8BAD;&#x7EC3;&#x597D;&#x7684;&#x6A21;&#x578B;&#x4F4D;&#x7F6E;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--tiny&apos;</span>, type=bool, default=<span class="hljs-keyword">False</span>, help=<span class="hljs-string">&apos;&#x52A0;&#x8F7D;&#x7684;&#x6A21;&#x578B;&#x7C7B;&#x578B;yolov3 or yolov3-tiny&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--size&apos;</span>, type=int, default=<span class="hljs-number">416</span>,
                    help=<span class="hljs-string">&apos;&#x56FE;&#x7247;&#x5927;&#x5C0F;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--image&apos;</span>, type=str, default=<span class="hljs-string">&apos;./data/kitti/data_object_image_2/testing/image_2/000008.png&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x8F93;&#x5165;&#x9884;&#x6D4B;&#x56FE;&#x7247;&#x7684;&#x4F4D;&#x7F6E;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--output&apos;</span>, type=str, default=<span class="hljs-string">&apos;./output.jpg&apos;</span>,
                    help=<span class="hljs-string">&apos;&#x8F93;&#x51FA;&#x56FE;&#x7247;&#x7ED3;&#x679C;&#x7684;&#x4F4D;&#x7F6E;&apos;</span>)
parser.add_argument(<span class="hljs-string">&apos;--num_classes&apos;</span>, type=int, default=<span class="hljs-number">6</span>,
                    help=<span class="hljs-string">&apos;&#x603B;&#x5171;&#x7C7B;&#x522B;&#x6570;&#x91CF;&apos;</span>)
</code></pre>
<p>&#x6574;&#x4F53;&#x8FC7;&#x7A0B;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(args)</span>:</span>
    <span class="hljs-comment"># 1&#x3001;&#x521D;&#x59CB;&#x5316;&#x6A21;&#x578B;&#x5E76;&#x52A0;&#x8F7D;&#x6743;&#x91CD;</span>
    <span class="hljs-keyword">if</span> args.tiny:
        yolo = YoloV3Tiny(classes=args.num_classes)
    <span class="hljs-keyword">else</span>:
        yolo = YoloV3(classes=args.num_classes)

    yolo.load_weights(args.weights)
    logging.info(<span class="hljs-string">&apos;&#x52A0;&#x8F7D;&#x6A21;&#x578B;&#x6743;&#x91CD;weights&apos;</span>)

    <span class="hljs-comment"># &#x52A0;&#x8F7D;&#x76EE;&#x6807;&#x7C7B;&#x578B;</span>
    class_names = [c.strip() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> open(args.classes).readlines()]

    <span class="hljs-comment"># 2&#x3001;&#x52A0;&#x8F7D;&#x56FE;&#x7247;&#x5904;&#x7406;&#x56FE;&#x7247;&#x5E76;&#x4F7F;&#x7528;&#x6A21;&#x578B;&#x8FDB;&#x884C;&#x9884;&#x6D4B;</span>
    img = tf.image.decode_image(open(args.image, <span class="hljs-string">&apos;rb&apos;</span>).read(), channels=<span class="hljs-number">3</span>)
    img = tf.expand_dims(img, <span class="hljs-number">0</span>)
    img = transform_images(img, args.size)

    <span class="hljs-comment"># &#x8BB0;&#x5F55;&#x65F6;&#x95F4;</span>
    t1 = time.time()
    boxes, scores, classes, nums = yolo(img)
    t2 = time.time()
    logging.info(<span class="hljs-string">&apos;&#x8017;&#x65F6;: {}&apos;</span>.format(t2 - t1))

    logging.info(<span class="hljs-string">&apos;&#x68C0;&#x6D4B;&#x7ED3;&#x679C;:&apos;</span>)
    print(boxes, scores, classes, nums)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(nums[<span class="hljs-number">0</span>]):
        logging.info(<span class="hljs-string">&apos;\t{}, {}, {}&apos;</span>.format(class_names[int(classes[<span class="hljs-number">0</span>][i])],
                                           np.array(scores[<span class="hljs-number">0</span>][i]),
                                           np.array(boxes[<span class="hljs-number">0</span>][i])))
    <span class="hljs-comment"># 3&#x3001;&#x663E;&#x793A;&#x56FE;&#x7247;&#x5E76;&#x5C06;&#x56FE;&#x7247;&#x6846;&#x753B;&#x51FA;</span>
    img = cv2.imread(args.image)
    img = draw_outputs(img, (boxes, scores, classes, nums), class_names)
    cv2.imwrite(args.output, img)
    logging.info(<span class="hljs-string">&apos;output saved to: {}&apos;</span>.format(args.output))


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:
    args = parser.parse_args(sys.argv[<span class="hljs-number">1</span>:])
    main(args)
</code></pre>
<p>&#x5176;&#x4E2D;&#x7528;&#x5230;&#x51E0;&#x4E2A;YOLO&#x6E90;&#x7801;&#x5B9E;&#x73B0;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF08;&#x65E0;&#x9700;&#x5B9E;&#x73B0;&#xFF0C;&#x5177;&#x4F53;&#x53C2;&#x8003;&#x6E90;&#x4EE3;&#x7801;&#xFF09;</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> yolov3_tf2.dataset <span class="hljs-keyword">import</span> transform_images
<span class="hljs-keyword">from</span> yolov3_tf2.utils <span class="hljs-keyword">import</span> draw_outputs
</code></pre>
<ul>
<li>&#x9884;&#x5904;&#x7406;&#x5927;&#x5C0F;&#x548C;&#x5F52;&#x4E00;&#x5316;&#x51FD;&#x6570;</li>
</ul>
<pre><code>def transform_images(x_train, size):
    x_train = tf.image.resize(x_train, (size, size))
    x_train = x_train / 255
    return x_train
</code></pre><ul>
<li>draw_outputs</li>
</ul>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draw_outputs</span><span class="hljs-params">(img, outputs, class_names)</span>:</span>
    boxes, objectness, classes, nums = outputs
    boxes, objectness, classes, nums = boxes[<span class="hljs-number">0</span>], objectness[<span class="hljs-number">0</span>], classes[<span class="hljs-number">0</span>], nums[<span class="hljs-number">0</span>]
    wh = np.flip(img.shape[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>])
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(nums):
        x1y1 = tuple((np.array(boxes[i][<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]) * wh).astype(np.int32))
        x2y2 = tuple((np.array(boxes[i][<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]) * wh).astype(np.int32))
        img = cv2.rectangle(img, x1y1, x2y2, (<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">2</span>)
        img = cv2.putText(img, <span class="hljs-string">&apos;{} {:.4f}&apos;</span>.format(
            class_names[int(classes[i])], objectness[i]),
            x1y1, cv2.FONT_HERSHEY_COMPLEX_SMALL, <span class="hljs-number">1</span>, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>), <span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> img
</code></pre>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x770B;&#x4E0D;&#x5230;&#x7ED3;&#x679C;&#xFF0C;&#x8BF4;&#x660E;&#x9884;&#x6D4B;&#x7684;&#x7ED3;&#x679C;&#x90FD;&#x4E0D;&#x597D;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x5728;&#x6A21;&#x578B;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x4FEE;&#x6539;iou&#x548C;&#x5206;&#x6570;&#x7684;&#x9608;&#x503C;&#x6765;&#x8FDB;&#x884C;&#x8C03;&#x6574;&#xFF08;&#x6839;&#x636E;&#x5B9E;&#x9645;&#x9700;&#x6C42;&#xFF09;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_nms</span><span class="hljs-params">(outputs, anchors, masks, classes)</span>:</span>
    <span class="hljs-comment"># boxes, conf, type</span>
    b, c, t = [], [], []

    <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> outputs:
        b.append(tf.reshape(o[<span class="hljs-number">0</span>], (tf.shape(o[<span class="hljs-number">0</span>])[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>, tf.shape(o[<span class="hljs-number">0</span>])[-<span class="hljs-number">1</span>])))
        c.append(tf.reshape(o[<span class="hljs-number">1</span>], (tf.shape(o[<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>, tf.shape(o[<span class="hljs-number">1</span>])[-<span class="hljs-number">1</span>])))
        t.append(tf.reshape(o[<span class="hljs-number">2</span>], (tf.shape(o[<span class="hljs-number">2</span>])[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>, tf.shape(o[<span class="hljs-number">2</span>])[-<span class="hljs-number">1</span>])))

    bbox = tf.concat(b, axis=<span class="hljs-number">1</span>)
    confidence = tf.concat(c, axis=<span class="hljs-number">1</span>)
    class_probs = tf.concat(t, axis=<span class="hljs-number">1</span>)

    scores = confidence * class_probs
    boxes, scores, classes, valid_detections = tf.image.combined_non_max_suppression(
        boxes=tf.reshape(bbox, (tf.shape(bbox)[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>)),
        scores=tf.reshape(
            scores, (tf.shape(scores)[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>, tf.shape(scores)[-<span class="hljs-number">1</span>])),
        max_output_size_per_class=<span class="hljs-number">100</span>,
        max_total_size=<span class="hljs-number">100</span>,
        iou_threshold=<span class="hljs-number">0.5</span>,
        score_threshold=<span class="hljs-number">0.5</span>
    )

    <span class="hljs-keyword">return</span> boxes, scores, classes, valid_detections
</code></pre>
<h3 id="5113-&#x5C0F;&#x7ED3;">5.11.3 &#x5C0F;&#x7ED3;</h3>
<ul>
<li>&#x5B8C;&#x6210;KITTI&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8BAD;&#x7EC3;&#x548C;&#x68C0;&#x6D4B;&#x8FC7;&#x7A0B;</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../objectdection/section10.html" class="navigation navigation-prev " aria-label="Previous page: 案例：KITTI人、车检测案例-数据集处理"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../imageSegmentation/index.html" class="navigation navigation-next " aria-label="Next page: 目标分割(Object Segmentation)"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-splitter/splitter.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"expandable-chapters":{},"katex":{},"splitter":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
