<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>规则过滤器 | 泛娱乐推荐系统项目课程定位、目标</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-katex/katex.min.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../day01/section6.html" />
    
    
    <link rel="prev" href="../day01/section4.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.5"
        data-chapter-title="规则过滤器"
        data-filepath="day01/section5.md"
        data-basepath=".."
        data-revision="Sun Sep 08 2019 21:30:18 GMT+0800 (CST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        泛娱乐推荐系统项目
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="reco/index.html">
            
                
                    <a href="../reco/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        泛娱乐推荐介绍
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="reco/section1.html">
            
                
                    <a href="../reco/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        产品概述
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="reco/section2.html">
            
                
                    <a href="../reco/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        推荐系统流程概述
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="reco/section3.html">
            
                
                    <a href="../reco/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        开发环境介绍
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="day01/index.html">
            
                
                    <a href="../day01/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        召回模块
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="day01/section1.html">
            
                
                    <a href="../day01/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Web接口业务介绍
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="day01/section2.html">
            
                
                    <a href="../day01/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        构建双画像
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="day01/section3.html">
            
                
                    <a href="../day01/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        多召回策略
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="day01/section4.html">
            
                
                    <a href="../day01/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        召回金字塔
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.5" data-path="day01/section5.html">
            
                
                    <a href="../day01/section5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        规则过滤器
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="day01/section6.html">
            
                
                    <a href="../day01/section6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        用户推荐逻辑完善
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="day02/index.html">
            
                
                    <a href="../day02/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        排序模块
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="day02/section1.html">
            
                
                    <a href="../day02/section1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        模型选择与原理讲解
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="day02/section2.html">
            
                
                    <a href="../day02/section2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        泛娱乐特征工程与模型代码构建
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="day02/section3.html">
            
                
                    <a href="../day02/section3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        GCP模型训练与超参数调优
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="day02/section4.html">
            
                
                    <a href="../day02/section4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        GCP模型预测与部署
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >泛娱乐推荐系统项目课程定位、目标</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="25-&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;">2.5 &#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;</h1>
<h2 id="&#x5B66;&#x4E60;&#x76EE;&#x6807;">&#x5B66;&#x4E60;&#x76EE;&#x6807;</h2>
<ul>
<li>&#x76EE;&#x6807;<ul>
<li>&#x4E86;&#x89E3;&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x4F5C;&#x7528;</li>
</ul>
</li>
<li>&#x5E94;&#x7528;<ul>
<li>&#x65E0;</li>
</ul>
</li>
</ul>
<h3 id="251-&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;">2.5.1 &#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;</h3>
<ul>
<li>&#x4EC0;&#x4E48;&#x662F;&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;: <strong>&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x63A8;&#x8350;&#x5185;&#x5BB9;&#x7684;&#x591A;&#x6837;&#x6027;, &#x5408;&#x7406;&#x6027;, &#x6BCF;&#x6B21;&#x7684;&#x63A8;&#x8350;&#x5185;&#x5BB9;&#x4F1A;&#x5728;&#x5185;&#x90E8;&#x548C;&#x4E0A;&#x6B21;&#x6570;&#x636E;&#x95F4;&#x505A;&#x4E00;&#x4E9B;&#x6BD4;&#x8F83;&#x548C;&#x8FC7;&#x6EE4;&#x64CD;&#x4F5C;</strong></li>
<li>&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;&#x4F5C;&#x7528;&#xFF1A;&#x9632;&#x6B62;&#x63A8;&#x8350;&#x6570;&#x636E;&#x91CD;&#x590D;, &#x5E76;&#x53EF;&#x6309;&#x7167;&#x6307;&#x5B9A;&#x89C4;&#x5219;&#x9009;&#x62E9;&#x6027;&#x63A8;&#x8350;&#xFF0C;&#x8FC7;&#x6EE4;&#x6389;&#x4E0D;&#x540C;&#x7528;&#x6237;&#x53D1;&#x8868;&#x7684;&#x76F8;&#x540C;&#x7684;&#x5E16;&#x5B50;(&#x5E16;&#x5B50;ID&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5185;&#x5BB9;&#x76F8;&#x4F3C;&#x6216;&#x8005;&#x76F8;&#x540C;)<ul>
<li>&#x5982;&#x4F55;&#x6BD4;&#x8F83;&#x63A8;&#x8350;&#x51FA;&#x53BB;&#x7684;&#x4E24;&#x4E2A;pid&#x5185;&#x5BB9;&#x76F8;&#x540C;&#xFF1F;</li>
</ul>
</li>
</ul>
<p>&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;&#x4E3B;&#x4F53;&#x51FD;&#x6570;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> cv2

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rfilter</span><span class="hljs-params">(r_data)</span>:</span>
    <span class="hljs-keyword">with</span> _driver.session() <span class="hljs-keyword">as</span> session:
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_url</span><span class="hljs-params">(pid)</span>:</span>
            cypher = <span class="hljs-string">&quot;match(a:SuperfansPost{pid:%d}) return a.iv_url&quot;</span> % (pid)
            record = session.run(cypher)
            result = list(map(<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>], record))
            <span class="hljs-keyword">if</span> result:
                <span class="hljs-keyword">return</span> result[<span class="hljs-number">0</span>]
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6240;&#x6709;&#x8981;&#x63A8;&#x8350;&#x7684;&#x56FE;&#x7247;url&#x5E16;&#x5B50;&#x5730;&#x5740;</span>
        url_list = list(
            filter(
                <span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>, map(
                    <span class="hljs-keyword">lambda</span> x: get_url(x), r_data)))
        <span class="hljs-comment"># 1&#x3001;&#x5E16;&#x5B50;PID&#x4E0E;&#x56FE;&#x7247;&#x5730;&#x5740;&#x7ED1;&#x5B9A;</span>
    url_dict = dict(zip(url_list, r_data))
    <span class="hljs-comment"># 2&#x3001;&#x53BB;&#x91CD;&#x51FD;&#x6570;</span>
    url_list = d_hash_serve(url_list)
    <span class="hljs-comment"># 3&#x3001;&#x5C06;&#x53BB;&#x91CD;&#x4E4B;&#x540E;&#x7684;url&#x548C;PID&#x53D6;&#x51FA;&#x7ED3;&#x679C;&#x4F20;&#x5165;&#x6392;&#x5E8F;&#x6A21;&#x5757;</span>
    result = list(map(<span class="hljs-keyword">lambda</span> x: url_dict[x], url_list))
    <span class="hljs-keyword">return</span> result
</code></pre>
<p>&#x90A3;&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x53BB;&#x91CD;&#xFF0C;&#x5206;&#x6790;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>1&#x3001;&#x4E0B;&#x8F7D;&#x6240;&#x6709;&#x56FE;&#x7247;&#x5230;&#x672C;&#x5730;&#xFF0C;&#x4FDD;&#x7559;&#x56FE;&#x7247;&#x8DEF;&#x5F84;&#x5217;&#x8868;</li>
<li>2&#x3001;&#x5FAA;&#x73AF;&#x6240;&#x6709;&#x56FE;&#x7247;&#x5217;&#x8868;&#xFF0C;&#x4E24;&#x4E24;&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;<ul>
<li>&#x901A;&#x8FC7;opencv&#x5C06;&#x4E24;&#x4E2A;&#x56FE;&#x7247;&#x7684;&#x6307;&#x7EB9;&#x8FDB;&#x884C;&#x6C49;&#x660E;&#x8DDD;&#x79BB;&#x6BD4;&#x8F83;</li>
</ul>
</li>
</ul>
<p>&#x6BD4;&#x8F83;&#x56FE;&#x7247;&#x76F8;&#x540C;&#x65B9;&#x5F0F;&#xFF0C;&#x83B7;&#x53D6;&#x5E16;&#x5B50;&#x7684;&#x56FE;&#x7247;&#x5730;&#x5740;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x76F8;&#x4F3C;&#x5EA6;&#x8BA1;&#x7B97;&#xFF1A;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">d_hash_serve</span><span class="hljs-params">(url_list)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;&#x53BB;&#x91CD;&#x51FD;&#x6570;&#x903B;&#x8F91;
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># &#x4E0B;&#x8F7D;&#x6240;&#x6709;&#x56FE;&#x7247;</span>
    default_image = <span class="hljs-string">&quot;test.png&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span><span class="hljs-params">(url)</span>:</span>
        path = <span class="hljs-string">&quot;./recomm/img_compare/&quot;</span>
        <span class="hljs-keyword">try</span>:
            img = requests.get(url)
            <span class="hljs-keyword">with</span> open(path + url + <span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> fp:
                fp.write(img.text)
            <span class="hljs-keyword">return</span> path + url + <span class="hljs-string">&quot;.jpg&quot;</span>
        <span class="hljs-keyword">except</span> BaseException:
            <span class="hljs-keyword">return</span> path + default_image

    <span class="hljs-comment"># 1&#x3001;&#x5F97;&#x5230;&#x4E0B;&#x8F7D;&#x5230;&#x672C;&#x5730;&#x4E4B;&#x540E;&#x7684;&#x56FE;&#x7247;&#x5217;&#x8868;</span>
    url_path = list(map(<span class="hljs-keyword">lambda</span> url: download(url), url_list))

    <span class="hljs-comment"># 2&#x3001;&#x5F97;&#x5230;&#x672C;&#x5730;&#x8DEF;&#x5F84;&#x4E0E;CDN&#x8DEF;&#x5F84;&#x7684;&#x5BF9;&#x5E94;&#x5B57;&#x5178;</span>
    url_dict = dict(zip(url_path, url_list))

    <span class="hljs-comment"># 3&#x3001;compare_img&#x51FD;&#x6570;&#x5BF9;&#x8BE5;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x56FE;&#x7247;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;</span>
    compare_list = compare_img(path)

    <span class="hljs-comment"># 4&#x3001;&#x83B7;&#x5F97;&#x6BD4;&#x8F83;&#x4E4B;&#x540E;&#x5E94;&#x8BE5;&#x5220;&#x9664;&#x7684;&#x91CD;&#x590D;&#x56FE;&#x7247;CDN&#x8DEF;&#x5F84;</span>
    compared_delete_list = list(
        map(<span class="hljs-keyword">lambda</span> x: url_dict[x], list(set(compare_list[::<span class="hljs-number">2</span>]))))

    <span class="hljs-comment"># 5&#x3001;&#x6839;&#x636E;CDN&#x8DEF;&#x5F84;&#x8FDB;&#x884C;&#x5217;&#x8868;&#x5143;&#x7D20;&#x5220;&#x9664;</span>
    list(map(<span class="hljs-keyword">lambda</span> x: url_list.remove(x), compared_delete_list))

    <span class="hljs-keyword">return</span> url_list


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_img</span><span class="hljs-params">(root_path)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x6BD4;&#x8F83;&#x56FE;&#x7247; (Main)
    :param root_path: &#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;
    &quot;&quot;&quot;</span>
    compared_list = []
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x6240;&#x6709;&#x56FE;&#x7247;&#x8DEF;&#x5F84;&#x96C6;&#x5408;</span>
    img_list = get_all_img_list(root_path)
    <span class="hljs-comment"># &#x904D;&#x5386;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x6240;&#x6709;&#x56FE;&#x7247;&#x8FDB;&#x884C;&#x4E24;&#x4E24;&#x6BD4;&#x8F83;</span>
    <span class="hljs-keyword">for</span> file1 <span class="hljs-keyword">in</span> img_list:
        <span class="hljs-comment"># &#x5DF2;&#x7ECF;&#x53D1;&#x73B0;&#x662F;&#x76F8;&#x540C;&#x7684;&#x56FE;&#x7247;&#x4E0D;&#x518D;&#x6BD4;&#x8F83;</span>
        <span class="hljs-keyword">if</span> file1 <span class="hljs-keyword">in</span> compared_list:
            <span class="hljs-keyword">continue</span>
        im1 = cv2.imdecode(
            np.fromfile(
                file1,
                dtype=np.uint8),
            cv2.IMREAD_UNCHANGED)
        print(im1)
        <span class="hljs-keyword">if</span> im1 <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            <span class="hljs-keyword">continue</span>
        im1_size = os.path.getsize(file1)
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x56FE;&#x7247;&#x6307;&#x7EB9;</span>
        img_fingerprints1 = get_img_gray_bit(im1)
        print(<span class="hljs-string">&quot;&#x7B2C;&#x4E00;&#x5F20;&#x7684;&#x6307;&#x7EB9;:&quot;</span>, img_fingerprints1)
        <span class="hljs-keyword">for</span> file2 <span class="hljs-keyword">in</span> img_list:
            <span class="hljs-keyword">if</span> file1 != file2:
                <span class="hljs-comment"># im2 = cv2.imread(files2)</span>
                im2 = cv2.imdecode(
                    np.fromfile(
                        file2,
                        dtype=np.uint8),
                    cv2.IMREAD_UNCHANGED)
                <span class="hljs-keyword">if</span> im2 <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
                    <span class="hljs-keyword">continue</span>
                im2_size = os.path.getsize(file2)
                print(im2_size)
                <span class="hljs-comment"># &#x5982;&#x679C;&#x4E24;&#x5F20;&#x56FE;&#x7247;&#x5B57;&#x8282;&#x6570;&#x5927;&#x5C0F;&#x4E00;&#x6837;&#x518D;&#x5224;&#x65AD;&#x6C49;&#x660E;&#x8DDD;&#x79BB;</span>
                <span class="hljs-keyword">if</span> im1_size != im2_size:
                    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x56FE;&#x7247;&#x6307;&#x7EB9;</span>
                    img_fingerprints2 = get_img_gray_bit(im2)
                    print(<span class="hljs-string">&quot;&#x7B2C;&#x4E8C;&#x5F20;&#x7684;&#x6307;&#x7EB9;:&quot;</span>, img_fingerprints2)
                    compare_result = get_mh(
                        img_fingerprints1, img_fingerprints2)
                    print(compare_result)
                    <span class="hljs-comment"># &#x6C49;&#x660E;&#x8DDD;&#x79BB;&#x7B49;&#x4E8E;0&#xFF0C;&#x8BF4;&#x660E;&#x4E24;&#x5F20;&#x56FE;&#x7247;&#x5B8C;&#x5168;&#x4E00;&#x6837;</span>
                    <span class="hljs-keyword">if</span> compare_result == <span class="hljs-number">0</span>:

                        compared_list.append(file2)
                        compared_list.append(file1)
    <span class="hljs-keyword">return</span> compared_list


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_img_list</span><span class="hljs-params">(root_path)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x83B7;&#x53D6;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x6240;&#x6709;&#x56FE;&#x7247;&#x8DEF;&#x5F84;&#x96C6;&#x5408;
    :param root_path: &#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;
    :return: &#x56FE;&#x7247;&#x96C6;&#x5408;
    &quot;&quot;&quot;</span>
    img_list = []
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x6240;&#x6709;&#x5143;&#x7EC4;</span>
    root = os.walk(root_path)
    <span class="hljs-comment"># &#x5FAA;&#x73AF;&#x5143;&#x7EC4;&#xFF0C;&#x83B7;&#x53D6;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x5939;&#x4E0B;&#x6240;&#x6709;&#x56FE;&#x7247;&#x8DEF;&#x5F84;&#x96C6;&#x5408;</span>
    <span class="hljs-keyword">for</span> objects <span class="hljs-keyword">in</span> root:
        <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> objects:
            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> str(obj):
                <span class="hljs-comment"># &#x8BB0;&#x5F55;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span>
                path = str(obj)
            <span class="hljs-keyword">elif</span> len(obj) &gt; <span class="hljs-number">0</span>:
                <span class="hljs-comment"># &#x5982;&#x679C;&#x662F;&#x6587;&#x4EF6;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x56FE;&#x7247;&#x3002;&#x5982;&#x679C;&#x662F;&#x56FE;&#x7247;&#x5219;&#x4FDD;&#x5B58;&#x8FDB;</span>
                <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> obj:
                    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;.&quot;</span> <span class="hljs-keyword">in</span> str(file) <span class="hljs-keyword">and</span> is_image_file(file) == <span class="hljs-number">1</span>:
                        full_path = path + <span class="hljs-string">&quot;/&quot;</span> + str(file)
                        img_list.append(full_path.replace(<span class="hljs-string">&quot;\\&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>))
    <span class="hljs-keyword">return</span> img_list


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_img_gray_bit</span><span class="hljs-params">(img, resize=<span class="hljs-params">(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>)</span>)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x83B7;&#x53D6;&#x56FE;&#x7247;&#x6307;&#x7EB9;
    :param img: &#x56FE;&#x7247;
    :param resize: Resize&#x7684;&#x56FE;&#x7247;&#x5927;&#x5C0F;
    :return: &#x56FE;&#x7247;&#x6307;&#x7EB9;
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># &#x4FEE;&#x6539;&#x56FE;&#x7247;&#x5927;&#x5C0F;</span>
    image_resize = cv2.resize(img, resize, interpolation=cv2.INTER_CUBIC)
    <span class="hljs-comment"># &#x4FEE;&#x6539;&#x56FE;&#x7247;&#x6210;&#x7070;&#x5EA6;&#x56FE;</span>
    image_gray = cv2.cvtColor(image_resize, cv2.COLOR_BGR2GRAY)
    <span class="hljs-comment"># &#x8F6C;&#x6362;&#x7070;&#x5EA6;&#x56FE;&#x6210;&#x6D6E;&#x70B9;&#x578B;</span>
    image_gray_f = np.float32(image_gray)
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x7070;&#x5EA6;&#x56FE;&#x7684;DCT&#x96C6;&#x5408;</span>
    image_gray_dct = cv2.dct(image_gray_f)
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x7070;&#x5EA6;&#x56FE;DCT&#x96C6;&#x5408;&#x7684;&#x5DE6;&#x4E0A;&#x89D2;8*8</span>
    <span class="hljs-comment"># gray_dct_ul64_list = get_gray_dct_ul64_list(image_gray_dct)</span>
    gray_dct_ul64_list = image_gray_dct[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>, <span class="hljs-number">0</span>:<span class="hljs-number">8</span>]
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x7070;&#x5EA6;&#x56FE;DCT&#x96C6;&#x5408;&#x7684;&#x5DE6;&#x4E0A;&#x89D2;8*8&#x5BF9;&#x5E94;&#x7684;&#x5E73;&#x5747;&#x503C;</span>
    <span class="hljs-comment"># gray_dct_ul64_avg = get_gray_dct_ul64_avg(gray_dct_ul64_list)</span>
    gray_dct_ul64_avg = cv2.mean(gray_dct_ul64_list)
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x56FE;&#x7247;&#x6307;&#x7EB9;</span>
    img_fingerprints = get_img_fingerprints(
        gray_dct_ul64_list, gray_dct_ul64_avg)
    <span class="hljs-keyword">return</span> img_fingerprints


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_img_fingerprints</span><span class="hljs-params">(gray_dct_ul64_list, gray_dct_ul64_avg)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x83B7;&#x53D6;&#x56FE;&#x7247;&#x6307;&#x7EB9;&#xFF1A;&#x904D;&#x5386;&#x7070;&#x5EA6;&#x56FE;&#x5DE6;&#x4E0A;8*8&#x7684;&#x6240;&#x6709;&#x50CF;&#x7D20;&#xFF0C;&#x6BD4;&#x5E73;&#x5747;&#x503C;&#x5927;&#x5219;&#x8BB0;&#x5F55;&#x4E3A;1&#xFF0C;&#x5426;&#x5219;&#x8BB0;&#x5F55;&#x4E3A;0&#x3002;
    :param gray_dct_ul64_list: &#x7070;&#x5EA6;&#x56FE;&#x5DE6;&#x4E0A;8*8&#x7684;&#x6240;&#x6709;&#x50CF;&#x7D20;
    :param gray_dct_ul64_avg: &#x7070;&#x5EA6;&#x56FE;&#x5DE6;&#x4E0A;8*8&#x7684;&#x6240;&#x6709;&#x50CF;&#x7D20;&#x5E73;&#x5747;&#x503C;
    :return: &#x56FE;&#x7247;&#x6307;&#x7EB9;
    &quot;&quot;&quot;</span>
    img_fingerprints = <span class="hljs-string">&apos;&apos;</span>
    avg = gray_dct_ul64_avg[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
            <span class="hljs-keyword">if</span> gray_dct_ul64_list[i][j] &gt; avg:
                img_fingerprints += <span class="hljs-string">&apos;1&apos;</span>
            <span class="hljs-keyword">else</span>:
                img_fingerprints += <span class="hljs-string">&apos;0&apos;</span>
    <span class="hljs-keyword">return</span> img_fingerprints


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_mh</span><span class="hljs-params">(img_fingerprints1, img_fingerprints2)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x83B7;&#x53D6;&#x6C49;&#x660E;&#x8DDD;&#x79BB;
    :param img_fingerprints1: &#x6BD4;&#x8F83;&#x5BF9;&#x8C61;1&#x7684;&#x6307;&#x7EB9;
    :param img_fingerprints2: &#x6BD4;&#x8F83;&#x5BF9;&#x8C61;2&#x7684;&#x6307;&#x7EB9;
    :return: &#x6C49;&#x660E;&#x8DDD;&#x79BB;
    &quot;&quot;&quot;</span>
    hm = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(img_fingerprints1)):
        <span class="hljs-keyword">if</span> img_fingerprints1[i] != img_fingerprints2[i]:
            hm += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> hm


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_image_file</span><span class="hljs-params">(file_name)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    &#x5224;&#x65AD;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x662F;&#x56FE;&#x7247;
    :param file_name: &#x6587;&#x4EF6;&#x540D;&#x79F0;(&#x5305;&#x542B;&#x540E;&#x7F00;&#x4FE1;&#x606F;)
    :return: 1:&#x56FE;&#x7247;&#xFF0C;0:&#x975E;&#x56FE;&#x7247;
    &quot;&quot;&quot;</span>
    ext = (os.path.splitext(file_name)[<span class="hljs-number">1</span>]).lower()
    <span class="hljs-keyword">if</span> ext == <span class="hljs-string">&quot;.jpg&quot;</span> <span class="hljs-keyword">or</span> ext == <span class="hljs-string">&quot;.jpeg&quot;</span> <span class="hljs-keyword">or</span> ext == <span class="hljs-string">&quot;.bmp&quot;</span> <span class="hljs-keyword">or</span> ext == <span class="hljs-string">&quot;.png&quot;</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
</code></pre>
<p>&#x5728;_get_recomm&#x51FD;&#x6570;&#x4E2D;&#x52A0;&#x5165;&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_recomm</span><span class="hljs-params">(IP, uid)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;&#x6574;&#x4F53;&#x63A8;&#x8350;&#x6D41;&#x7A0B;
    :param IP: &#x7528;&#x6237;&#x7684;IP
    :param uid: &#x7528;&#x6237;ID
    :return:
    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># 1&#x3001;&#x53EC;&#x56DE;&#x7684;&#x6A21;&#x5757;&#x63A5;&#x53E3;&#x5B9E;&#x73B0;</span>
    hot_data = _get_hot()
    last_data = get_last()
    v_data = get_v()
    r_data = get_r(uid)
    random_data = get_random()
    <span class="hljs-comment"># &#x5408;&#x5E76;&#x53EC;&#x56DE;&#x7ED3;&#x679C;</span>
    all_data = [hot_data] + [last_data] + [v_data] + [r_data] + [random_data]
    <span class="hljs-comment"># &#x91D1;&#x5B57;&#x5854;&#x7ED3;&#x6784;&#x5B9E;&#x73B0;&#xFF0C;&#x7ED9;PID&#x5206;&#x914D;&#x6743;&#x91CD;&#x6392;&#x5E8F;&#x8F93;&#x51FA;pid</span>
    j_data = pyramid_array(all_data)
    <span class="hljs-comment"># &#x5C06;&#x6570;&#x636E;&#x5199;&#x5165;&#x91D1;&#x5B57;&#x5854;&#x7F13;&#x5B58;</span>
    r_data = j_data_write(uid, j_data)
    <span class="hljs-comment"># &#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;</span>
    f_data = rfilter(r_data)

    <span class="hljs-keyword">return</span> r_data
</code></pre>
<h3 id="252-&#x603B;&#x7ED3;">2.5.2 &#x603B;&#x7ED3;</h3>
<ul>
<li>&#x4E86;&#x89E3;&#x89C4;&#x5219;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x4F5C;&#x7528;&#x548C;&#x5B9E;&#x73B0;</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../day01/section4.html" class="navigation navigation-prev " aria-label="Previous page: 召回金字塔"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../day01/section6.html" class="navigation navigation-next " aria-label="Next page: 用户推荐逻辑完善"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"katex":{},"expandable-chapters-small":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"livereload":{}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
