# 2.2 æ³›å¨±ä¹ç”»åƒå›¾è°±å­˜å‚¨

## å­¦ä¹ ç›®æ ‡

- ç›®æ ‡
  - çŸ¥é“åŒç”»åƒçš„è®¾è®¡
- åº”ç”¨
  - åº”ç”¨å®Œæˆç”¨æˆ·ä¸å¸–å­æ ‡ç­¾çš„æ•°æ®åº“å¯¼å…¥

### 2.2.1 ç”»åƒå›¾è°±å­˜å‚¨

å‰é¢ä»‹ç»çš„Webä¸šåŠ¡å½“ä¸­ï¼Œéœ€è¦è¿›è¡Œå®æ—¶æ¨èï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä»neo4jå›¾è°±æ•°æ®ä¸­æ‰¾åˆ°æŸä¸ªç”¨æˆ·çš„æ¨èç»“æœæ¨èå‡ºå»ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠäº§å“ä¸­å†å²çš„æ‰€æœ‰ç”¨æˆ·ã€å¸–å­ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»è¿›è¡Œå¯¼å…¥åˆ°neo4jä¸­ã€‚

* ç”¨æˆ·ã€å¸–å­çš„æ ‡ç­¾å½“åšneo4jå›¾æ•°æ®åº“ä¸­çš„èŠ‚ç‚¹æ ‡ç­¾ä»¥åŠå±æ€§
  * SuperfansUser
  * SuperfansPost
* ç”¨æˆ·ä¸å¸–å­çš„è¡Œä¸ºå…³ç³»åç§°å½“åšneo4jå›¾æ•°æ®åº“çš„è¾¹çš„å…³ç³»ç±»å‹ã€å±æ€§

### 2.2.1 ä»€ä¹ˆæ˜¯åŒç”»åƒ

- åŒç”»åƒæ˜¯æŒ‡: ç”¨æˆ·ç”»åƒå’Œå¸–å­ç”»åƒ
-  è®¾è®¡æ ‡ç­¾ä½“ç³»:
  - æ ‡ç­¾åˆ†ç±»ï¼š
    - é™æ€æ ‡ç­¾: ç”¨æˆ·/å¸–å­ä¸­ä¸èƒ½/å¾ˆå°‘å˜åŠ¨çš„å±æ€§ï¼Œå¦‚ç”¨æˆ·æ˜µç§°ï¼Œå¸–å­å‘å¸ƒæ—¶é—´
      - åŒ…æ‹¬ç”¨æˆ·æ˜µç§°ï¼Œå¹´é¾„ï¼Œæ˜Ÿåº§ï¼Œæ‰€æŒè®¾å¤‡ç±»å‹ï¼Œä»·æ ¼ï¼Œä¸ªæ€§ç­¾åç­‰ã€‚
    - åŠ¨æ€æ ‡ç­¾: ç”¨æˆ·/å¸–å­å¯èƒ½ä¸€ç›´å¤„åœ¨å˜åŠ¨çŠ¶æ€çš„å±æ€§ï¼Œå¦‚ç”¨æˆ·çš„ä¸»åŠ¨ç‚¹èµæ¬¡æ•°ï¼Œå¸–å­è¢«è¯„è®ºçš„æ¬¡æ•°
      - æœ€è¿‘æµè§ˆçš„æ˜æ˜Ÿï¼Œæœ€è¿‘ç™»é™†æ—¶é—´ï¼Œä¸»åŠ¨ç‚¹èµæ¬¡æ•°ï¼Œä¸»åŠ¨è¯„è®ºæ¬¡æ•°ï¼Œä¸»åŠ¨è½¬å‘æ¬¡æ•°ç­‰ã€‚
    - ä¸šåŠ¡å…³æ³¨ç±»æ ‡ç­¾ï¼šä¸šåŠ¡éƒ¨é—¨å¯èƒ½å¯¹æŸäº›æ ‡ç­¾ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œå¦‚ç”¨æˆ·çš„ä»˜è´¹æƒ…å†µ
      - æ¯”å¦‚ç”¨æˆ·ä»˜è´¹æƒ…å†µ, è´­ä¹°å’Œæ¶ˆè´¹æƒ…å†µã€‚
    - æŒ–æ˜ç±»æ ‡ç­¾ï¼šæœ‰äº›æ ‡ç­¾ä¸èƒ½ç›´æ¥é€šè¿‡æ‰“ç‚¹ç›´æ¥è·å¾—ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨ä¸€äº›æ•°æ®æŒ–æ˜æ–¹æ³•ï¼Œæ¯”å¦‚ä»ä¸ªäººè¯„è®ºå†…å®¹ä¸­è¯†åˆ«ä»–çš„å…´è¶£çˆ±å¥½
      - å°†ç”¨æˆ·çš„ä¸ªæ€§ç­¾åå’Œå†å²è¯„è®ºå†…å®¹ä½¿ç”¨æ ‡ç­¾åŒ–ç³»ç»Ÿè¿›è¡Œå…´è¶£å€¾å‘é¢„æµ‹ï¼Œè·å¾—å¯¹åº”æ ‡ç­¾ã€‚
  - æ ‡ç­¾æ›´æ–°å‘¨æœŸï¼šéšAPPç‰ˆæœ¬æ›´æ–°è¿­ä»£.
  - ä½ é€‰æ‹©çš„æ ‡ç­¾è¦å°½å¯èƒ½çš„å’Œæ¨èç›®æ ‡æœ‰å…³ï¼ŒåŒæ—¶ä¸æ•°æ®æ‰“ç‚¹å’Œé‡‡é›†å·¥ç¨‹å¸ˆè®¨è®ºæ ‡ç­¾è®¾è®¡çš„åˆç†æ€§.

### 2.2.2 æ³›å¨±ä¹æ¨èåŒç”»åƒè®¾è®¡

#### 2.2.2.1 ç”»åƒæ¥æºä¸å­˜å‚¨è®¾è®¡

* ç”¨æˆ·ä¸å¸–å­æ ‡ç­¾æ•°æ®çš„ç¡®å®š

ä¸ä¸šåŠ¡æ•°æ®éƒ¨é—¨è¿›è¡Œæ²Ÿé€šï¼Œç¡®å®šæ‰€éœ€è¦çš„ç”¨æˆ·ä¸å¸–å­æ ‡ç­¾æ•°æ®ï¼Œç„¶åè¦æ±‚ä»–ä»¬å¯¼å‡ºåˆ°CSVæ–‡ä»¶åˆ°å›ºå®šç›®å½•ï¼Œæˆ‘ä»¬å°†å…¶æ”¾å…¥åˆ°neo4jå®‰è£…çš„importç›®å½•ã€‚æˆ‘ä»¬æ”¾å…¥ /home/neo4j/import/ï¼Œåœ¨è™šæ‹Ÿæœºå½“ä¸­å·²ç»åŒ…å«äº†æ‰€æœ‰çš„æ•°æ®å¯¼å…¥åˆ°äº†neo4jä¸­ã€‚

![](../images/æ ‡ç­¾æ•°æ®æ¥æºä¸å­˜å‚¨.png)

#### 2.2.2.1 ç”¨æˆ·æ ‡ç­¾

* ç”¨æˆ·ç”»åƒï¼šç”¨æˆ·IDï¼Œè®¾å¤‡ä¿¡æ¯ï¼Œ**è¯„è®ºæ•°é‡**ï¼Œä½¿ç”¨ç³»ç»Ÿï¼Œ**å…³æ³¨æ•°é‡**ï¼Œæœ€åç™»å½•æ—¶é—´ï¼Œ**å–œæ¬¢å¸–å­æ•°é‡**ï¼ŒåŒ¿åï¼Œ**å‘è¡¨å¸–å­æ•°é‡**ï¼Œ**å›å¤å¸–å­æ•°é‡**ï¼Œuid

![](../images/ç”¨æˆ·ç”»åƒèŠ‚ç‚¹å±æ€§.png)

#### 2.2.2.2 å¸–å­æ ‡ç­¾

- å¸–å­é™æ€æ ‡ç­¾ï¼šå¸–å­çš„é™æ€æ ‡ç­¾ä½“ç³»ï¼šåŒ…æ‹¬å¸–å­å…³è”æ˜æ˜Ÿï¼Œå‘å¸ƒæ—¶é—´ï¼Œtitleï¼Œå¸–å­æ¥æºï¼Œå‘å¸ƒçš„æ˜æ˜Ÿç­‰ã€‚

- å¸–å­åŠ¨æ€æ ‡ç­¾ï¼šç”¨æˆ·çš„åŠ¨æ€æ ‡ç­¾ä½“ç³»: æœ€è¿‘è¢«æµè§ˆçš„æ¬¡æ•°ï¼Œè¢«ç‚¹èµæ¬¡æ•°ï¼Œè¢«è¯„è®ºæ¬¡æ•°ï¼Œè¢«è½¬å‘æ¬¡æ•°ç­‰ã€‚

- æŒ–æ˜ç±»æ ‡ç­¾ï¼šå°†å¸–å­titleå’Œè¯„è®ºå†…å®¹ä½¿ç”¨æ ‡ç­¾åŒ–ç³»ç»Ÿè¿›è¡Œå…´è¶£å€¾å‘é¢„æµ‹ï¼Œè·å¾—å¯¹åº”æ ‡ç­¾ã€‚

æ¯ä¸€åˆ—åˆ†åˆ«ä»£è¡¨ï¼špid, å‘å¸ƒæ—¶é—´æˆ³, æ¶‰åŠçš„æ˜æ˜Ÿåˆ—è¡¨, è¢«èµè¯„è½¬çš„æ¬¡æ•°ï¼Œå›¾ç‰‡/è§†é¢‘åœ°å€, æºå¸¦çš„æ–‡æœ¬ä¿¡æ¯

```
614540,1514897310,[25, 32,321],37,2,0,https://p.upcdn.pengpengla.com/star/p/u/2018/1/2/59d50372-222b-4482-af34-1fbf3c1fc558.jpg,ç¾¡æ…•ä½ èº«è¾¹çš„æ‰€æœ‰äººï¼Œä¹Ÿæƒ³å’Œä½ ä¸€èµ·ç”Ÿæ´»ï¼Œå«‰å¦’ä½¿æˆ‘æ›´åŠ å–œæ¬¢ä½ ï¼Œ2018æ„¿ä½ æ‹¥æœ‰å¥½è¿æ°”â¤
614544,1514901161,[423, 1,2],2,0,0,https://p.upcdn.pengpengla.com/star/p/u/2018/1/2/84dbb033-b240-45c9-81b6-9ef6b06c8d29.jpg,ç¬¬ä¸€å¤©ï¼å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œæ‰çŸ¥é“æœ‰è¿™ä¸ªåŠŸèƒ½å”‰
614552,1514906051,[234],6,0,1,https://p.upcdn.pengpengla.com/star/p/u/2018/1/2/de4082ab-9b82-403e-a60d-5b31a96b5458.jpg,é˜³å…‰å°‘å¹´ğŸ’ï¸å“ˆå“ˆå“ˆ
614566,1514984023,[3,2,1],3,0,0,https://p.upcdn.pengpengla.com/star/p/u/2018/1/3/e0b07d44-0b66-4cec-ba90-383d7f59197f.png,ä¸€ç›´å–œæ¬¢ä½ â¤â¤â¤
614570,1514995252,[234,3,4],0,0,0,https://p.upcdn.pengpengla.com/star/p/u/2018/1/4/1cc2e223-504f-4a11-bfcc-801a3e22d1df.jpg,å°±æ˜¯çˆ±ä½ ä¹ˆä¹ˆå“’
```

![](../images/å¸–å­èŠ‚ç‚¹ç”»åƒæ ‡ç­¾.png)

#### 2.2.2.3 æ ‡ç­¾ä½“ç³»çš„è®¡ç®—ä¸å­˜å‚¨

æ ‡ç­¾ä½“ç³»æŒ‰ç…§å®šä¹‰è¿›è¡Œè®¡ç®—ï¼Œå¹¶æ¯å‘¨è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼Œå­˜å‚¨æ–¹å¼é‡‡ç”¨åŒå±‚å­˜å‚¨æ¨¡å¼ï¼ŒHbaseå°†ä¼šè®°å½•æ‰€æœ‰å†å²æ ‡ç­¾æ•°æ®ï¼Œä»¥ä¾¿è®¡ç®—äº§ç”ŸåŸºäºæ­¤çš„æ–°æ ‡ç­¾ã€‚**Neo4jä¼šå­˜å‚¨æ‰€æœ‰æœ€æ–°çš„æ ‡ç­¾æ•°æ®ï¼Œå¹¶è´Ÿè´£å°†åŒæ ‡ç­¾ä½“ç³»èåˆã€‚**

å¯¹æ•°æ®å¯è§†åŒ–å’Œæ¨èçš„å¯è§£é‡Šæ€§äº§ç”Ÿé‡è¦å½±å“

- åŒå±‚å­˜å‚¨
  - æ•°æ®åˆé›†å­˜äºèƒ½æ‰©å±•å­˜å‚¨çš„åˆ†å¸ƒå¼æ•°æ®ä¹‹ä¸­, å¦‚ï¼šHbase, æœ€æ–°/ä½¿ç”¨æ•°æ®å­˜åœ¨åˆ©äºå¿«é€ŸæŸ¥è¯¢çš„æ•°æ®åº“ä¹‹ä¸­ï¼Œå¦‚ï¼šneo4j
- ç”¨æˆ·ã€å¸–å­æ ‡ç­¾å½“åšèŠ‚ç‚¹ä»¥åŠæ ‡ç­¾
- ç”¨æˆ·ä¸å¸–å­çš„å…³ç³»ï¼Œå…³æ³¨ï¼Œè¯„è®ºç­‰å½“åšå›¾ä¸­çš„å…³ç³»è¾¹

#### ç”¨æˆ·ä¸å¸–å­å±æ€§æ•°æ®å¯¼å…¥neo4j

* ç”¨æˆ·ã€å¸–å­èŠ‚ç‚¹ä»¥åŠæ ‡ç­¾çš„å¯¼å…¥ï¼š

ä½¿ç”¨LOAD CSV FROMå¯¼å…¥CSVæ–‡ä»¶æ•°æ®ï¼Œ

```
## User Node Import
LOAD CSV FROM
'file:///dm_user_profile_3000.csv' AS line
CREATE (:SuperfansUser {uid: toInteger(line[0]), nickname: line[1], device_model:line[2], device_system:line[3], follow_stars_list:split(line[4], ","), publish_posts_num: toInteger(line[5]), like_posts_num: toInteger(line[6]), comment_posts_num: toInteger(line[7]),forward_posts_num: toInteger(line[8]), report_posts_num: toInteger(line[9]), last_signin_time: toInteger(line[10])})

# Post Node Import
LOAD CSV FROM
'file:///dm_dynamic_profile_10_3000.csv' AS line
CREATE (:SuperfansPost {pid: toInteger(line[0]), publish_time: toInteger(line[1]), related_stars_list:split(line[2],","), liked_num:toInteger(line[3]), commented_num:toInteger(line[4]), forwarded_num: toInteger(line[5]), iv_url: line[6], text_info: line[7]})
```

#### 2.2.2.4 ç”¨æˆ·ä¸å¸–å­å…³ç³»æ‰¹é‡å¯¼å…¥å®ç°

![](../images/å…³ç³»å­˜å‚¨.png)

æ¯”å¦‚å…³ç³»csvæ–‡ä»¶:ä»¥ç‚¹èµcsvæ–‡ä»¶ä¸ºä¾‹ï¼š

```python
123123,1233
53543,3411
6456456,32513
23123,623421
```

å†å²ç”¨æˆ·ä¸å¸–å­çš„å…³ç³»ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ‰¹é‡å¯¼å…¥åˆ°neo4jï¼Œæ‰€ä»¥å»ºç«‹ä¸€ä¸ªå¯¼å…¥çš„Pythonè„šæœ¬import_relation.py

```python
from neo4j.v1 import GraphDatabase
NEO4J_CONFIG = dict({	
    "uri": "bolt://192.168.19.137:7687",
    "auth": ("neo4j", "itcast"),
    "encrypted": False
})
driver = GraphDatabase.driver(**NEO4J_CONFIG)

# å†™å…¥å…³ç³»åˆ°æ•°æ®åº“
def wirte_relationship(relationship_csv_path, relationship_type):
    # è¯»å–CSVæ–‡ä»¶
    uid_and_pid = pd.read_csv(relationship_csv_path, header=None).values
    with driver.session() as session:
        def wr(uid, pid):
            # ç”¨æˆ·IDè¯»å–
            record = session.run("MATCH(a:SuperfansUser{uid:%s}) return a.uid" %uid)
            result = list(map(lambda x: x[0], record))
            if not result:
                return
            # å¸–å­IDè¯»å–
            record = session.run("MATCH(a:SuperfansPost{pid:%s}) return a.pid" %pid)
            result = list(map(lambda x: x[0], record))
            if not result:
                return
            # å…³ç³»å†™å…¥
            session.run("MATCH(a:SuperfansUser{uid:%s}) MATCH(b:SuperfansPost{pid:%s}) with a, b MERGE(a)-[r:%s]-(b)" %(uid, pid, relationship_type))
        # è¾“å…¥ç”¨æˆ·IDå’Œå¸–å­IDè¿›è¡Œå…³ç³»å†™å…¥
        list(map(lambda x: wr(x[0], x[1]), uid_and_pid))
```

è¿›è¡ŒCSVæ–‡ä»¶åŠ è½½

```python
if __name__ == "__main__":
    """
    relationship_type = "publish"
    relationship_csv_path = "/var/lib/neo4j/import/recommend_post_operation_3000.csv"
    wirte_relationship(relationship_csv_path, relationship_type)
    """
    """ 
    relationship_type = "like"
    relationship_csv_path = "/var/lib/neo4j/import/recommend_like_operation_3000.csv"
    wirte_relationship(relationship_csv_path, relationship_type)
    """
    """
    relationship_type = "comment"
    relationship_csv_path = "/var/lib/neo4j/import/recommend_comment_operation_3000.csv"
    wirte_relationship(relationship_csv_path, relationship_type)
    """
    """
    relationship_type = "share"
    relationship_csv_path = "/var/lib/neo4j/import/recommend_share_operation_3000.csv"
    wirte_relationship(relationship_csv_path, relationship_type)
    """
    relationship_type = "report"
    relationship_csv_path = "/var/lib/neo4j/import/recommend_report_operation_3000.csv"
    wirte_relationship(relationship_csv_path, relationship_type)
```

### 3.2.3 å°ç»“

* ç”¨æˆ·ã€å¸–å­çš„ç”»åƒå†…å®¹ã€å­˜å‚¨è®¾è®¡
* å®Œæˆç”¨æˆ·ã€å¸–å­çš„æ ‡ç­¾å†å²æ•°æ®å¯¼å…¥



